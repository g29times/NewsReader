<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - NewsReader</title>
	<!-- <link rel="icon" href="https://drive.google.com/file/d/1Vn_00nTR1ID3LK9hvX7zgi6WRND_3SUA/view?usp=drive_link" sizes="256x256" type="image/svg+xml"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="chat-container">
        <!-- 左侧文章面板 -->
        <div class="articles-panel collapsed">
            <div class="panel-header">
                <div class="toolbar">
                    <input type="text" placeholder="搜索文章..." class="form-control">
                </div>
                <button class="toggle-panel-btn" onclick="toggleArticlesPanel()">➡</button>
            </div>
            <div class="panel-content">
                <div id="articleList" class="article-list">
                    <div class="article-list-header">
                        <input type="checkbox" id="selectAll" class="article-checkbox">
                        <label for="selectAll">全选<span id="articleCount"></span></label>
                    </div>
                    <div class="article-items">
                        {% for article in articles %}
                        <div class="article-item">
                            <input type="checkbox" class="article-checkbox" data-article-id="{{ article.id }}">
                            <div class="article-title" title="点击查看详情" onclick="fetchArticleDetails('{{ article.id }}')">{{ article.title }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="expandedArticle" style="display: none;">
                    <div class="article-header">
                        <button class="collapse-btn btn btn-sm btn-outline-secondary" onclick="collapseArticle()">回到列表</button>
                        <!-- <button class="btn btn-sm btn-outline-secondary" onclick="quoteContent('full')">引用全文</button> -->
                    </div>
                    <h2 class="article-title" id="expandedArticleTitle"></h2>
                    <div class="source-guide-container">
                        <div class="source-guide-header" onclick="toggleSourceGuide(this)">
                            <h5 class="source-guide-title btn btn-outline-primary">学习指南</h5>
                            <span class="arrow">▶</span>
                        </div>
                        <div class="source-guide-content">
                            <div class="source">
                                <h4>来源</h4>
                                <div id="expandedArticleSource"></div>
                            </div>
                            <div class="key-topics">
                                <h4>关键主题</h4>
                                <div id="expandedArticleTopics"></div>
                            </div>
                            <div class="tags">
                                <h4>标签</h4>
                                <ul id="expandedArticleTags"></ul>
                            </div>
                            <div class="summary">
                                <h4>摘要</h4>
                                <button class="btn btn-sm btn-outline-secondary" onclick="quoteContent('summary')">引用摘要</button>
                                <div id="expandedArticleSummary"></div>
                            </div>
                        </div>
                    </div>
                    <div class="article-body" id="expandedArticleContent"></div>
                </div>
            </div>
        </div>

        <!-- 中间聊天区域 -->
        <div class="chat-area">
            <div class="chat-toolbar">
                <button class="btn btn-outline-secondary" onclick="createUpdateNote()">记录对话</button>
                <button class="btn btn-outline-secondary" onclick="createUpdateChat(true)">新建对话</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 聊天消息将在这里动态添加 -->
            </div>
            <div class="chat-input-area">
                <textarea id="messageInput" class="chat-input" placeholder="输入消息..."></textarea>
                <button class="btn btn-primary" onclick="sendChatMessage()">对话</button>
                <button class="btn btn-outline-secondary" onclick="uploadFile()">文件</button>
                <button class="btn btn-outline-secondary" onclick="startRecording()">语音</button>
                <div class="choice-radio">
                    <input type="radio" id="choice1" name="choices" value="OPENAI_MODEL" checked>
                    <label for="choice1">GPT-4o</label>
                    <input type="radio" id="choice2" name="choices" value="GEMINI_MODEL">
                    <label for="choice2">GEMINI2</label>
                </div>
            </div>
        </div>

        <!-- 右侧笔记区域 -->
        <div class="right-panel">
            <div class="panel-header">
                <button class="toggle-panel-btn" onclick="toggleRightPanel()">➡</button>
                <div class="toolbar">
                    <input type="text" placeholder="搜索对话..." class="form-control">
                </div>
            </div>
            <div class="panel-content">
                <div class="chat-list" id="chatList">
                    <!-- 对话列表将在这里动态添加 -->
                </div>
                <div class="note-list">
                    <div class="note-item">
                        <div class="toolbar">
                            <input type="text" placeholder="搜索笔记..." class="form-control">
                        </div>
                        <button class="btn btn-outline-secondary" onclick="createNewNote()">新建笔记</button>
                        <div class="note-title">笔记标题</div>
                        <div class="note-content">笔记内容</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮动引用按钮 -->
    <div id="floatQuoteBtn" class="float-quote-btn">
        <button class="btn btn-sm btn-outline-secondary" onclick="quoteSelection()">
            <i class="fas fa-quote-right"></i> 继续引用
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="saveSelectionAsNote()">
            <i class="fas fa-sticky-note"></i> 记笔记
        </button>
    </div>

    <script>
        // -------------------------------- 通用方法 --------------------------------
        // 通用的防抖函数
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            }
        }

        // 文章搜索的防抖处理
        const debouncedSearchArticles = debounce(async (query) => {
            try {
                const response = await fetch(`/chat/api/articles/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('搜索失败');
                const result = await response.json();
                updateArticlesList(result.data.articles);
            } catch (error) {
                showToast('搜索失败: ' + error.message, 'error');
            }
        }, 300);

        // 对话搜索的防抖处理
        const debouncedSearchChats = debounce(async (query) => {
            try {
                const response = await fetch(`/chat/api/conversations/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('搜索失败');
                const chats = await response.json();
                updateChatList(chats);
                // addChatListeners();
            } catch (error) {
                showToast('搜索失败: ' + error.message, 'error');
            }
        }, 300);

        // 监听文章搜索输入
        document.querySelector('.articles-panel .toolbar input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                debouncedSearchArticles(query);
            } else {
                debouncedSearchArticles(''); // 当搜索框为空时，加载所有文章
            }
        });

        // 监听对话搜索输入
        document.querySelector('.right-panel .toolbar input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                debouncedSearchChats(query);
            } else {
                debouncedSearchChats(''); // 当搜索框为空时，加载所有对话
            }
        });

        // 引用消息
        function quoteMessage(button) {
            const content = button.closest('.message').querySelector('.content').innerText;
            const messageInput = document.getElementById('messageInput');
            messageInput.value = `${content}\n---------------\n`;
            messageInput.focus();
        }

        // 引用文章内容
        function quoteContent(type) {
            const messageInput = document.getElementById('messageInput');
            if (type === 'full') {
                // const title = document.getElementById('expandedArticleTitle').innerText;
                const source = document.getElementById('expandedArticleContent').innerText;
                // messageInput.value = `${title}\n${source}\n---------------\n`;
                messageInput.value = `${source}\n---------------\n`;
            } else if (type === 'summary') {
                const summary = document.getElementById('expandedArticleSummary').innerText;
                messageInput.value = `${summary}\n---------------\n`;
            }
            messageInput.focus();
        }
        
        // 引用选中的文本
        function quoteSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (text) {
                const messageInput = document.getElementById('messageInput');
                // += 允许多段引用
                messageInput.value += `${text}\n---------------\n`;
                messageInput.focus();
                // 隐藏浮动按钮
                document.getElementById('floatQuoteBtn').style.display = 'none';
            }
        }
    
        // 处理选中文本的引用功能
        document.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            const floatBtn = document.getElementById('floatQuoteBtn');
            
            if (selection.toString().trim().length > 0) {
                // 获取选中文本的位置
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // 设置浮动按钮位置
                floatBtn.style.left = `${rect.left + window.scrollX}px`;
                floatBtn.style.top = `${rect.bottom + window.scrollY + 5}px`;
                floatBtn.style.display = 'block';
            } else {
                floatBtn.style.display = 'none';
            }
        });

        // 点击页面其他地方时隐藏浮动按钮
        document.addEventListener('mousedown', function(e) {
            if (!e.target.closest('#floatQuoteBtn')) {
                document.getElementById('floatQuoteBtn').style.display = 'none';
            }
        });

        // Toast 提示功能 重点
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('#toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 文件上传功能
        function uploadFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.txt,.pdf,.doc,.xlsx,.ppt,.jpg,.jpeg,.png,.gif';
            fileInput.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const question = document.getElementById('messageInput').value;
                if (!question.trim()) {
                    showToast('请输入要询问的问题', 'warning');
                    return;
                }
                // 传入文件并对话
                await sendChatMessage(file);
            }
            fileInput.click();
        }

        // 录音功能（待实现）
        function startRecording() {
            showToast('录音功能即将推出', 'info');
        }

        // -------------------------------- 文章管理 --------------------------------
        let isExpanded = false;
        let currentArticle = null;

        // 文章区 面板展开/收起 默认收起
        function toggleArticlesPanel() {
            const panel = document.querySelector('.articles-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            if (panel.classList.contains('expanded')) {
                // 如果是展开状态，先恢复到默认宽度
                panel.classList.remove('expanded');
                button.textContent = '⬅';
                panel.classList.add('collapsed');
            } else if (panel.classList.contains('collapsed')) {
                // 如果是收起状态，恢复到默认宽度
                panel.classList.remove('collapsed');
                button.textContent = '➡';
                panel.classList.add('expanded');
            } else {
                // 如果是默认状态，收起面板
                panel.classList.add('collapsed');
                button.textContent = '➡';
            }
        }

        // 笔记区 面板展开/收起 默认展开
        function toggleRightPanel() {
            const panel = document.querySelector('.right-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                button.textContent = '➡';
            } else {
                panel.classList.add('collapsed');
                button.textContent = '⬅';
            }
        }

        // 展开新文章详情
        function expandArticlesPanel() {
            const panel = document.querySelector('.articles-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            // 移除收起状态（如果有的话）
            panel.classList.remove('collapsed');
            // 添加展开状态
            panel.classList.add('expanded');
            button.textContent = '⬅';
        }

        // 点击同一篇文章详情 展开/收起
        function toggleArticleExpand() {
            const panel = document.querySelector('.articles-panel');
            if (panel.classList.contains('expanded')) {
                panel.classList.remove('expanded');
                showArticleList();
            } else {
                panel.classList.add('expanded');
                hideArticleList();
            }
        }

        // 文章概要 展开/收起
        function toggleSourceGuide(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('expanded');
            
            // 更新箭头方向
            const arrow = element.querySelector('.arrow');
            if (content.classList.contains('expanded')) {
                arrow.textContent = '▼';
            } else {
                arrow.textContent = '▶';
            }
        }

        // 从文章详情返回文章列表
        function collapseArticle() {
            const panel = document.querySelector('.articles-panel');
            const articleList = document.getElementById('articleList');
            const expandedArticle = document.getElementById('expandedArticle');
            
            // 移除展开状态
            panel.classList.remove('expanded');
            // 显示文章列表，隐藏文章详情
            articleList.style.display = 'block';
            expandedArticle.style.display = 'none';
        }

        // 显示文章列表 重点
        function showArticleList() {
            document.querySelector('.article-list').style.display = 'block';
            document.getElementById('expandedArticle').style.display = 'none';
        }

        // 隐藏文章列表
        function hideArticleList() {
            document.querySelector('.article-list').style.display = 'none';
            document.getElementById('expandedArticle').style.display = 'block';
        }

        // 上传文件后 显示文章
        function showArticleInfo(article) {
            // 在文章面板中显示新添加的文章
            const articlePanel = document.querySelector('.articles-panel');
            if (articlePanel && !articlePanel.classList.contains('collapsed')) {
                // 如果文章面板打开，刷新文章列表
                showArticleList();
            }
        }

        // 显示文章内容
        function displayArticleContent(article) {
            const articleList = document.getElementById('articleList');

            const expandedArticle = document.getElementById('expandedArticle');
            const title = document.getElementById('expandedArticleTitle');
            const content = document.getElementById('expandedArticleContent');
            const summary = document.getElementById('expandedArticleSummary');
            const topics = document.getElementById('expandedArticleTopics');
            const tags = document.getElementById('expandedArticleTags');
            const source = document.getElementById('expandedArticleSource');
            
            // 隐藏文章列表
            articleList.style.display = 'none';
            // 显示文章详情
            expandedArticle.style.display = 'block';
            // 设置文章内容
            title.textContent = article.title || '';
            // 使用showdown转换Markdown为HTML
            const converter = new showdown.Converter();
            try {
                content.innerHTML = article.content ? converter.makeHtml(article.content) : '';
                summary.innerHTML = article.summary ? converter.makeHtml(article.summary) : '';
                const topicsHtml = article.topics ? converter.makeHtml(article.topics.map(topic => `- ${topic}`).join('\n')) : '';
                topics.innerHTML = topicsHtml;
            } catch (error) {
                content.innerHTML = article.content || '';
                summary.innerHTML = article.summary || '';
                topics.innerHTML = article.topics ? article.topics.map(topic => `- ${topic}`).join('\n') : '';
            }
            tags.innerHTML = article.tags || '';
            source.innerHTML = article.source ? `- ${article.source}` : '';
        }

        // 获取文章详情 重点
        async function fetchArticleDetails(articleId) {
            try {
                const response = await fetch(`/chat/api/articles/${articleId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch article details');
                }
                const article = await response.json();
                
                // 如果点击的是同一篇文章，切换展开状态
                if (currentArticle === articleId) {
                    toggleArticleExpand();
                } else {
                    // 如果是新文章，展示内容并展开面板
                    currentArticle = articleId;
                    displayArticleContent(article.data.article);
                    expandArticlesPanel();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showToast('查看文章失败', 'error');
            }
        }

        // 搜索后 更新文章列表
        function updateArticlesList(articles) {
            const articleList = document.querySelector('.article-items');
            articleList.innerHTML = articles.map(article => `
                <div class="article-item">
                    <input type="checkbox" class="article-checkbox" data-article-id="${article.id}">
                    <div class="article-title" onclick="fetchArticleDetails(${article.id})">${article.title}</div>
                </div>
            `).join('');
            document.getElementById('articleCount').textContent = articles.length ? ` ${articles.length}篇` : '';
            // 重新绑定复选框事件
            document.querySelectorAll('.article-items .article-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    // 检查是否所有复选框都被选中
                    const allCheckboxes = document.querySelectorAll('.article-items .article-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    document.getElementById('selectAll').checked = allChecked;
                });
            });
        }

        // 文章列表全选功能
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.article-items .article-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // 获取选中的文章ID列表
        function getSelectedArticles() {
            const checkboxes = document.querySelectorAll('.article-items .article-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.articleId);
        }

        // 更新文章选择状态
        document.querySelectorAll('.article-items .article-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                // 检查是否所有复选框都被选中
                const allCheckboxes = document.querySelectorAll('.article-items .article-checkbox');
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                document.getElementById('selectAll').checked = allChecked;
            });
        });

        // -------------------------------- 聊天消息管理 --------------------------------

        // 添加用户消息到聊天区域
        function addUserMessageToChat(content) {
            const messageIndex = document.querySelectorAll('.message').length;
            addMessageToChat('user', content, messageIndex);
        }

        // 添加助手消息到聊天区域
        function addAssistantMessageToChat(content) {
            // 移除所有"思考中..."的临时消息
            const tempMessages = document.querySelectorAll('.message.assistant.thinking');
            tempMessages.forEach(msg => msg.remove());
            
            // 添加实际的助手消息
            const messageIndex = document.querySelectorAll('.message').length;
            addMessageToChat('assistant', content, messageIndex);
        }

        // 添加思考中的临时消息
        function addThinkingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>GEMI:</strong>
                    <p>思考中...</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 对话聊天 重点 每次聊天生成对话或更新对话
        async function sendChatMessage(file = null) {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('.btn-primary');
            const message = messageInput.value.trim();
            if (message === '') {
                showToast('请输入消息内容', 'error');
                return;
            }
            // 禁用发送按钮
            sendButton.disabled = true;
            try {
                // 获取选中的文章ID
                const selectedArticles = Array.from(document.querySelectorAll('.article-items .article-checkbox:checked'))
                    .map(checkbox => checkbox.dataset.articleId);
                if (selectedArticles.length > 10) {
                    showToast('最多选择10篇文章', 'error');
                    return;
                }
                // 立即添加用户消息
                if (file) {
                    addUserMessageToChat(`文件：${file.name}\n问题：${message}`);
                } else {
                    addUserMessageToChat(message);
                }
                // 添加思考中提示
                addThinkingMessage();
                // 清空输入框
                messageInput.value = '';
                
                // 生成或更新对话 重点
                conv_id = await createUpdateChat();
                console.log('Conversation ID:', conv_id);
                // 调用chat服务
                let result;
                const modelChoice = document.querySelector('.choice-radio input[name="choices"]:checked').value;
                if (file) { // 如果有文件，使用文件聊天接口
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('question', message);
                    formData.append('conversation_id', conv_id);
                    const response = await fetch('/chat/api/chat/with_file', {
                        method: 'POST',
                        body: formData
                    });
                    result = await response.json();
                }
                else if (selectedArticles.length > 0) { // 普通聊天接口，如果选择了文章，发送文章id
                    result = await call_chat(conv_id, message, modelChoice, selectedArticles);
                }
                else { // 普通聊天接口
                    result = await call_chat(conv_id, message, modelChoice);
                }
                if (result.success) {
                    if (result.data && result.data.response) {
                        addAssistantMessageToChat(result.data.response);
                    }
                    showToast('消息处理成功', 'success');
                } else {
                    showToast(result.message || '消息处理失败', 'error');
                }
            } catch (error) {
                console.error('Chat error:', error);
                showToast('消息发送失败', 'error');
            } finally {
                // 恢复发送按钮
                sendButton.disabled = false;
            }
        }

        // sendChatMessage 调用后端chat服务
        async function call_chat(conv_id, message, modelChoice, selectedArticles = []) {
            try {
                if (conv_id == undefined || conv_id == null || conv_id == '') {
                   throw new Error('请稍后再试');
                }
                // 调用chat服务
                const response = await fetch('/chat/api/chat', {
                    method: 'POST',
                    headers: {
                            'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conv_id,
                        message: message,
                        model: modelChoice, // "GEMINI_MODEL"
                        article_ids: selectedArticles,
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`服务响应：(${error.message || '未知错误'})`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Chat error:', error);
                throw error;  // 继续抛出错误，让上层函数处理
            }
        }

        // 添加消息到聊天区域
        function addMessageToChat(role, content, messageIndex = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            if (messageIndex !== null) {
                messageDiv.dataset.messageIndex = messageIndex;
            }
            
            // 处理可能的HTML内容
            let htmlContent = content;
            if (typeof content === 'string') {
                if (role === 'assistant') {
                    // 对助手的回答使用markdown转换
                    const converter = new showdown.Converter();
                    try {
                        htmlContent = converter.makeHtml(content); 
                    } catch (error) {
                        htmlContent = content;
                    }
                } else {
                    // 用户消息只转换换行符
                    htmlContent = content.replace(/\n/g, '<br>');
                }
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>${role === 'user' ? '你' : 'GEMI'}:</strong>
                    <div class="content">${htmlContent}</div>
                </div>
            `;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            // 保存笔记按钮
            const saveNoteButton = document.createElement('button');
            saveNoteButton.className = 'action-btn save-note';
            saveNoteButton.title = '加入笔记';
            saveNoteButton.innerHTML = '<i class="fas fa-sticky-note"></i>';
            saveNoteButton.onclick = function() { saveMessageAsNote(this); };
            actionsDiv.appendChild(saveNoteButton);

            // 编辑按钮
            const editButton = document.createElement('button');
            editButton.className = 'action-btn edit';
            editButton.title = '编辑';
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.onclick = function() { editMessage(this); };
            actionsDiv.appendChild(editButton);

            // 删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.className = 'action-btn delete';
            deleteButton.title = '删除';
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.onclick = function() { deleteMessage(this); };
            actionsDiv.appendChild(deleteButton);

            // 引用按钮
            const quoteButton = document.createElement('button');
            quoteButton.className = 'action-btn quote';
            quoteButton.title = '引用';
            quoteButton.innerHTML = '<i class="fas fa-quote-right"></i>';
            quoteButton.onclick = function() { quoteMessage(this); };
            actionsDiv.appendChild(quoteButton);

            // 复制按钮
            const copyButton = document.createElement('button');
            copyButton.className = 'action-btn copy';
            copyButton.title = '复制';
            copyButton.innerHTML = '<i class="fas fa-copy"></i>';
            copyButton.onclick = function() { copyMessage(this); };
            actionsDiv.appendChild(copyButton);

            messageDiv.appendChild(actionsDiv);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 复制消息内容
        function copyMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content');
            const content = contentDiv ? contentDiv.textContent : '';
            
            // 创建一个临时文本区域
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            try {
                // 选择文本并尝试复制
                textarea.select();
                const success = document.execCommand('copy');
                if (success) {
                    showToast('已复制到剪贴板', 'success');
                } else {
                    // 如果execCommand失败，尝试使用Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(content)
                            .then(() => showToast('已复制到剪贴板', 'success'))
                            .catch(err => {
                                console.error('复制失败:', err);
                                showToast('复制失败，请重试', 'error');
                            });
                    } else {
                        throw new Error('不支持复制功能');
                    }
                }
            } catch (err) {
                console.error('复制失败:', err);
                showToast('复制失败，请重试', 'error');
            } finally {
                // 清理临时文本区域
                document.body.removeChild(textarea);
            }
        }

        // 删除消息 对话中的一段消息 对话聊天
        async function deleteMessage(button) {
            event.stopPropagation();
            const messageDiv = button.closest('.message');
            const messageIndex = messageDiv.getAttribute('data-message-index');
            const conversationId = currentConversationId;
            if (!messageIndex || !conversationId) {
                console.error('无法获取消息索引');
                showToast('无法获取消息索引', 'error');
                return;
            }
            try { // delete_message
                const response = await fetch('/chat/api/msg/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        message_index: messageIndex
                    })
                });
                const result = await response.json();
                if (result.success) {
                    messageDiv.remove();
                    // 重新编制索引
                    const messages = document.querySelectorAll('.chat-messages .message');
                    messages.forEach((msg, idx) => {
                        msg.setAttribute('data-message-index', idx);
                    });
                    // 如果删除的是最后一条助手消息，启用发送按钮
                    const lastMessage = document.querySelector('.chat-messages .message:last-child');
                    if (!lastMessage || lastMessage.classList.contains('user')) {
                        document.querySelector('.chat-input-area button.btn-primary').disabled = false;
                    }
                    showToast('消息已删除', 'success');
                } else {
                    showToast(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除消息失败:', error);
                showToast('删除失败，请稍后重试', 'error');
            }
        }

        // 编辑消息 对话中的一段消息 对话聊天
        function editMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content');
            const originalContent = contentDiv.innerHTML;
            const messageIndex = messageDiv.getAttribute('data-message-index');
            const conversationId = currentConversationId;
            let isSaving = false;  // 添加保存状态标记
            
            if (!messageIndex || !conversationId) {
                console.error('无法获取消息索引');
                showToast('无法获取消息索引', 'error');
                return;
            }

            // 创建编辑框
            const textarea = document.createElement('textarea');
            textarea.value = originalContent;
            textarea.style.width = '100%';
            textarea.style.minHeight = '100px';
            
            contentDiv.innerHTML = '';
            contentDiv.appendChild(textarea);
            textarea.focus();

            // 保存编辑
            async function saveEdit() {
                const newContent = textarea.value; // 修复换行符替换
                if (newContent && newContent !== originalContent) {
                    isSaving = true;  // 开始保存
                    try { // edit_chat_msg
                        const response = await fetch('/chat/api/msg/edit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                conversation_id: conversationId,
                                message_index: messageIndex,
                                content: newContent,
                                role: messageDiv.classList.contains('user') ? 'user' : 'assistant'
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            contentDiv.innerHTML = newContent; // 修复换行符替换
                            showToast('修改已保存', 'success');
                        }
                    } catch (error) {
                        console.error('保存失败:', error);
                        showToast('保存失败', 'error');
                    } finally {
                        isSaving = false;  // 结束保存
                    }
                } else {
                    contentDiv.innerHTML = originalContent;
                }
            }
            // 回车提交
            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();  // 阻止回车的默认行为
                    saveEdit();
                }
            };
            // 失去焦点时恢复原内容
            textarea.onblur = () => {
                if (!isSaving) {
                    contentDiv.innerHTML = originalContent;
                }
            };
        }

        // -------------------------------- 对话管理 --------------------------------

        // 当前选中的对话ID
        let currentConversationId = null;
        let currentChatTitle = '';
        
        // 调用后端加载对话列表 DONE
        async function loadConversationList() {
            try { // get_conversations
                const response = await fetch('/chat/api/conversations');
                const conversations = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // 清空现有列表
                conversations.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.conversationId = chat.conversation_id;
                    chatItem.innerHTML = `
                        <div class="chat-actions">
                            <button onclick="event.stopPropagation(); editChatTitle(event, '${chat.conversation_id}', '${chat.title}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteChat(event, '${chat.conversation_id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="chat-title">${chat.title || '新对话'}</div>
                    `;
                    chatItem.onclick = () => loadConversation(chat.title, chat.conversation_id);
                    chatList.appendChild(chatItem);
                });
                // addChatListeners();
            } catch (error) {
                console.error('加载对话列表失败:', error);
                showToast('加载对话列表失败', 'error');
            }
        }
        // 页面加载时获取对话列表 DONE 重点
        document.addEventListener('DOMContentLoaded', () => {
            loadConversationList();
            // 添加输入框监听
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('.chat-input-area button.btn-primary');
            // 监听输入框变化
            messageInput.addEventListener('input', function() {
                sendButton.disabled = !this.value.trim();
            });
            // 监听Ctrl+Enter发送消息
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();  // 阻止默认行为
                    if (!sendButton.disabled) {
                        sendChatMessage();
                    }
                }
            });
            // 初始状态设置
            sendButton.disabled = !messageInput.value.trim();
        });
        
        // 加载特定对话内容 DONE
        async function loadConversation(chat_title, convId) {
            try {
                currentChatTitle = chat_title
                currentConversationId = convId;  // 设置当前对话ID
                // get_conversation
                const response = await fetch(`/chat/api/conversation?conversation_id=${convId}`);
                const history = await response.json();
                // 清空现有对话
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                // 循环添加消息块
                history.forEach((msg, index) => addMessageToChat(msg.role, msg.blocks[0].text, index));
            } catch (error) {
                console.error('加载对话失败:', error);
                showToast('加载对话失败', 'error');
            }
        }

        // 创建或更新新对话 DONE 四种情况：1 空白新页面 直接对话 此时没有对话ID 2 在已有对话的情况下点击新建对话(force) 点的时候 没有新ID 但是点完后页面清屏 并且有ID 3 点击某个对话，进行对话，此时有ID
        async function createUpdateChat(force=false) {
            // 创建对话
            if (!currentConversationId || force) {
                try { // create_conversation
                    const response = await fetch('/chat/api/conversation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: '1'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        currentConversationId = result.data.conversation_id;  // 设置当前对话ID
                        if (force) { // 点击新建按钮 清空现有对话
                            const chatMessages = document.getElementById('chatMessages');
                            chatMessages.innerHTML = '';
                        }
                        // 刷新对话列表
                        loadConversationList();
                        return currentConversationId;
                    } else {
                        showToast('创建对话失败', 'error');
                    }
                } catch (error) {
                    console.error('创建对话失败:', error);
                    showToast('创建对话失败', 'error');
                    throw error;  // 继续抛出错误，中断聊天请求
                }
            }
            // 已有ID 更新对话 用于每次对话后刷新对话时间
            else {
                try { // update_conversation update_chat
                    const response = await fetch(`/chat/api/conversation/${currentConversationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: '1'
                        })
                    });
                    return currentConversationId;
                } catch (error) {
                    // 暂不处理
                    return currentConversationId;
                } finally {
                    // 刷新对话列表
                    loadConversationList();
                }
            }
        }
        
        // 编辑对话标题 DONE
        async function editChatTitle(event, convId, currentTitle) {
            event.stopPropagation(); // 阻止事件冒泡
            
            const chatItem = event.target.closest('.chat-item');
            const titleDiv = chatItem.querySelector('.chat-title');
            const originalTitle = titleDiv.textContent;
            let isSaving = false;
            
            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-title-input';
            input.value = originalTitle;
            
            titleDiv.innerHTML = '';
            titleDiv.appendChild(input);
            input.focus();

            // 保存编辑
            async function saveTitle() {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== originalTitle) {
                    isSaving = true;
                    try { // update_conversation
                        const response = await fetch(`/chat/api/conversation/${convId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                title: newTitle
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            titleDiv.innerHTML = result.data?.title || newTitle;  // 使用可选链操作符，如果result.data.title不存在就使用newTitle
                            showToast('标题更新成功', 'success');
                        } else {
                            titleDiv.innerHTML = originalTitle;
                            showToast(result.message || '更新失败', 'error');
                        }
                    } catch (error) {
                        console.error('更新标题失败:', error);
                        titleDiv.innerHTML = originalTitle;
                        showToast('更新标题失败', 'error');
                    } finally {
                        isSaving = false;
                    }
                } else {
                    titleDiv.innerHTML = originalTitle;
                }
            }

            // 回车提交
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveTitle();
                }
            };

            // 失去焦点时恢复原内容
            input.onblur = () => {
                if (!isSaving) {
                    titleDiv.innerHTML = originalTitle;
                }
            };
        }
        
        // 删除对话 DONE
        async function deleteChat(event, convId) {
            event.stopPropagation(); // 阻止事件冒泡
            if (!confirm('确定要删除这个对话吗？')) {
                return;
            }
            try { // delete_conversation
                const response = await fetch(`/chat/api/conversation/${convId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    await loadConversationList(); // 重新加载对话列表
                    showToast('对话删除成功', 'success');
                    // 如果删除的是当前对话，清空对话区域
                    if (currentConversationId === convId) {
                        document.getElementById('chatMessages').innerHTML = '';
                        currentConversationId = null;
                    }
                } else {
                    showToast(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除对话失败:', error);
                showToast('删除对话失败', 'error');
            }
        }

        // 搜索后 更新对话列表显示 DONE
        function updateChatList(chats) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = ''; // 清空现有列表
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = chat.conversation_id;
                chatItem.innerHTML = `
                    <div class="chat-actions">
                        <button onclick="event.stopPropagation(); editChatTitle(event, '${chat.conversation_id}', '${chat.title}')" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteChat(event, '${chat.conversation_id}')" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="chat-title">${chat.title || '新对话'}</div>
                `;
                chatItem.onclick = () => loadConversation(chat.title, chat.conversation_id);
                chatList.appendChild(chatItem);
            });
            // addChatListeners();
        }

        // -------------------------------- 笔记管理 --------------------------------
        // TODO 多笔记汇入合并 线上 chatid 没带过来APP类型记为NewsReader 用户界面系统提示词。项目？分组、标签， 接入搜素， 支持url， 新建/追加笔记 大笔记失败， chatid conv_id精简， 底部滚动条，Perplexiti AI集成 获取新闻，google 搜索集成，学术搜索集成，改密码，拉勾

        // 调用后端方法 记笔记
        async function createNote(noteData) {
            try {
                // 发送请求创建笔记
                const response = await fetch('/note/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(noteData)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('笔记创建成功', 'success');
                } else {
                    if (result.error.includes("400 Client Error: Bad Request for url: https://api.notion.com/v1/pages")) {
                        showToast('创建笔记失败: 请检查笔记是否超过 1000 个字符', 'error');
                    } else {
                        showToast('创建笔记失败: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                console.error('创建笔记失败:', error);
                showToast('创建笔记失败', 'error');
            }
        }

        // 选中的文本记笔记
        async function saveSelectionAsNote() {
            try {
                const selectedText = window.getSelection().toString();
                if (selectedText) {
                    const noteData = {
                        title: `${currentChatTitle} - ${new Date().toLocaleString()}`,
                        content: selectedText,
                        source: 'NewsReader',
                        types: ['NOTE'],
                        chats: currentConversationId ? [currentConversationId] : []
                    };

                    // 如果有选中的文章，添加到笔记中
                    const selectedArticles = getSelectedArticles();
                    if (selectedArticles.length > 0) {
                        noteData.articles = selectedArticles;
                    }
                    // 发送请求创建笔记
                    await createNote(noteData);
                }
            } catch (error) {
                showToast('创建笔记失败: ' + error.message, 'error');
            }
        }

        // 创建或更新笔记
        async function createUpdateNote() {
            try {
                // 获取当前对话的内容
                const chatMessages = document.querySelectorAll('.message');
                if (!chatMessages.length) {
                    return;
                }
                // 收集对话内容
                let content = '';
                chatMessages.forEach(msg => {
                    const text = msg.querySelector('.message-content').textContent;
                    content += `${text}`;
                });
                // 准备笔记数据
                const noteData = {
                    title: `${currentChatTitle} - ${new Date().toLocaleString()}`,
                    content: content,
                    source: 'NewsReader',
                    types: ['NOTE'],
                    chats: currentConversationId ? [currentConversationId] : []
                };
                // 如果有选中的文章，添加到笔记中
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 0) {
                    noteData.articles = selectedArticles;
                }
                await createNote(noteData);
            } catch (error) {
                showToast('创建笔记失败: ' + error.message, 'error');
            }
        }

        // 保存消息为笔记
        async function saveMessageAsNote(button) {
            try {
                const messageDiv = button.closest('.message');
                const content = messageDiv.querySelector('.message-content').textContent;
                const noteData = {
                    title: `${currentChatTitle} - ${new Date().toLocaleString()}`,
                    content: content,
                    source: 'NewsReader',
                    types: ['NOTE'],
                    chats: currentConversationId ? [currentConversationId] : []
                };
                // 如果有选中的文章，添加到笔记中
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 0) {
                    noteData.articles = selectedArticles;
                }
                await createNote(noteData);
            } catch (error) {
                showToast('创建笔记失败: ' + error.message, 'error');
            }
        }
    
    </script>
</body>
</html>
