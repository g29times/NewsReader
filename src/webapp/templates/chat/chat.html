<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - NewsReader</title>
	<!-- <link rel="icon" href="https://drive.google.com/file/d/1Vn_00nTR1ID3LK9hvX7zgi6WRND_3SUA/view?usp=drive_link" sizes="256x256" type="image/svg+xml"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script> -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.all.min.css') }}"> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pako.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cache_manager.js') }}"></script>
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="chat-container">
        <!-- 左侧文章面板 -->
        <div class="articles-panel collapsed">
            <div class="panel-header">
                <div class="toolbar">
                    <input type="text" placeholder="搜索文章..." class="form-control">
                </div>
                <button class="toggle-panel-btn" onclick="toggleArticlesPanel()">➡</button>
            </div>
            <div class="panel-content">
                <div id="articleList" class="article-list">
                    <div class="article-list-header">
                        <input type="checkbox" id="selectAll" class="article-checkbox">
                        <label for="selectAll">全选<span id="articleCount"></span></label>
                    </div>
                    <div class="article-items">
                        {% for article in articles %}
                        <div class="article-item">
                            <input type="checkbox" class="article-checkbox" data-article-id="{{ article.id }}">
                            <!-- 点击 获取文章详情 -->
                            <div class="article-title" onclick="fetchArticleDetails('{{ article.id }}')">{{ article.title }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="expandedArticle" style="display: none;">
                    <div class="article-header">
                        <button class="collapse-btn btn btn-sm btn-outline-secondary" onclick="toggleArticleView()">回到列表</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="addToVecDb(this)" data-article-id="" style="display: none;">加知识库</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="saveArtAsNote(this)">存Notion</button>
                    </div>
                    <h2 class="article-title" id="expandedArticleTitle"></h2>
                    <div class="source-guide-container">
                        <div class="source-guide-header" onclick="toggleSourceGuide(this)">
                            <h5 class="source-guide-title btn btn-outline-primary">学习指南</h5>
                            <span class="arrow">▶</span>
                        </div>
                        <div class="source-guide-content">
                            <div class="source">
                                <h4>来源</h4>
                                <div id="expandedArticleSource"></div>
                            </div>
                            <div class="key-topics">
                                <h4>关键主题</h4>
                                <div id="expandedArticleTopics"></div>
                            </div>
                            <div class="tags">
                                <h4>标签</h4>
                                <ul id="expandedArticleTags"></ul>
                            </div>
                            <div class="summary">
                                <h4>摘要</h4>
                                <button class="btn btn-sm btn-outline-secondary" onclick="quoteContent('summary')">引用摘要</button>
                                <div id="expandedArticleSummary"></div>
                            </div>
                        </div>
                    </div>
                    <div class="article-body" id="expandedArticleContent"></div>
                </div>
            </div>
        </div>

        <!-- 中间聊天区域 -->
        <div class="chat-area">
            <div class="chat-toolbar">
                <button class="btn btn-outline-secondary" onclick="createUpdateChat(true)">新对话</button>
                <button class="btn btn-outline-secondary" onclick="saveChatAsNote()">存对话</button>
                <button class="btn btn-outline-secondary" onclick="setApiKey()" title="再次点击保存">KEY</button>
                <input type="password" id="api_key" class="form-control api-key" data-model="" placeholder="输入API Key..." style="display: none;">
                <div class="choice-radio">
                    <!-- 模型 -->
                    <select name="llm_choice" id="llm_choice" onchange="handleModelChange()">
                        <option value='gemini-2.0-flash-exp' data-provider="google">Gemini</option>
                        <option value='gemini-exp-1206' data-provider="google">G1206</option>
                        <option value='minimax-text-01' data-provider="minimax">abab65</option>
                        <option value='gpt-4o-mini' data-provider="openai">4omini</option>
                    </select>
                    <!-- 最大查询URL数量 -->
                    <!-- <label for="keep_urls" value="Max Recall URL">URLs</label> -->
                    <select name="keep_urls" id="keep_urls" hidden="true">
                        <option value=5>5URL</option>
                        <option value=10>10</option>
                        <option value=20>20</option>
                     </select>
                     <!-- 默认关闭RAG -->
                     <!-- <label for="rag_func" value="Is RAG Func">RAG</label> -->
                     <select name="rag_func" id="rag_func">
                        <option value=0>OFF</option>
                        <option value=1>RAG</option>
                     </select>
                     <!-- RAG召回数量 -->
                     <!-- <label for="recall_num" value="RAG Recall Number">REF</label> -->
                     <select name="recall_num" id="recall_num" hidden="true">
                        <option value=20>20</option>
                        <option value=6>6</option>
                        <option value=10>10</option>
                     </select>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 聊天消息将在这里动态添加 -->
            </div>
            <div class="chat-input-area">
                <textarea id="messageInput" class="chat-input" placeholder="输入消息..."></textarea>
                <button class="btn btn-primary" onclick="sendChatMessage()">对话</button>
                <button class="btn btn-outline-secondary" onclick="uploadFile()">文件</button>
                <button class="btn btn-outline-secondary" onclick="startRecording()">语音</button>
                <input type="file" id="fileInput" accept="image/*,text/*,video/*,audio/*,application/pdf" multiple style="display: none;">
            </div>
        </div>

        <!-- 右侧笔记区域 -->
        <div class="right-panel">
            <div class="panel-header">
                <button class="toggle-panel-btn" onclick="toggleRightPanel()">➡</button>
                <div class="toolbar">
                    <input type="text" placeholder="搜索对话..." class="form-control">
                </div>
            </div>
            <div class="panel-content">
                <div class="chat-list" id="chatList">
                    <!-- 对话列表将在这里动态添加 -->
                </div>
                <div class="note-list">
                    <div class="note-item">
                        <div class="toolbar">
                            <input type="text" placeholder="搜索笔记..." class="form-control">
                        </div>
                        <button class="btn btn-outline-secondary" onclick="createNewNote()">新建笔记</button>
                        <div class="note-title">笔记标题</div>
                        <div class="note-content">笔记内容</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮动引用按钮 -->
    <div id="floatQuoteBtn" class="float-quote-btn">
        <button class="btn btn-sm btn-outline-secondary" onclick="quoteSelection()">
            <i class="fas fa-quote-right"></i> 继续引用
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="saveSelectionAsNote()">
            <i class="fas fa-sticky-note"></i> 记笔记
        </button>
    </div>

    <!-- 缓存统计按钮 -->
    <button id="showCacheStats" class="btn btn-sm btn-info" style="position: fixed; bottom: 20px; right: 20px;">
        <i class="fas fa-chart-bar"></i> 缓存统计
    </button>

    <!-- 缓存统计模态框 -->
    <div class="modal fade" id="cacheStatsModal" tabindex="-1" role="dialog" aria-labelledby="cacheStatsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cacheStatsModalLabel">缓存使用统计</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="cache-stats">
                        <div class="progress mb-3">
                            <div id="cacheUsageBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p>缓存项数量: <span id="itemCount">0</span></p>
                        <p>当前使用: <span id="currentSize">0</span> MB</p>
                        <p>最大容量: <span id="maxSize">0</span> MB</p>
                        <p>使用率: <span id="usagePercentage">0</span>%</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="clearCacheAndUpdate()">清空缓存</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // -------------------------------- 通用方法 --------------------------------
        // 重点 通用的防抖函数
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            }
        }

        // 文章搜索的防抖处理
        const debouncedSearchArticles = debounce(async (query) => {
            try {
                const response = await fetch(`/chat/api/articles/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('搜索失败');
                const result = await response.json();
                updateArticlesList(result.data.articles);
            } catch (error) {
                showToast('搜索失败: ' + error.message, 'error');
            }
        }, 300);

        // 对话搜索的防抖处理
        const debouncedSearchChats = debounce(async (query) => {
            try {
                const response = await fetch(`/chat/api/conversations/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('搜索失败');
                const chats = await response.json();
                updateChatList(chats);
                // addChatListeners();
            } catch (error) {
                showToast('搜索失败: ' + error.message, 'error');
            }
        }, 300);

        // 监听文章搜索输入
        document.querySelector('.articles-panel .toolbar input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                debouncedSearchArticles(query);
            } else {
                debouncedSearchArticles(''); // 当搜索框为空时，加载所有文章
            }
        });

        // 监听对话搜索输入
        document.querySelector('.right-panel .toolbar input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                debouncedSearchChats(query);
            } else {
                debouncedSearchChats(''); // 当搜索框为空时，加载所有对话
            }
        });

        // 引用消息
        function quoteMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content').innerText;
            const messageInput = document.getElementById('messageInput');
            messageInput.value = `${contentDiv}\n---------------\n`;
            messageInput.focus();
        }

        // 引用文章摘要
        function quoteContent(type) {
            const messageInput = document.getElementById('messageInput');
            if (type === 'full') {
                // const title = document.getElementById('expandedArticleTitle').innerText;
                const source = document.getElementById('expandedArticleContent').innerText;
                // messageInput.value = `${title}\n${source}\n---------------\n`;
                messageInput.value = `${source}\n---------------\n`;
            } else if (type === 'summary') {
                const summary = document.getElementById('expandedArticleSummary').innerText;
                messageInput.value = `${summary}\n---------------\n`;
            }
            messageInput.focus();
        }
        
        // 引用选中的文本
        function quoteSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (text) {
                const messageInput = document.getElementById('messageInput');
                // += 允许多段引用
                messageInput.value += `${text}\n---------------\n`;
                messageInput.focus();
                // 隐藏浮动按钮
                document.getElementById('floatQuoteBtn').style.display = 'none';
            }
        }
    
        // 处理选中文本的引用功能
        document.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            const floatBtn = document.getElementById('floatQuoteBtn');
            
            if (selection.toString().trim().length > 0) {
                // 获取选中文本的位置
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // 设置浮动按钮位置
                floatBtn.style.left = `${rect.left + window.scrollX}px`;
                floatBtn.style.top = `${rect.bottom + window.scrollY + 5}px`;
                floatBtn.style.display = 'block';
            } else {
                floatBtn.style.display = 'none';
            }
        });

        // 点击页面其他地方时隐藏浮动按钮
        document.addEventListener('mousedown', function(e) {
            if (!e.target.closest('#floatQuoteBtn')) {
                document.getElementById('floatQuoteBtn').style.display = 'none';
            }
        });

        // 重点 Toast 提示功能 
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('#toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 文件上传功能
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }

        // 文件预览功能
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            if (!text || text === '') {
                showToast('请输入消息', 'warning');
                return;
            }

            // 组合文字和文件预览HTML
            let content = `<p>${text}</p>`;
            
            // 处理所有文件预览
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    // 图片预览
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        content += `<img src="${e.target.result}" style="max-width: 500px;"><br>`;
                        // 所有文件都处理完后，显示并发送
                        if (Array.from(files).indexOf(file) === files.length - 1) {
                            // 使用原有的addUserMessageToChat添加到聊天区域
                            addUserMessageToChat(content);
                            try {
                                // 保存消息文本，这样sendChatMessage可以读取到
                                const savedText = text;
                                // 发送到后端，直接传入原始的files对象
                                await sendChatMessage(files, savedText);
                            } catch (error) {
                                console.error('Upload error:', error);
                                showToast(error.message || '上传失败', 'error');
                            }
                        }
                    }
                    reader.readAsDataURL(file);
                } else {
                    // 非图片文件，显示文件名和类型
                    content += `<p>📎 ${file.name} (${file.type || '未知类型'})</p>`;
                    // 如果是最后一个文件，显示并发送
                    if (Array.from(files).indexOf(file) === files.length - 1) {
                        // 使用原有的addUserMessageToChat添加到聊天区域
                        addUserMessageToChat(content);
                        try {
                            // 保存消息文本，这样sendChatMessage可以读取到
                            const savedText = text;
                            // 发送到后端，直接传入原始的files对象
                            await sendChatMessage(files, savedText);
                        } catch (error) {
                            console.error('Upload error:', error);
                            showToast(error.message || '上传失败', 'error');
                        }
                    }
                }
            }
        });

        // 录音功能（待实现）
        function startRecording() {
            showToast('录音功能即将推出', 'info');
        }

        // 设置API key的函数
        function setApiKey() {
            const apiKeyInput = document.getElementById('api_key');
            const currentModel = document.getElementById('llm_choice').value;
            const provider = document.querySelector(`option[value='${currentModel}']`).dataset.provider;
            const providerNames = {
                'google': 'Google',
                'openai': 'OpenAI',
                'minimax': 'MiniMax'
            };
            const providerName = providerNames[provider] || provider.toUpperCase();
            
            if (apiKeyInput.style.display === 'none') {
                // 显示输入框
                apiKeyInput.style.display = 'inline-block';
                apiKeyInput.dataset.model = provider;
                apiKeyInput.placeholder = `请输入${providerName}的API Key`;
                // 加载已保存的key
                const savedKey = getCookie(`${provider}_api_key`);
                if (savedKey) {
                    apiKeyInput.value = savedKey;
                }
                apiKeyInput.focus();
            } else {
                // 保存并隐藏输入框
                const apiKey = apiKeyInput.value.trim();
                const currentProvider = apiKeyInput.dataset.model;
                const currentProviderName = providerNames[currentProvider] || currentProvider.toUpperCase();
                if (apiKey) {
                    setCookie(`${currentProvider}_api_key`, apiKey, 30);
                    showToast(`${currentProviderName}的API Key已保存`, 'success');
                }
                apiKeyInput.style.display = 'none';
                apiKeyInput.value = '';
                apiKeyInput.dataset.model = '';
            }
        }

        // 重点 处理模型切换
        function handleModelChange() {
            const apiKeyInput = document.getElementById('api_key');
            const currentModel = document.getElementById('llm_choice').value;
            const provider = document.querySelector(`option[value='${currentModel}']`).dataset.provider;
            const providerNames = {
                'google': 'Google',
                'openai': 'OpenAI',
                'minimax': 'MiniMax'
            };
            const providerName = providerNames[provider] || provider.toUpperCase();
            
            // 如果输入框是显示状态，更新其属性
            if (apiKeyInput.style.display === 'inline-block') {
                apiKeyInput.dataset.model = provider;
                apiKeyInput.placeholder = `请输入${providerName}的API Key`;
                // 加载已保存的key
                const savedKey = getCookie(`${provider}_api_key`);
                apiKeyInput.value = savedKey || '';
            }
        }

        // 获取当前选中模型的API key
        function getCurrentApiKey() {
            const currentModel = document.getElementById('llm_choice').value;
            const provider = document.querySelector(`option[value='${currentModel}']`).dataset.provider;
            return getCookie(`${provider}_api_key`);
        }

        // 重点 Cookie操作函数
        function setCookie(name, value, days) {
            let expires = '';
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = '; expires=' + date.toUTCString();
            }
            document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(c.substring(nameEQ.length, c.length));
                }
            }
            return null;
        }

        // 重点 缓存管理器 cache_manager.js
        const chatCache = new CacheManager({
            ttl: {{ config.CHAT_CACHE_TTL }},
            maxSize: {{ config.CHAT_CACHE_MAX_SIZE }},
            storageKey: 'chat_cache',
            compression: true
        });

        // 更新缓存统计信息
        function updateCacheStats() {
            const stats = chatCache.getStats();
            document.getElementById('itemCount').textContent = stats.itemCount;
            document.getElementById('currentSize').textContent = (stats.currentSize / (1024 * 1024)).toFixed(2);
            document.getElementById('maxSize').textContent = (stats.maxSize / (1024 * 1024)).toFixed(2);
            document.getElementById('usagePercentage').textContent = stats.usagePercentage.toFixed(1);
            
            const progressBar = document.getElementById('cacheUsageBar');
            progressBar.style.width = `${stats.usagePercentage}%`;
            progressBar.setAttribute('aria-valuenow', stats.usagePercentage);
            progressBar.className = `progress-bar ${stats.usagePercentage > 80 ? 'bg-danger' : 'bg-info'}`;
            // console.log('updateCacheStats')
        }

        // 清空缓存并更新统计
        function clearCacheAndUpdate() {
            chatCache.clearAndUpdateStats(updateCacheStats);
            showToast('缓存已清空', 'success');
        }

        // 显示缓存统计按钮点击事件
        document.getElementById('showCacheStats').addEventListener('click', () => {
            updateCacheStats();
            $('#cacheStatsModal').modal('show');
        });

        // 监听模态框关闭事件
        $('#cacheStatsModal').on('hidden.bs.modal', function () {
            // 清理不需要的属性
            $(this).find('.modal-backdrop').remove();
        });

        // -------------------------------- 文章管理 --------------------------------
        let isExpanded = false;
        let currentArticleId = null;
        let currentArticle = '';

        // 左侧文章区 面板展开/收起 默认收起
        function toggleArticlesPanel() {
            const panel = document.querySelector('.articles-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                button.textContent = '⬅';
            } else {
                panel.classList.add('collapsed');
                button.textContent = '➡';
            }
        }

        // 右侧笔记区 面板展开/收起 默认展开
        function toggleRightPanel() {
            const panel = document.querySelector('.right-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                button.textContent = '➡';
            } else {
                panel.classList.add('collapsed');
                button.textContent = '⬅';
            }
        }

        // 切换文章列表和详情显示
        function toggleArticleView(showDetail = false) {
            const articleList = document.getElementById('articleList');
            const expandedArticle = document.getElementById('expandedArticle');
            
            if (showDetail) {
                articleList.style.display = 'none';
                expandedArticle.style.display = 'block';
            } else {
                articleList.style.display = 'block';
                expandedArticle.style.display = 'none';
            }
        }

        // 文章概要 上下展开/收起
        function toggleSourceGuide(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('expanded');
            
            // 更新箭头方向
            const arrow = element.querySelector('.arrow');
            if (content.classList.contains('expanded')) {
                arrow.textContent = '▼';
            } else {
                arrow.textContent = '▶';
            }
        }

        // 重点 显示文章列表
        function showArticleList() {
            document.querySelector('.article-list').style.display = 'block';
            document.getElementById('expandedArticle').style.display = 'none';
        }

        // 隐藏文章列表
        function hideArticleList() {
            document.querySelector('.article-list').style.display = 'none';
            document.getElementById('expandedArticle').style.display = 'block';
        }

        // 上传文件后 显示文章
        function showArticleInfo(article) {
            // 在文章面板中显示新添加的文章
            const articlePanel = document.querySelector('.articles-panel');
            if (articlePanel && !articlePanel.classList.contains('collapsed')) {
                // 如果文章面板打开，刷新文章列表
                showArticleList();
            }
        }

        // 显示文章内容
        function displayArticleContent(article) {
            const articleList = document.getElementById('articleList');

            const expandedArticle = document.getElementById('expandedArticle');
            const title = document.getElementById('expandedArticleTitle');
            const content = document.getElementById('expandedArticleContent');
            const summary = document.getElementById('expandedArticleSummary');
            const topics = document.getElementById('expandedArticleTopics');
            const tags = document.getElementById('expandedArticleTags');
            const source = document.getElementById('expandedArticleSource');
            
            // 隐藏文章列表
            articleList.style.display = 'none';
            // 显示文章详情
            expandedArticle.style.display = 'block';
            // 设置文章内容
            title.textContent = article.title || '';
            // 使用showdown转换Markdown为HTML
            const converter = new showdown.Converter();
            try {
                content.innerHTML = article.content ? converter.makeHtml(article.content) : '';
                summary.innerHTML = article.summary ? converter.makeHtml(article.summary) : '';
                const topicsHtml = article.topics ? converter.makeHtml(article.topics.map(topic => `- ${topic}`).join('\n')) : '';
                topics.innerHTML = topicsHtml;
            } catch (error) {
                content.innerHTML = article.content || '';
                summary.innerHTML = article.summary || '';
                topics.innerHTML = article.topics ? article.topics.map(topic => `- ${topic}`).join('\n') : '';
            }
            tags.innerHTML = article.tags || '';
            source.innerHTML = article.source ? `- ${article.source}` : '';
        }

        // 重点 获取文章详情
        let isFetchingArticle = false;
        async function fetchArticleDetails(articleId) {
            if (isFetchingArticle) {
                showToast('正在获取文章数据，请稍等', 'info');
                return;
            }
            try {
                isFetchingArticle = true;
                // 尝试从缓存获取文章
                const cachedArticle = chatCache.get(`article_${articleId}`);
                let article;
                if (cachedArticle) {
                    article = cachedArticle;
                } else {
                    // 如果缓存中没有，则从服务器获取
                    const response = await fetch(`/chat/api/articles/${articleId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch article details');
                    }
                    article = await response.json();
                    // 存入缓存，文章缓存时间设置为24小时
                    chatCache.set(`article_${articleId}`, article, { 
                        ttl: 2592000,  // 30天
                        type: 'json' 
                    });
                }
                // 加入向量库（知识库）
                const addVecBtn = document.querySelector('#expandedArticle .article-header button[onclick^="addToVecDb"]');
                if (addVecBtn) {
                    // 如果已经加入知识库（vector_ids不为空），则隐藏按钮
                    if (article.data.article.vector_ids) {
                        addVecBtn.style.display = 'none';
                    } else {
                        addVecBtn.style.display = 'inline-block';
                        addVecBtn.setAttribute('data-article-id', articleId);
                    }
                }
                // 如果点击的是同一篇文章，切换展开状态
                if (currentArticleId === articleId) {
                    if (document.getElementById('articleList').style.display === 'none') {
                        // 如果当前在详情页，切换回列表
                        toggleArticleView(false);
                    } else {
                        // 如果当前在列表页，显示详情
                        displayArticleContent(article.data.article);
                        toggleArticleView(true);
                    }
                } else {
                    // 如果是新文章，展示内容并展开面板
                    currentArticleId = articleId;
                    displayArticleContent(article.data.article);
                    toggleArticleView(true);
                    currentArticle = article.data.article;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showToast('查看文章失败', 'error');
            } finally {
                isFetchingArticle = false;
            }
        }
        
        // 文章加知识库
        function addToVecDb(btn) {
            const articleId = btn.getAttribute('data-article-id');
            if (!articleId) {
                showToast('错误', '未找到文章');
                return;
            }
            fetch('/article/vector_article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `article_ids=${articleId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('成功', '已开始添加到知识库');
                    // 直接隐藏按钮
                    btn.style.display = 'none';
                } else {
                    showToast('错误', data.message || '添加失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('错误', '添加失败');
            });
        }
    
        // 搜索后 更新文章列表
        function updateArticlesList(articles) {
            const articleList = document.querySelector('.article-items');
            articleList.innerHTML = articles.map(article => `
                <div class="article-item">
                    <input type="checkbox" class="article-checkbox" data-article-id="${article.id}">
                    <div class="article-title" onclick="fetchArticleDetails(${article.id})">${article.title}</div>
                </div>
            `).join('');
            document.getElementById('articleCount').textContent = articles.length ? ` ${articles.length}篇` : '';
            // 重新绑定复选框事件
            document.querySelectorAll('.article-items .article-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    // 检查是否所有复选框都被选中
                    const allCheckboxes = document.querySelectorAll('.article-items .article-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    document.getElementById('selectAll').checked = allChecked;
                });
            });
        }

        // 文章列表全选功能
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.article-items .article-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // 获取选中的文章ID列表
        function getSelectedArticles() {
            const checkboxes = document.querySelectorAll('.article-items .article-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.articleId);
        }

        // 更新文章选择状态
        document.querySelectorAll('.article-items .article-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                // 检查是否所有复选框都被选中
                const allCheckboxes = document.querySelectorAll('.article-items .article-checkbox');
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                document.getElementById('selectAll').checked = allChecked;
            });
        });

        // -------------------------------- 聊天消息管理 --------------------------------

        // 添加用户消息到聊天区域
        function addUserMessageToChat(content) {
            const messageIndex = document.querySelectorAll('.message').length;
            addMessageToChat('user', content, messageIndex);
        }

        // 添加助手消息到聊天区域
        function addAssistantMessageToChat(content) {
            // 移除所有"思考中..."的临时消息
            const tempMessages = document.querySelectorAll('.message.assistant.thinking');
            tempMessages.forEach(msg => msg.remove());
            
            // 添加实际的助手消息
            const messageIndex = document.querySelectorAll('.message').length;
            addMessageToChat('assistant', content, messageIndex);
        }

        // 添加思考中的临时消息
        function addThinkingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>GEMI:</strong>
                    <p>思考中...</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        // 重点 对话聊天 每次聊天生成对话或更新对话
        async function sendChatMessage(files = null, savedText = null) {
            const sendButton = document.querySelector('#chatMessages ~ .chat-input-area > .btn.btn-primary');
            try {
                const messageInput = document.getElementById('messageInput');
                const message = savedText || messageInput.value.trim();
                
                // 如果没有文件且没有消息，不执行
                if (!files && message === '') {
                    showToast('请输入消息', 'warning');
                    return;
                }

                // 禁用发送按钮
                sendButton.disabled = true;
                // 获取选中的文章ID
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 10) {
                    showToast('最多选择10篇文章', 'error');
                    return;
                }
                
                // 只有在非文件上传时才添加用户消息
                if (!files) {
                    // 添加用户消息到聊天区域
                    addUserMessageToChat(message);
                }
                
                // 清空输入框
                messageInput.value = '';
                
                // 添加思考中的临时消息
                const thinkingMessageIndex = addThinkingMessage();
                
                // 获取或创建对话ID
                const conv_id = await createUpdateChat();
                console.log('Conversation ID:', conv_id);
                
                // 处理文件列表
                let fileArray = [];
                if (files && files instanceof FileList) {
                    fileArray = Array.from(files);
                }
                
                // 调用chat服务
                let result = await call_chat(conv_id, message, selectedArticles, fileArray);
                if (result.success) {
                    if (result.data && result.data.response) {
                        addAssistantMessageToChat(result.data.response);
                        // 使当前对话的缓存失效
                        chatCache.deleteAndUpdateStats(`conv_${conv_id}`, updateCacheStats);
                    } else {
                        showToast('响应格式错误', 'error');
                    }
                } else {
                    showToast(result.message || '对话失败', 'error');
                }
            } catch (error) {
                console.error('Chat error:', error);
                showToast(error.message || '对话失败', 'error');
            } finally {
                // 移除思考中的临时消息
                const thinkingMessage = document.querySelector('.thinking-message');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                // 恢复发送按钮
                if (sendButton) {
                    sendButton.disabled = false;
                }
            }
        }

        // sendChatMessage 调用后端chat服务
        async function call_chat(conv_id, message, selectedArticles = [], files = []) {
            try {
                if (conv_id == undefined || conv_id == null || conv_id == '') {
                   throw new Error('请稍后再试');
                }
                // 构建请求数据
                const formData = new FormData();
                formData.append('conversation_id', conv_id);
                formData.append('message', message);
                formData.append('model', document.getElementById('llm_choice').value);
                formData.append('keep_urls', document.getElementById('keep_urls').value);
                formData.append('rag_func', document.getElementById('rag_func').value);
                formData.append('recall_num', document.getElementById('recall_num').value);
                
                // 获取当前模型对应的API key
                const apiKey = getCurrentApiKey();
                if (apiKey) {
                    formData.append('api_key', apiKey);
                }
                
                // 添加选中的文章ID
                formData.append('article_ids', getSelectedArticles().join(','));
                
                // 添加文件，使用相同的字段名files
                if (files && files.length > 0) {
                    Array.from(files).forEach(file => {
                        formData.append('files', file);
                    });
                }
                // 调用chat服务
                const response = await fetch('/chat/api/chat', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`服务响应：(${error.message || '未知错误'})`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Chat error:', error);
                throw error;  // 继续抛出错误，让上层函数处理
            }
        }

        // 添加消息到聊天区域
        function addMessageToChat(role, content, messageIndex = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            if (messageIndex !== null) {
                messageDiv.dataset.messageIndex = messageIndex;
            }
            
            // 处理可能的HTML内容
            let htmlContent = content;
            if (typeof content === 'string') {
                if (role === 'assistant') {
                    // 对助手的回答使用markdown转换
                    const converter = new showdown.Converter();
                    try {
                        htmlContent = converter.makeHtml(content); 
                    } catch (error) {
                        htmlContent = content;
                    }
                } else {
                    // 用户消息只转换换行符
                    htmlContent = content.replace(/\n/g, '<br>');
                }
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>${role === 'user' ? '你' : 'GEMI'}:</strong>
                    <div class="content">${htmlContent}</div>
                </div>
            `;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            // 保存笔记按钮
            const saveNoteButton = document.createElement('button');
            saveNoteButton.className = 'action-btn save-note';
            saveNoteButton.title = '加入笔记';
            saveNoteButton.innerHTML = '<i class="fas fa-sticky-note"></i>';
            saveNoteButton.onclick = function() { saveMessageAsNote(this); };
            actionsDiv.appendChild(saveNoteButton);

            // 编辑按钮
            const editButton = document.createElement('button');
            editButton.className = 'action-btn edit';
            editButton.title = '编辑';
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.onclick = function() { editMessage(this); };
            actionsDiv.appendChild(editButton);

            // 删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.className = 'action-btn delete';
            deleteButton.title = '删除';
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.onclick = function() { deleteMessage(this); };
            actionsDiv.appendChild(deleteButton);

            // 引用按钮
            const quoteButton = document.createElement('button');
            quoteButton.className = 'action-btn quote';
            quoteButton.title = '引用';
            quoteButton.innerHTML = '<i class="fas fa-quote-right"></i>';
            quoteButton.onclick = function() { quoteMessage(this); };
            actionsDiv.appendChild(quoteButton);

            // 复制按钮
            const copyButton = document.createElement('button');
            copyButton.className = 'action-btn copy';
            copyButton.title = '复制';
            copyButton.innerHTML = '<i class="fas fa-copy"></i>';
            copyButton.onclick = function() { copyMessage(this); };
            actionsDiv.appendChild(copyButton);

            messageDiv.appendChild(actionsDiv);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 复制消息内容
        function copyMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content');
            const content = contentDiv ? contentDiv.textContent : '';
            
            // 创建一个临时文本区域
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            try {
                // 选择文本并尝试复制
                textarea.select();
                const success = document.execCommand('copy');
                if (success) {
                    showToast('已复制到剪贴板', 'success');
                } else {
                    // 如果execCommand失败，尝试使用Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(content)
                            .then(() => showToast('已复制到剪贴板', 'success'))
                            .catch(err => {
                                console.error('复制失败:', err);
                                showToast('复制失败，请重试', 'error');
                            });
                    } else {
                        throw new Error('不支持复制功能');
                    }
                }
            } catch (err) {
                console.error('复制失败:', err);
                showToast('复制失败，请重试', 'error');
            } finally {
                // 清理临时文本区域
                document.body.removeChild(textarea);
            }
        }

        // 删除聊天消息 对话中的一段消息 对话聊天
        async function deleteMessage(button) {
            event.stopPropagation();
            const messageDiv = button.closest('.message');
            const messageIndex = messageDiv.getAttribute('data-message-index');
            const conversationId = currentConversationId;
            if (!messageIndex || !conversationId) {
                console.error('无法获取消息索引');
                showToast('无法获取消息索引', 'error');
                return;
            }
            try { // delete_message
                const response = await fetch('/chat/api/msg/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        message_index: messageIndex
                    })
                });
                const result = await response.json();
                if (result.success) {
                    messageDiv.remove();
                    // 重新编制索引
                    const messages = document.querySelectorAll('.chat-messages .message');
                    messages.forEach((msg, idx) => {
                        msg.setAttribute('data-message-index', idx);
                    });
                    // 如果删除的是最后一条助手消息，启用发送按钮
                    const lastMessage = document.querySelector('.chat-messages .message:last-child');
                    if (!lastMessage || lastMessage.classList.contains('user')) {
                        document.querySelector('.chat-input-area button.btn-primary').disabled = false;
                    }
                    chatCache.deleteAndUpdateStats(`conv_${conversationId}`, updateCacheStats);
                    showToast('消息已删除', 'success');
                } else {
                    showToast(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除消息失败:', error);
                showToast('删除失败，请稍后重试', 'error');
            }
        }

        // 编辑聊天消息 对话中的一段消息 对话聊天
        function editMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content');
            const originalContent = contentDiv.innerHTML;
            const messageIndex = messageDiv.getAttribute('data-message-index');
            const conversationId = currentConversationId;
            let isSaving = false;  // 添加保存状态标记
            
            if (!messageIndex || !conversationId) {
                console.error('无法获取消息索引');
                showToast('无法获取消息索引', 'error');
                return;
            }

            // 创建编辑框
            const textarea = document.createElement('textarea');
            textarea.value = originalContent;
            textarea.style.width = '100%';
            textarea.style.minHeight = '100px';
            
            contentDiv.innerHTML = '';
            contentDiv.appendChild(textarea);
            textarea.focus();

            // 保存编辑
            async function saveEdit() {
                const newContent = textarea.value; // 修复换行符替换
                if (newContent && newContent !== originalContent) {
                    isSaving = true;  // 开始保存
                    try { // edit_chat_msg
                        const response = await fetch('/chat/api/msg/edit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                conversation_id: conversationId,
                                message_index: messageIndex,
                                content: newContent,
                                role: messageDiv.classList.contains('user') ? 'user' : 'assistant'
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            contentDiv.innerHTML = newContent; // 修复换行符替换
                            chatCache.deleteAndUpdateStats(`conv_${conversationId}`, updateCacheStats);
                            showToast('修改已保存', 'success');
                        }
                    } catch (error) {
                        console.error('保存失败:', error);
                        showToast('保存失败', 'error');
                    } finally {
                        isSaving = false;  // 结束保存
                    }
                } else {
                    contentDiv.innerHTML = originalContent;
                }
            }
            // 回车提交
            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();  // 阻止回车的默认行为
                    saveEdit();
                }
            };
            // 失去焦点时恢复原内容
            textarea.onblur = () => {
                if (!isSaving) {
                    contentDiv.innerHTML = originalContent;
                }
            };
        }

        // -------------------------------- 历史对话管理 --------------------------------

        // 当前选中的对话ID
        let currentConversationId = null;
        let currentChatTitle = '';
        
        // 调用后端服务 加载对话列表 DONE
        async function loadConversationList() {
            try { // get_conversations
                const response = await fetch('/chat/api/conversations');
                const conversations = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // 清空现有列表
                conversations.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.conversationId = chat.conversation_id;
                    chatItem.innerHTML = `
                        <div class="chat-actions">
                            <button onclick="event.stopPropagation(); editChatTitle(event, '${chat.conversation_id}', '${chat.title}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteChat(event, '${chat.conversation_id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="chat-title">${chat.title || '新对话'}</div>
                    `;
                    chatItem.onclick = () => loadConversation(chat.title, chat.conversation_id);
                    chatList.appendChild(chatItem);
                });
                // addChatListeners();
            } catch (error) {
                console.error('加载对话列表失败:', error);
                showToast('加载对话列表失败', 'error');
            }
        }
        
        // 重点 页面加载时获取对话列表 DONE
        document.addEventListener('DOMContentLoaded', () => {
            loadConversationList();
            // 添加输入框监听
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('.chat-input-area button.btn-primary');
            // 监听输入框变化
            messageInput.addEventListener('input', function() {
                sendButton.disabled = !this.value.trim();
            });
            // 监听Ctrl+Enter发送消息
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();  // 阻止默认行为
                    if (!sendButton.disabled) {
                        sendChatMessage();
                    }
                }
            });
            // 初始状态设置
            sendButton.disabled = !messageInput.value.trim();
            // 加载保存的API keys
            document.querySelectorAll('.api-key').forEach(input => {
                const provider = input.dataset.model;
                const savedKey = getCookie(`${provider}_api_key`);
                if (savedKey) {
                    input.value = savedKey;
                }
            });
        });
        
        // 重点 加载特定对话内容
        let isFetchingConversation = false;
        async function loadConversation(chat_title, convId) {
            if (currentConversationId === convId) {
                return;  // 静默返回，无需任何提示
            }
            if (isFetchingConversation) {
                showToast('正在获取对话数据，请稍等', 'info');
                return;
            }
            try {
                isFetchingConversation = true;
                currentChatTitle = chat_title;
                currentConversationId = convId;  // 设置当前对话ID

                // 尝试从缓存获取对话
                const cachedConversation = chatCache.get(`conv_${convId}`);
                let history;
                if (cachedConversation) {
                    history = cachedConversation;
                } else {
                    // 如果缓存中没有，则从服务器获取
                    const response = await fetch(`/chat/api/conversation?conversation_id=${convId}`);
                    history = await response.json();
                    // 存入缓存
                    chatCache.set(`conv_${convId}`, history, { type: 'json' });
                }
                // 清空现有对话
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                // 循环添加消息块
                history.forEach((msg, index) => addMessageToChat(msg.role, msg.blocks[0].text, index));
            } catch (error) {
                console.error('加载对话失败:', error);
                showToast('加载对话失败', 'error');
            } finally {
                isFetchingConversation = false;
            }
        }

        // 创建或更新新对话 DONE 四种情况：1 空白新页面 直接对话 此时没有对话ID 2 在已有对话的情况下点击新建对话(force) 点的时候 没有新ID 但是点完后页面清屏 并且有ID 3 点击某个对话，进行对话，此时有ID
        async function createUpdateChat(force=false) {
            const messageDiv = document.querySelector('.chat-messages .message:last-child');
            if (!messageDiv) {
                return;
            }
            // 创建对话
            if (!currentConversationId || force) {
                try { // create_conversation
                    const response = await fetch('/chat/api/conversation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: '1'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        currentConversationId = result.data.conversation_id;  // 设置当前对话ID
                        if (force) { // 点击新建按钮 清空现有对话
                            const chatMessages = document.getElementById('chatMessages');
                            chatMessages.innerHTML = '';
                        }
                        // 刷新对话列表
                        loadConversationList();
                        return currentConversationId;
                    } else {
                        showToast('创建对话失败', 'error');
                    }
                } catch (error) {
                    console.error('创建对话失败:', error);
                    showToast('创建对话失败', 'error');
                    throw error;  // 继续抛出错误，中断聊天请求
                }
            }
            // 已有ID 更新对话 用于每次对话后刷新对话时间
            else {
                try { // update_conversation update_chat
                    const response = await fetch(`/chat/api/conversation/${currentConversationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: '1'
                        })
                    });
                    return currentConversationId;
                } catch (error) {
                    // 暂不处理
                    return currentConversationId;
                } finally {
                    // 刷新对话列表
                    loadConversationList();
                }
            }
        }
        
        // 编辑对话标题 DONE
        async function editChatTitle(event, convId, currentTitle) {
            event.stopPropagation(); // 阻止事件冒泡
            
            const chatItem = event.target.closest('.chat-item');
            const titleDiv = chatItem.querySelector('.chat-title');
            const originalTitle = titleDiv.textContent;
            let isSaving = false;
            
            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-title-input';
            input.value = originalTitle;
            
            titleDiv.innerHTML = '';
            titleDiv.appendChild(input);
            input.focus();

            // 保存编辑
            async function saveTitle() {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== originalTitle) {
                    isSaving = true;
                    try { // update_conversation
                        const response = await fetch(`/chat/api/conversation/${convId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                title: newTitle
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            titleDiv.innerHTML = result.data?.title || newTitle;  // 使用可选链操作符，如果result.data.title不存在就使用newTitle
                            showToast('标题更新成功', 'success');
                        } else {
                            titleDiv.innerHTML = originalTitle;
                            showToast(result.message || '更新失败', 'error');
                        }
                    } catch (error) {
                        console.error('更新标题失败:', error);
                        titleDiv.innerHTML = originalTitle;
                        showToast('更新标题失败', 'error');
                    } finally {
                        isSaving = false;
                    }
                } else {
                    titleDiv.innerHTML = originalTitle;
                }
            }
            // 回车提交
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveTitle();
                }
            };
            // 失去焦点时恢复原内容
            input.onblur = () => {
                if (!isSaving) {
                    titleDiv.innerHTML = originalTitle;
                }
            };
        }
        
        // 删除对话 DONE
        async function deleteChat(event, convId) {
            event.stopPropagation(); // 阻止事件冒泡
            if (!confirm('确定要删除这个对话吗？')) {
                return;
            }
            try { // delete_conversation
                const response = await fetch(`/chat/api/conversation/${convId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    await loadConversationList(); // 重新加载对话列表
                    // 如果删除的是当前对话，清空对话区域
                    if (currentConversationId === convId) {
                        document.getElementById('chatMessages').innerHTML = '';
                        currentConversationId = null;
                    }
                    chatCache.deleteAndUpdateStats(`conv_${convId}`, updateCacheStats);
                    showToast('对话删除成功', 'success');
                } else {
                    showToast(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除对话失败:', error);
                showToast('删除对话失败', 'error');
            }
        }

        // 搜索后 更新对话列表显示 DONE
        function updateChatList(chats) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = ''; // 清空现有列表
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = chat.conversation_id;
                chatItem.innerHTML = `
                    <div class="chat-actions">
                        <button onclick="event.stopPropagation(); editChatTitle(event, '${chat.conversation_id}', '${chat.title}')" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteChat(event, '${chat.conversation_id}')" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="chat-title">${chat.title || '新对话'}</div>
                `;
                chatItem.onclick = () => loadConversation(chat.title, chat.conversation_id);
                chatList.appendChild(chatItem);
            });
            // addChatListeners();
        }

        // -------------------------------- 笔记管理 --------------------------------
        // TODO 多笔记汇入合并
        
        // 重点 调用后端方法 记笔记
        async function createNote(noteData) {
            try {
                // 发送请求创建笔记
                const response = await fetch('/note/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(noteData)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('笔记创建成功', 'success');
                } else {
                    if (result.error.includes("400 Client Error: Bad Request for url: https://api.notion.com/v1/pages")) {
                        showToast('创建笔记失败: 请检查笔记是否超过 1000 个字符', 'error');
                    } else {
                        showToast('创建笔记失败: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                console.error('创建笔记失败:', error);
                showToast('创建笔记失败', 'error');
            }
        }

        // 选中的文本记笔记
        async function saveSelectionAsNote() {
            try {
                const selectedText = window.getSelection().toString();
                if (selectedText) {
                    const noteData = {
                        title: `${currentChatTitle}`,
                        content: selectedText,
                        source: 'NewsReader',
                        types: ['NOTE'],
                        chats: currentConversationId ? [currentConversationId] : []
                    };

                    // 如果有选中的文章，添加到笔记中
                    const selectedArticles = getSelectedArticles();
                    if (selectedArticles.length > 0) {
                        noteData.articles = selectedArticles;
                    }
                    // 发送请求创建笔记
                    await createNote(noteData);
                }
            } catch (error) {
                showToast('创建笔记失败: ' + error.message, 'error');
            }
        }

        // 保存消息为笔记
        async function saveMessageAsNote(button) {
            try {
                const messageDiv = button.closest('.message');
                const content = messageDiv.querySelector('.message-content').textContent;
                const noteData = {
                    title: `${currentChatTitle}`,
                    content: content,
                    source: 'NewsReader',
                    types: ['NOTE'],
                    chats: currentConversationId ? [currentConversationId] : []
                };
                // 如果有选中的文章，添加到笔记中
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 0) {
                    noteData.articles = selectedArticles;
                }
                await createNote(noteData);
            } catch (error) {
                showToast('创建笔记失败: ' + error.message, 'error');
            }
        }
        
        // 保存对话为笔记
        async function saveChatAsNote() {
            try {
                // 获取当前对话的内容
                const chatMessages = document.querySelectorAll('.message');
                if (!chatMessages.length) {
                    return;
                }
                // 收集对话内容
                let content = '';
                chatMessages.forEach(msg => {
                    const text = msg.querySelector('.message-content').textContent;
                    content += `${text}`;
                });
                // 准备笔记数据
                const noteData = {
                    title: `${currentChatTitle}`,
                    content: content,
                    source: 'NewsReader',
                    types: ['CHAT'],
                    chats: currentConversationId ? [currentConversationId] : []
                };
                // 如果有选中的文章，添加到笔记中
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 0) {
                    noteData.articles = selectedArticles;
                }
                await createNote(noteData);
            } catch (error) {
                showToast('创建笔记失败: ' + error.message, 'error');
            }
        }

        // 保存文章为笔记
        async function saveArtAsNote(btn) {
            // 收集文章内容
            let content = currentArticle.content;
            if (!content) {
                showToast('错误', '未找到文章内容');
                return;
            }
            // 准备笔记数据
            const noteData = {
                types: ['ARTICLE'],
                title: currentArticle.title,
                content: content,
                url: currentArticle.url,
                topics: currentArticle.topics,
                summary: currentArticle.summary
            };
            await createNote(noteData);
        }

        // 新建笔记
        function createNewNote() {
            showToast('笔记功能即将推出', 'info');
        }
    
    </script>
</body>
</html>
