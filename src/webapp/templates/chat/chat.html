<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - NewsReader</title>
	<!-- <link rel="icon" href="https://drive.google.com/file/d/1Vn_00nTR1ID3LK9hvX7zgi6WRND_3SUA/view?usp=drive_link" sizes="256x256" type="image/svg+xml"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script> -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.all.min.css') }}"> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pako.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cache_manager.js') }}"></script>
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <!-- Toast å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="chat-container">
        <!-- å·¦ä¾§æ–‡ç« é¢æ¿ -->
        <div class="articles-panel collapsed">
            <div class="panel-header">
                <div class="toolbar">
                    <input type="text" placeholder="æœç´¢æ–‡ç« ..." class="form-control">
                </div>
                <button class="toggle-panel-btn" onclick="toggleArticlesPanel()">â¡</button>
            </div>
            <div class="panel-content">
                <div id="articleList" class="article-list">
                    <div class="article-list-header">
                        <input type="checkbox" id="selectAll" class="article-checkbox">
                        <label for="selectAll">å…¨é€‰<span id="articleCount"></span></label>
                    </div>
                    <div class="article-items">
                        {% for article in articles %}
                        <div class="article-item">
                            <input type="checkbox" class="article-checkbox" data-article-id="{{ article.id }}">
                            <!-- ç‚¹å‡» è·å–æ–‡ç« è¯¦æƒ… -->
                            <div class="article-title" onclick="fetchArticleDetails('{{ article.id }}')">{{ article.title }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="expandedArticle" style="display: none;">
                    <div class="article-header">
                        <button class="collapse-btn btn btn-sm btn-outline-secondary" onclick="toggleArticleView()">å›åˆ°åˆ—è¡¨</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="addToVecDb(this)" data-article-id="" style="display: none;">åŠ çŸ¥è¯†åº“</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="saveArtAsNote(this)">å­˜Notion</button>
                    </div>
                    <h2 class="article-title" id="expandedArticleTitle"></h2>
                    <div class="source-guide-container">
                        <div class="source-guide-header" onclick="toggleSourceGuide(this)">
                            <h5 class="source-guide-title btn btn-outline-primary">å­¦ä¹ æŒ‡å—</h5>
                            <span class="arrow">â–¶</span>
                        </div>
                        <div class="source-guide-content">
                            <div class="source">
                                <h4>æ¥æº</h4>
                                <div id="expandedArticleSource"></div>
                            </div>
                            <div class="key-topics">
                                <h4>å…³é”®ä¸»é¢˜</h4>
                                <div id="expandedArticleTopics"></div>
                            </div>
                            <div class="tags">
                                <h4>æ ‡ç­¾</h4>
                                <ul id="expandedArticleTags"></ul>
                            </div>
                            <div class="summary">
                                <h4>æ‘˜è¦</h4>
                                <button class="btn btn-sm btn-outline-secondary" onclick="quoteContent('summary')">å¼•ç”¨æ‘˜è¦</button>
                                <div id="expandedArticleSummary"></div>
                            </div>
                        </div>
                    </div>
                    <div class="article-body" id="expandedArticleContent"></div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <div class="chat-toolbar">
                <button class="btn btn-outline-secondary" onclick="createUpdateChat(true)">æ–°å¯¹è¯</button>
                <button class="btn btn-outline-secondary" onclick="saveChatAsNote()">å­˜å¯¹è¯</button>
                <button class="btn btn-outline-secondary" onclick="setApiKey()" title="å†æ¬¡ç‚¹å‡»ä¿å­˜">KEY</button>
                <input type="password" id="api_key" class="form-control api-key" data-model="" placeholder="è¾“å…¥API Key..." style="display: none;">
                <div class="choice-radio">
                    <!-- æ¨¡å‹ -->
                    <select name="llm_choice" id="llm_choice" onchange="handleModelChange()">
                        <option value='gemini-2.0-flash-exp' data-provider="google">Gemini</option>
                        <option value='gemini-exp-1206' data-provider="google">G1206</option>
                        <option value='minimax-text-01' data-provider="minimax">abab65</option>
                        <option value='gpt-4o-mini' data-provider="openai">4omini</option>
                    </select>
                    <!-- æœ€å¤§æŸ¥è¯¢URLæ•°é‡ -->
                    <!-- <label for="keep_urls" value="Max Recall URL">URLs</label> -->
                    <select name="keep_urls" id="keep_urls" hidden="true">
                        <option value=5>5URL</option>
                        <option value=10>10</option>
                        <option value=20>20</option>
                     </select>
                     <!-- é»˜è®¤å…³é—­RAG -->
                     <!-- <label for="rag_func" value="Is RAG Func">RAG</label> -->
                     <select name="rag_func" id="rag_func">
                        <option value=0>OFF</option>
                        <option value=1>RAG</option>
                     </select>
                     <!-- RAGå¬å›æ•°é‡ -->
                     <!-- <label for="recall_num" value="RAG Recall Number">REF</label> -->
                     <select name="recall_num" id="recall_num" hidden="true">
                        <option value=20>20</option>
                        <option value=6>6</option>
                        <option value=10>10</option>
                     </select>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="chat-input-area">
                <textarea id="messageInput" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                <button class="btn btn-primary" onclick="sendChatMessage()">å¯¹è¯</button>
                <button class="btn btn-outline-secondary" onclick="uploadFile()">æ–‡ä»¶</button>
                <button class="btn btn-outline-secondary" onclick="startRecording()">è¯­éŸ³</button>
                <input type="file" id="fileInput" accept="image/*,text/*,video/*,audio/*,application/pdf" multiple style="display: none;">
            </div>
        </div>

        <!-- å³ä¾§ç¬”è®°åŒºåŸŸ -->
        <div class="right-panel">
            <div class="panel-header">
                <button class="toggle-panel-btn" onclick="toggleRightPanel()">â¡</button>
                <div class="toolbar">
                    <input type="text" placeholder="æœç´¢å¯¹è¯..." class="form-control">
                </div>
            </div>
            <div class="panel-content">
                <div class="chat-list" id="chatList">
                    <!-- å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
                <div class="note-list">
                    <div class="note-item">
                        <div class="toolbar">
                            <input type="text" placeholder="æœç´¢ç¬”è®°..." class="form-control">
                        </div>
                        <button class="btn btn-outline-secondary" onclick="createNewNote()">æ–°å»ºç¬”è®°</button>
                        <div class="note-title">ç¬”è®°æ ‡é¢˜</div>
                        <div class="note-content">ç¬”è®°å†…å®¹</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®åŠ¨å¼•ç”¨æŒ‰é’® -->
    <div id="floatQuoteBtn" class="float-quote-btn">
        <button class="btn btn-sm btn-outline-secondary" onclick="quoteSelection()">
            <i class="fas fa-quote-right"></i> ç»§ç»­å¼•ç”¨
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="saveSelectionAsNote()">
            <i class="fas fa-sticky-note"></i> è®°ç¬”è®°
        </button>
    </div>

    <!-- ç¼“å­˜ç»Ÿè®¡æŒ‰é’® -->
    <button id="showCacheStats" class="btn btn-sm btn-info" style="position: fixed; bottom: 20px; right: 20px;">
        <i class="fas fa-chart-bar"></i> ç¼“å­˜ç»Ÿè®¡
    </button>

    <!-- ç¼“å­˜ç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="cacheStatsModal" tabindex="-1" role="dialog" aria-labelledby="cacheStatsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cacheStatsModalLabel">ç¼“å­˜ä½¿ç”¨ç»Ÿè®¡</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="cache-stats">
                        <div class="progress mb-3">
                            <div id="cacheUsageBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p>ç¼“å­˜é¡¹æ•°é‡: <span id="itemCount">0</span></p>
                        <p>å½“å‰ä½¿ç”¨: <span id="currentSize">0</span> MB</p>
                        <p>æœ€å¤§å®¹é‡: <span id="maxSize">0</span> MB</p>
                        <p>ä½¿ç”¨ç‡: <span id="usagePercentage">0</span>%</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="clearCacheAndUpdate()">æ¸…ç©ºç¼“å­˜</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // -------------------------------- é€šç”¨æ–¹æ³• --------------------------------
        // é‡ç‚¹ é€šç”¨çš„é˜²æŠ–å‡½æ•°
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            }
        }

        // æ–‡ç« æœç´¢çš„é˜²æŠ–å¤„ç†
        const debouncedSearchArticles = debounce(async (query) => {
            try {
                const response = await fetch(`/chat/api/articles/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('æœç´¢å¤±è´¥');
                const result = await response.json();
                updateArticlesList(result.data.articles);
            } catch (error) {
                showToast('æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }, 300);

        // å¯¹è¯æœç´¢çš„é˜²æŠ–å¤„ç†
        const debouncedSearchChats = debounce(async (query) => {
            try {
                const response = await fetch(`/chat/api/conversations/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('æœç´¢å¤±è´¥');
                const chats = await response.json();
                updateChatList(chats);
                // addChatListeners();
            } catch (error) {
                showToast('æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }, 300);

        // ç›‘å¬æ–‡ç« æœç´¢è¾“å…¥
        document.querySelector('.articles-panel .toolbar input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                debouncedSearchArticles(query);
            } else {
                debouncedSearchArticles(''); // å½“æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼ŒåŠ è½½æ‰€æœ‰æ–‡ç« 
            }
        });

        // ç›‘å¬å¯¹è¯æœç´¢è¾“å…¥
        document.querySelector('.right-panel .toolbar input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                debouncedSearchChats(query);
            } else {
                debouncedSearchChats(''); // å½“æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼ŒåŠ è½½æ‰€æœ‰å¯¹è¯
            }
        });

        // å¼•ç”¨æ¶ˆæ¯
        function quoteMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content').innerText;
            const messageInput = document.getElementById('messageInput');
            messageInput.value = `${contentDiv}\n---------------\n`;
            messageInput.focus();
        }

        // å¼•ç”¨æ–‡ç« æ‘˜è¦
        function quoteContent(type) {
            const messageInput = document.getElementById('messageInput');
            if (type === 'full') {
                // const title = document.getElementById('expandedArticleTitle').innerText;
                const source = document.getElementById('expandedArticleContent').innerText;
                // messageInput.value = `${title}\n${source}\n---------------\n`;
                messageInput.value = `${source}\n---------------\n`;
            } else if (type === 'summary') {
                const summary = document.getElementById('expandedArticleSummary').innerText;
                messageInput.value = `${summary}\n---------------\n`;
            }
            messageInput.focus();
        }
        
        // å¼•ç”¨é€‰ä¸­çš„æ–‡æœ¬
        function quoteSelection() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (text) {
                const messageInput = document.getElementById('messageInput');
                // += å…è®¸å¤šæ®µå¼•ç”¨
                messageInput.value += `${text}\n---------------\n`;
                messageInput.focus();
                // éšè—æµ®åŠ¨æŒ‰é’®
                document.getElementById('floatQuoteBtn').style.display = 'none';
            }
        }
    
        // å¤„ç†é€‰ä¸­æ–‡æœ¬çš„å¼•ç”¨åŠŸèƒ½
        document.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            const floatBtn = document.getElementById('floatQuoteBtn');
            
            if (selection.toString().trim().length > 0) {
                // è·å–é€‰ä¸­æ–‡æœ¬çš„ä½ç½®
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // è®¾ç½®æµ®åŠ¨æŒ‰é’®ä½ç½®
                floatBtn.style.left = `${rect.left + window.scrollX}px`;
                floatBtn.style.top = `${rect.bottom + window.scrollY + 5}px`;
                floatBtn.style.display = 'block';
            } else {
                floatBtn.style.display = 'none';
            }
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—æµ®åŠ¨æŒ‰é’®
        document.addEventListener('mousedown', function(e) {
            if (!e.target.closest('#floatQuoteBtn')) {
                document.getElementById('floatQuoteBtn').style.display = 'none';
            }
        });

        // é‡ç‚¹ Toast æç¤ºåŠŸèƒ½ 
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('#toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }

        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            if (!text || text === '') {
                showToast('è¯·è¾“å…¥æ¶ˆæ¯', 'warning');
                return;
            }

            // ç»„åˆæ–‡å­—å’Œæ–‡ä»¶é¢„è§ˆHTML
            let content = `<p>${text}</p>`;
            
            // å¤„ç†æ‰€æœ‰æ–‡ä»¶é¢„è§ˆ
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    // å›¾ç‰‡é¢„è§ˆ
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        content += `<img src="${e.target.result}" style="max-width: 500px;"><br>`;
                        // æ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œåï¼Œæ˜¾ç¤ºå¹¶å‘é€
                        if (Array.from(files).indexOf(file) === files.length - 1) {
                            // ä½¿ç”¨åŸæœ‰çš„addUserMessageToChatæ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
                            addUserMessageToChat(content);
                            try {
                                // ä¿å­˜æ¶ˆæ¯æ–‡æœ¬ï¼Œè¿™æ ·sendChatMessageå¯ä»¥è¯»å–åˆ°
                                const savedText = text;
                                // å‘é€åˆ°åç«¯ï¼Œç›´æ¥ä¼ å…¥åŸå§‹çš„fileså¯¹è±¡
                                await sendChatMessage(files, savedText);
                            } catch (error) {
                                console.error('Upload error:', error);
                                showToast(error.message || 'ä¸Šä¼ å¤±è´¥', 'error');
                            }
                        }
                    }
                    reader.readAsDataURL(file);
                } else {
                    // éå›¾ç‰‡æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶åå’Œç±»å‹
                    content += `<p>ğŸ“ ${file.name} (${file.type || 'æœªçŸ¥ç±»å‹'})</p>`;
                    // å¦‚æœæ˜¯æœ€åä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¾ç¤ºå¹¶å‘é€
                    if (Array.from(files).indexOf(file) === files.length - 1) {
                        // ä½¿ç”¨åŸæœ‰çš„addUserMessageToChatæ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
                        addUserMessageToChat(content);
                        try {
                            // ä¿å­˜æ¶ˆæ¯æ–‡æœ¬ï¼Œè¿™æ ·sendChatMessageå¯ä»¥è¯»å–åˆ°
                            const savedText = text;
                            // å‘é€åˆ°åç«¯ï¼Œç›´æ¥ä¼ å…¥åŸå§‹çš„fileså¯¹è±¡
                            await sendChatMessage(files, savedText);
                        } catch (error) {
                            console.error('Upload error:', error);
                            showToast(error.message || 'ä¸Šä¼ å¤±è´¥', 'error');
                        }
                    }
                }
            }
        });

        // å½•éŸ³åŠŸèƒ½ï¼ˆå¾…å®ç°ï¼‰
        function startRecording() {
            showToast('å½•éŸ³åŠŸèƒ½å³å°†æ¨å‡º', 'info');
        }

        // è®¾ç½®API keyçš„å‡½æ•°
        function setApiKey() {
            const apiKeyInput = document.getElementById('api_key');
            const currentModel = document.getElementById('llm_choice').value;
            const provider = document.querySelector(`option[value='${currentModel}']`).dataset.provider;
            const providerNames = {
                'google': 'Google',
                'openai': 'OpenAI',
                'minimax': 'MiniMax'
            };
            const providerName = providerNames[provider] || provider.toUpperCase();
            
            if (apiKeyInput.style.display === 'none') {
                // æ˜¾ç¤ºè¾“å…¥æ¡†
                apiKeyInput.style.display = 'inline-block';
                apiKeyInput.dataset.model = provider;
                apiKeyInput.placeholder = `è¯·è¾“å…¥${providerName}çš„API Key`;
                // åŠ è½½å·²ä¿å­˜çš„key
                const savedKey = getCookie(`${provider}_api_key`);
                if (savedKey) {
                    apiKeyInput.value = savedKey;
                }
                apiKeyInput.focus();
            } else {
                // ä¿å­˜å¹¶éšè—è¾“å…¥æ¡†
                const apiKey = apiKeyInput.value.trim();
                const currentProvider = apiKeyInput.dataset.model;
                const currentProviderName = providerNames[currentProvider] || currentProvider.toUpperCase();
                if (apiKey) {
                    setCookie(`${currentProvider}_api_key`, apiKey, 30);
                    showToast(`${currentProviderName}çš„API Keyå·²ä¿å­˜`, 'success');
                }
                apiKeyInput.style.display = 'none';
                apiKeyInput.value = '';
                apiKeyInput.dataset.model = '';
            }
        }

        // é‡ç‚¹ å¤„ç†æ¨¡å‹åˆ‡æ¢
        function handleModelChange() {
            const apiKeyInput = document.getElementById('api_key');
            const currentModel = document.getElementById('llm_choice').value;
            const provider = document.querySelector(`option[value='${currentModel}']`).dataset.provider;
            const providerNames = {
                'google': 'Google',
                'openai': 'OpenAI',
                'minimax': 'MiniMax'
            };
            const providerName = providerNames[provider] || provider.toUpperCase();
            
            // å¦‚æœè¾“å…¥æ¡†æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œæ›´æ–°å…¶å±æ€§
            if (apiKeyInput.style.display === 'inline-block') {
                apiKeyInput.dataset.model = provider;
                apiKeyInput.placeholder = `è¯·è¾“å…¥${providerName}çš„API Key`;
                // åŠ è½½å·²ä¿å­˜çš„key
                const savedKey = getCookie(`${provider}_api_key`);
                apiKeyInput.value = savedKey || '';
            }
        }

        // è·å–å½“å‰é€‰ä¸­æ¨¡å‹çš„API key
        function getCurrentApiKey() {
            const currentModel = document.getElementById('llm_choice').value;
            const provider = document.querySelector(`option[value='${currentModel}']`).dataset.provider;
            return getCookie(`${provider}_api_key`);
        }

        // é‡ç‚¹ Cookieæ“ä½œå‡½æ•°
        function setCookie(name, value, days) {
            let expires = '';
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = '; expires=' + date.toUTCString();
            }
            document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(c.substring(nameEQ.length, c.length));
                }
            }
            return null;
        }

        // é‡ç‚¹ ç¼“å­˜ç®¡ç†å™¨ cache_manager.js
        const chatCache = new CacheManager({
            ttl: {{ config.CHAT_CACHE_TTL }},
            maxSize: {{ config.CHAT_CACHE_MAX_SIZE }},
            storageKey: 'chat_cache',
            compression: true
        });

        // æ›´æ–°ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
        function updateCacheStats() {
            const stats = chatCache.getStats();
            document.getElementById('itemCount').textContent = stats.itemCount;
            document.getElementById('currentSize').textContent = (stats.currentSize / (1024 * 1024)).toFixed(2);
            document.getElementById('maxSize').textContent = (stats.maxSize / (1024 * 1024)).toFixed(2);
            document.getElementById('usagePercentage').textContent = stats.usagePercentage.toFixed(1);
            
            const progressBar = document.getElementById('cacheUsageBar');
            progressBar.style.width = `${stats.usagePercentage}%`;
            progressBar.setAttribute('aria-valuenow', stats.usagePercentage);
            progressBar.className = `progress-bar ${stats.usagePercentage > 80 ? 'bg-danger' : 'bg-info'}`;
            // console.log('updateCacheStats')
        }

        // æ¸…ç©ºç¼“å­˜å¹¶æ›´æ–°ç»Ÿè®¡
        function clearCacheAndUpdate() {
            chatCache.clearAndUpdateStats(updateCacheStats);
            showToast('ç¼“å­˜å·²æ¸…ç©º', 'success');
        }

        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('showCacheStats').addEventListener('click', () => {
            updateCacheStats();
            $('#cacheStatsModal').modal('show');
        });

        // ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        $('#cacheStatsModal').on('hidden.bs.modal', function () {
            // æ¸…ç†ä¸éœ€è¦çš„å±æ€§
            $(this).find('.modal-backdrop').remove();
        });

        // -------------------------------- æ–‡ç« ç®¡ç† --------------------------------
        let isExpanded = false;
        let currentArticleId = null;
        let currentArticle = '';

        // å·¦ä¾§æ–‡ç« åŒº é¢æ¿å±•å¼€/æ”¶èµ· é»˜è®¤æ”¶èµ·
        function toggleArticlesPanel() {
            const panel = document.querySelector('.articles-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                button.textContent = 'â¬…';
            } else {
                panel.classList.add('collapsed');
                button.textContent = 'â¡';
            }
        }

        // å³ä¾§ç¬”è®°åŒº é¢æ¿å±•å¼€/æ”¶èµ· é»˜è®¤å±•å¼€
        function toggleRightPanel() {
            const panel = document.querySelector('.right-panel');
            const button = panel.querySelector('.toggle-panel-btn');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                button.textContent = 'â¡';
            } else {
                panel.classList.add('collapsed');
                button.textContent = 'â¬…';
            }
        }

        // åˆ‡æ¢æ–‡ç« åˆ—è¡¨å’Œè¯¦æƒ…æ˜¾ç¤º
        function toggleArticleView(showDetail = false) {
            const articleList = document.getElementById('articleList');
            const expandedArticle = document.getElementById('expandedArticle');
            
            if (showDetail) {
                articleList.style.display = 'none';
                expandedArticle.style.display = 'block';
            } else {
                articleList.style.display = 'block';
                expandedArticle.style.display = 'none';
            }
        }

        // æ–‡ç« æ¦‚è¦ ä¸Šä¸‹å±•å¼€/æ”¶èµ·
        function toggleSourceGuide(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('expanded');
            
            // æ›´æ–°ç®­å¤´æ–¹å‘
            const arrow = element.querySelector('.arrow');
            if (content.classList.contains('expanded')) {
                arrow.textContent = 'â–¼';
            } else {
                arrow.textContent = 'â–¶';
            }
        }

        // é‡ç‚¹ æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨
        function showArticleList() {
            document.querySelector('.article-list').style.display = 'block';
            document.getElementById('expandedArticle').style.display = 'none';
        }

        // éšè—æ–‡ç« åˆ—è¡¨
        function hideArticleList() {
            document.querySelector('.article-list').style.display = 'none';
            document.getElementById('expandedArticle').style.display = 'block';
        }

        // ä¸Šä¼ æ–‡ä»¶å æ˜¾ç¤ºæ–‡ç« 
        function showArticleInfo(article) {
            // åœ¨æ–‡ç« é¢æ¿ä¸­æ˜¾ç¤ºæ–°æ·»åŠ çš„æ–‡ç« 
            const articlePanel = document.querySelector('.articles-panel');
            if (articlePanel && !articlePanel.classList.contains('collapsed')) {
                // å¦‚æœæ–‡ç« é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°æ–‡ç« åˆ—è¡¨
                showArticleList();
            }
        }

        // æ˜¾ç¤ºæ–‡ç« å†…å®¹
        function displayArticleContent(article) {
            const articleList = document.getElementById('articleList');

            const expandedArticle = document.getElementById('expandedArticle');
            const title = document.getElementById('expandedArticleTitle');
            const content = document.getElementById('expandedArticleContent');
            const summary = document.getElementById('expandedArticleSummary');
            const topics = document.getElementById('expandedArticleTopics');
            const tags = document.getElementById('expandedArticleTags');
            const source = document.getElementById('expandedArticleSource');
            
            // éšè—æ–‡ç« åˆ—è¡¨
            articleList.style.display = 'none';
            // æ˜¾ç¤ºæ–‡ç« è¯¦æƒ…
            expandedArticle.style.display = 'block';
            // è®¾ç½®æ–‡ç« å†…å®¹
            title.textContent = article.title || '';
            // ä½¿ç”¨showdownè½¬æ¢Markdownä¸ºHTML
            const converter = new showdown.Converter();
            try {
                content.innerHTML = article.content ? converter.makeHtml(article.content) : '';
                summary.innerHTML = article.summary ? converter.makeHtml(article.summary) : '';
                const topicsHtml = article.topics ? converter.makeHtml(article.topics.map(topic => `- ${topic}`).join('\n')) : '';
                topics.innerHTML = topicsHtml;
            } catch (error) {
                content.innerHTML = article.content || '';
                summary.innerHTML = article.summary || '';
                topics.innerHTML = article.topics ? article.topics.map(topic => `- ${topic}`).join('\n') : '';
            }
            tags.innerHTML = article.tags || '';
            source.innerHTML = article.source ? `- ${article.source}` : '';
        }

        // é‡ç‚¹ è·å–æ–‡ç« è¯¦æƒ…
        let isFetchingArticle = false;
        async function fetchArticleDetails(articleId) {
            if (isFetchingArticle) {
                showToast('æ­£åœ¨è·å–æ–‡ç« æ•°æ®ï¼Œè¯·ç¨ç­‰', 'info');
                return;
            }
            try {
                isFetchingArticle = true;
                // å°è¯•ä»ç¼“å­˜è·å–æ–‡ç« 
                const cachedArticle = chatCache.get(`article_${articleId}`);
                let article;
                if (cachedArticle) {
                    article = cachedArticle;
                } else {
                    // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™ä»æœåŠ¡å™¨è·å–
                    const response = await fetch(`/chat/api/articles/${articleId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch article details');
                    }
                    article = await response.json();
                    // å­˜å…¥ç¼“å­˜ï¼Œæ–‡ç« ç¼“å­˜æ—¶é—´è®¾ç½®ä¸º24å°æ—¶
                    chatCache.set(`article_${articleId}`, article, { 
                        ttl: 2592000,  // 30å¤©
                        type: 'json' 
                    });
                }
                // åŠ å…¥å‘é‡åº“ï¼ˆçŸ¥è¯†åº“ï¼‰
                const addVecBtn = document.querySelector('#expandedArticle .article-header button[onclick^="addToVecDb"]');
                if (addVecBtn) {
                    // å¦‚æœå·²ç»åŠ å…¥çŸ¥è¯†åº“ï¼ˆvector_idsä¸ä¸ºç©ºï¼‰ï¼Œåˆ™éšè—æŒ‰é’®
                    if (article.data.article.vector_ids) {
                        addVecBtn.style.display = 'none';
                    } else {
                        addVecBtn.style.display = 'inline-block';
                        addVecBtn.setAttribute('data-article-id', articleId);
                    }
                }
                // å¦‚æœç‚¹å‡»çš„æ˜¯åŒä¸€ç¯‡æ–‡ç« ï¼Œåˆ‡æ¢å±•å¼€çŠ¶æ€
                if (currentArticleId === articleId) {
                    if (document.getElementById('articleList').style.display === 'none') {
                        // å¦‚æœå½“å‰åœ¨è¯¦æƒ…é¡µï¼Œåˆ‡æ¢å›åˆ—è¡¨
                        toggleArticleView(false);
                    } else {
                        // å¦‚æœå½“å‰åœ¨åˆ—è¡¨é¡µï¼Œæ˜¾ç¤ºè¯¦æƒ…
                        displayArticleContent(article.data.article);
                        toggleArticleView(true);
                    }
                } else {
                    // å¦‚æœæ˜¯æ–°æ–‡ç« ï¼Œå±•ç¤ºå†…å®¹å¹¶å±•å¼€é¢æ¿
                    currentArticleId = articleId;
                    displayArticleContent(article.data.article);
                    toggleArticleView(true);
                    currentArticle = article.data.article;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showToast('æŸ¥çœ‹æ–‡ç« å¤±è´¥', 'error');
            } finally {
                isFetchingArticle = false;
            }
        }
        
        // æ–‡ç« åŠ çŸ¥è¯†åº“
        function addToVecDb(btn) {
            const articleId = btn.getAttribute('data-article-id');
            if (!articleId) {
                showToast('é”™è¯¯', 'æœªæ‰¾åˆ°æ–‡ç« ');
                return;
            }
            fetch('/article/vector_article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `article_ids=${articleId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('æˆåŠŸ', 'å·²å¼€å§‹æ·»åŠ åˆ°çŸ¥è¯†åº“');
                    // ç›´æ¥éšè—æŒ‰é’®
                    btn.style.display = 'none';
                } else {
                    showToast('é”™è¯¯', data.message || 'æ·»åŠ å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('é”™è¯¯', 'æ·»åŠ å¤±è´¥');
            });
        }
    
        // æœç´¢å æ›´æ–°æ–‡ç« åˆ—è¡¨
        function updateArticlesList(articles) {
            const articleList = document.querySelector('.article-items');
            articleList.innerHTML = articles.map(article => `
                <div class="article-item">
                    <input type="checkbox" class="article-checkbox" data-article-id="${article.id}">
                    <div class="article-title" onclick="fetchArticleDetails(${article.id})">${article.title}</div>
                </div>
            `).join('');
            document.getElementById('articleCount').textContent = articles.length ? ` ${articles.length}ç¯‡` : '';
            // é‡æ–°ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            document.querySelectorAll('.article-items .article-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¤é€‰æ¡†éƒ½è¢«é€‰ä¸­
                    const allCheckboxes = document.querySelectorAll('.article-items .article-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    document.getElementById('selectAll').checked = allChecked;
                });
            });
        }

        // æ–‡ç« åˆ—è¡¨å…¨é€‰åŠŸèƒ½
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.article-items .article-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // è·å–é€‰ä¸­çš„æ–‡ç« IDåˆ—è¡¨
        function getSelectedArticles() {
            const checkboxes = document.querySelectorAll('.article-items .article-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.articleId);
        }

        // æ›´æ–°æ–‡ç« é€‰æ‹©çŠ¶æ€
        document.querySelectorAll('.article-items .article-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¤é€‰æ¡†éƒ½è¢«é€‰ä¸­
                const allCheckboxes = document.querySelectorAll('.article-items .article-checkbox');
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                document.getElementById('selectAll').checked = allChecked;
            });
        });

        // -------------------------------- èŠå¤©æ¶ˆæ¯ç®¡ç† --------------------------------

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addUserMessageToChat(content) {
            const messageIndex = document.querySelectorAll('.message').length;
            addMessageToChat('user', content, messageIndex);
        }

        // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addAssistantMessageToChat(content) {
            // ç§»é™¤æ‰€æœ‰"æ€è€ƒä¸­..."çš„ä¸´æ—¶æ¶ˆæ¯
            const tempMessages = document.querySelectorAll('.message.assistant.thinking');
            tempMessages.forEach(msg => msg.remove());
            
            // æ·»åŠ å®é™…çš„åŠ©æ‰‹æ¶ˆæ¯
            const messageIndex = document.querySelectorAll('.message').length;
            addMessageToChat('assistant', content, messageIndex);
        }

        // æ·»åŠ æ€è€ƒä¸­çš„ä¸´æ—¶æ¶ˆæ¯
        function addThinkingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant thinking';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>GEMI:</strong>
                    <p>æ€è€ƒä¸­...</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        // é‡ç‚¹ å¯¹è¯èŠå¤© æ¯æ¬¡èŠå¤©ç”Ÿæˆå¯¹è¯æˆ–æ›´æ–°å¯¹è¯
        async function sendChatMessage(files = null, savedText = null) {
            const sendButton = document.querySelector('#chatMessages ~ .chat-input-area > .btn.btn-primary');
            try {
                const messageInput = document.getElementById('messageInput');
                const message = savedText || messageInput.value.trim();
                
                // å¦‚æœæ²¡æœ‰æ–‡ä»¶ä¸”æ²¡æœ‰æ¶ˆæ¯ï¼Œä¸æ‰§è¡Œ
                if (!files && message === '') {
                    showToast('è¯·è¾“å…¥æ¶ˆæ¯', 'warning');
                    return;
                }

                // ç¦ç”¨å‘é€æŒ‰é’®
                sendButton.disabled = true;
                // è·å–é€‰ä¸­çš„æ–‡ç« ID
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 10) {
                    showToast('æœ€å¤šé€‰æ‹©10ç¯‡æ–‡ç« ', 'error');
                    return;
                }
                
                // åªæœ‰åœ¨éæ–‡ä»¶ä¸Šä¼ æ—¶æ‰æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                if (!files) {
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
                    addUserMessageToChat(message);
                }
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                
                // æ·»åŠ æ€è€ƒä¸­çš„ä¸´æ—¶æ¶ˆæ¯
                const thinkingMessageIndex = addThinkingMessage();
                
                // è·å–æˆ–åˆ›å»ºå¯¹è¯ID
                const conv_id = await createUpdateChat();
                console.log('Conversation ID:', conv_id);
                
                // å¤„ç†æ–‡ä»¶åˆ—è¡¨
                let fileArray = [];
                if (files && files instanceof FileList) {
                    fileArray = Array.from(files);
                }
                
                // è°ƒç”¨chatæœåŠ¡
                let result = await call_chat(conv_id, message, selectedArticles, fileArray);
                if (result.success) {
                    if (result.data && result.data.response) {
                        addAssistantMessageToChat(result.data.response);
                        // ä½¿å½“å‰å¯¹è¯çš„ç¼“å­˜å¤±æ•ˆ
                        chatCache.deleteAndUpdateStats(`conv_${conv_id}`, updateCacheStats);
                    } else {
                        showToast('å“åº”æ ¼å¼é”™è¯¯', 'error');
                    }
                } else {
                    showToast(result.message || 'å¯¹è¯å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Chat error:', error);
                showToast(error.message || 'å¯¹è¯å¤±è´¥', 'error');
            } finally {
                // ç§»é™¤æ€è€ƒä¸­çš„ä¸´æ—¶æ¶ˆæ¯
                const thinkingMessage = document.querySelector('.thinking-message');
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                // æ¢å¤å‘é€æŒ‰é’®
                if (sendButton) {
                    sendButton.disabled = false;
                }
            }
        }

        // sendChatMessage è°ƒç”¨åç«¯chatæœåŠ¡
        async function call_chat(conv_id, message, selectedArticles = [], files = []) {
            try {
                if (conv_id == undefined || conv_id == null || conv_id == '') {
                   throw new Error('è¯·ç¨åå†è¯•');
                }
                // æ„å»ºè¯·æ±‚æ•°æ®
                const formData = new FormData();
                formData.append('conversation_id', conv_id);
                formData.append('message', message);
                formData.append('model', document.getElementById('llm_choice').value);
                formData.append('keep_urls', document.getElementById('keep_urls').value);
                formData.append('rag_func', document.getElementById('rag_func').value);
                formData.append('recall_num', document.getElementById('recall_num').value);
                
                // è·å–å½“å‰æ¨¡å‹å¯¹åº”çš„API key
                const apiKey = getCurrentApiKey();
                if (apiKey) {
                    formData.append('api_key', apiKey);
                }
                
                // æ·»åŠ é€‰ä¸­çš„æ–‡ç« ID
                formData.append('article_ids', getSelectedArticles().join(','));
                
                // æ·»åŠ æ–‡ä»¶ï¼Œä½¿ç”¨ç›¸åŒçš„å­—æ®µåfiles
                if (files && files.length > 0) {
                    Array.from(files).forEach(file => {
                        formData.append('files', file);
                    });
                }
                // è°ƒç”¨chatæœåŠ¡
                const response = await fetch('/chat/api/chat', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`æœåŠ¡å“åº”ï¼š(${error.message || 'æœªçŸ¥é”™è¯¯'})`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Chat error:', error);
                throw error;  // ç»§ç»­æŠ›å‡ºé”™è¯¯ï¼Œè®©ä¸Šå±‚å‡½æ•°å¤„ç†
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessageToChat(role, content, messageIndex = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            if (messageIndex !== null) {
                messageDiv.dataset.messageIndex = messageIndex;
            }
            
            // å¤„ç†å¯èƒ½çš„HTMLå†…å®¹
            let htmlContent = content;
            if (typeof content === 'string') {
                if (role === 'assistant') {
                    // å¯¹åŠ©æ‰‹çš„å›ç­”ä½¿ç”¨markdownè½¬æ¢
                    const converter = new showdown.Converter();
                    try {
                        htmlContent = converter.makeHtml(content); 
                    } catch (error) {
                        htmlContent = content;
                    }
                } else {
                    // ç”¨æˆ·æ¶ˆæ¯åªè½¬æ¢æ¢è¡Œç¬¦
                    htmlContent = content.replace(/\n/g, '<br>');
                }
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    <strong>${role === 'user' ? 'ä½ ' : 'GEMI'}:</strong>
                    <div class="content">${htmlContent}</div>
                </div>
            `;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            // ä¿å­˜ç¬”è®°æŒ‰é’®
            const saveNoteButton = document.createElement('button');
            saveNoteButton.className = 'action-btn save-note';
            saveNoteButton.title = 'åŠ å…¥ç¬”è®°';
            saveNoteButton.innerHTML = '<i class="fas fa-sticky-note"></i>';
            saveNoteButton.onclick = function() { saveMessageAsNote(this); };
            actionsDiv.appendChild(saveNoteButton);

            // ç¼–è¾‘æŒ‰é’®
            const editButton = document.createElement('button');
            editButton.className = 'action-btn edit';
            editButton.title = 'ç¼–è¾‘';
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.onclick = function() { editMessage(this); };
            actionsDiv.appendChild(editButton);

            // åˆ é™¤æŒ‰é’®
            const deleteButton = document.createElement('button');
            deleteButton.className = 'action-btn delete';
            deleteButton.title = 'åˆ é™¤';
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.onclick = function() { deleteMessage(this); };
            actionsDiv.appendChild(deleteButton);

            // å¼•ç”¨æŒ‰é’®
            const quoteButton = document.createElement('button');
            quoteButton.className = 'action-btn quote';
            quoteButton.title = 'å¼•ç”¨';
            quoteButton.innerHTML = '<i class="fas fa-quote-right"></i>';
            quoteButton.onclick = function() { quoteMessage(this); };
            actionsDiv.appendChild(quoteButton);

            // å¤åˆ¶æŒ‰é’®
            const copyButton = document.createElement('button');
            copyButton.className = 'action-btn copy';
            copyButton.title = 'å¤åˆ¶';
            copyButton.innerHTML = '<i class="fas fa-copy"></i>';
            copyButton.onclick = function() { copyMessage(this); };
            actionsDiv.appendChild(copyButton);

            messageDiv.appendChild(actionsDiv);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // å¤åˆ¶æ¶ˆæ¯å†…å®¹
        function copyMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content');
            const content = contentDiv ? contentDiv.textContent : '';
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            try {
                // é€‰æ‹©æ–‡æœ¬å¹¶å°è¯•å¤åˆ¶
                textarea.select();
                const success = document.execCommand('copy');
                if (success) {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    // å¦‚æœexecCommandå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(content)
                            .then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
                            .catch(err => {
                                console.error('å¤åˆ¶å¤±è´¥:', err);
                                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                            });
                    } else {
                        throw new Error('ä¸æ”¯æŒå¤åˆ¶åŠŸèƒ½');
                    }
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // æ¸…ç†ä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
                document.body.removeChild(textarea);
            }
        }

        // åˆ é™¤èŠå¤©æ¶ˆæ¯ å¯¹è¯ä¸­çš„ä¸€æ®µæ¶ˆæ¯ å¯¹è¯èŠå¤©
        async function deleteMessage(button) {
            event.stopPropagation();
            const messageDiv = button.closest('.message');
            const messageIndex = messageDiv.getAttribute('data-message-index');
            const conversationId = currentConversationId;
            if (!messageIndex || !conversationId) {
                console.error('æ— æ³•è·å–æ¶ˆæ¯ç´¢å¼•');
                showToast('æ— æ³•è·å–æ¶ˆæ¯ç´¢å¼•', 'error');
                return;
            }
            try { // delete_message
                const response = await fetch('/chat/api/msg/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        message_index: messageIndex
                    })
                });
                const result = await response.json();
                if (result.success) {
                    messageDiv.remove();
                    // é‡æ–°ç¼–åˆ¶ç´¢å¼•
                    const messages = document.querySelectorAll('.chat-messages .message');
                    messages.forEach((msg, idx) => {
                        msg.setAttribute('data-message-index', idx);
                    });
                    // å¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯ï¼Œå¯ç”¨å‘é€æŒ‰é’®
                    const lastMessage = document.querySelector('.chat-messages .message:last-child');
                    if (!lastMessage || lastMessage.classList.contains('user')) {
                        document.querySelector('.chat-input-area button.btn-primary').disabled = false;
                    }
                    chatCache.deleteAndUpdateStats(`conv_${conversationId}`, updateCacheStats);
                    showToast('æ¶ˆæ¯å·²åˆ é™¤', 'success');
                } else {
                    showToast(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // ç¼–è¾‘èŠå¤©æ¶ˆæ¯ å¯¹è¯ä¸­çš„ä¸€æ®µæ¶ˆæ¯ å¯¹è¯èŠå¤©
        function editMessage(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.content');
            const originalContent = contentDiv.innerHTML;
            const messageIndex = messageDiv.getAttribute('data-message-index');
            const conversationId = currentConversationId;
            let isSaving = false;  // æ·»åŠ ä¿å­˜çŠ¶æ€æ ‡è®°
            
            if (!messageIndex || !conversationId) {
                console.error('æ— æ³•è·å–æ¶ˆæ¯ç´¢å¼•');
                showToast('æ— æ³•è·å–æ¶ˆæ¯ç´¢å¼•', 'error');
                return;
            }

            // åˆ›å»ºç¼–è¾‘æ¡†
            const textarea = document.createElement('textarea');
            textarea.value = originalContent;
            textarea.style.width = '100%';
            textarea.style.minHeight = '100px';
            
            contentDiv.innerHTML = '';
            contentDiv.appendChild(textarea);
            textarea.focus();

            // ä¿å­˜ç¼–è¾‘
            async function saveEdit() {
                const newContent = textarea.value; // ä¿®å¤æ¢è¡Œç¬¦æ›¿æ¢
                if (newContent && newContent !== originalContent) {
                    isSaving = true;  // å¼€å§‹ä¿å­˜
                    try { // edit_chat_msg
                        const response = await fetch('/chat/api/msg/edit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                conversation_id: conversationId,
                                message_index: messageIndex,
                                content: newContent,
                                role: messageDiv.classList.contains('user') ? 'user' : 'assistant'
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            contentDiv.innerHTML = newContent; // ä¿®å¤æ¢è¡Œç¬¦æ›¿æ¢
                            chatCache.deleteAndUpdateStats(`conv_${conversationId}`, updateCacheStats);
                            showToast('ä¿®æ”¹å·²ä¿å­˜', 'success');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        showToast('ä¿å­˜å¤±è´¥', 'error');
                    } finally {
                        isSaving = false;  // ç»“æŸä¿å­˜
                    }
                } else {
                    contentDiv.innerHTML = originalContent;
                }
            }
            // å›è½¦æäº¤
            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();  // é˜»æ­¢å›è½¦çš„é»˜è®¤è¡Œä¸º
                    saveEdit();
                }
            };
            // å¤±å»ç„¦ç‚¹æ—¶æ¢å¤åŸå†…å®¹
            textarea.onblur = () => {
                if (!isSaving) {
                    contentDiv.innerHTML = originalContent;
                }
            };
        }

        // -------------------------------- å†å²å¯¹è¯ç®¡ç† --------------------------------

        // å½“å‰é€‰ä¸­çš„å¯¹è¯ID
        let currentConversationId = null;
        let currentChatTitle = '';
        
        // è°ƒç”¨åç«¯æœåŠ¡ åŠ è½½å¯¹è¯åˆ—è¡¨ DONE
        async function loadConversationList() {
            try { // get_conversations
                const response = await fetch('/chat/api/conversations');
                const conversations = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                conversations.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.conversationId = chat.conversation_id;
                    chatItem.innerHTML = `
                        <div class="chat-actions">
                            <button onclick="event.stopPropagation(); editChatTitle(event, '${chat.conversation_id}', '${chat.title}')" title="ç¼–è¾‘">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteChat(event, '${chat.conversation_id}')" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="chat-title">${chat.title || 'æ–°å¯¹è¯'}</div>
                    `;
                    chatItem.onclick = () => loadConversation(chat.title, chat.conversation_id);
                    chatList.appendChild(chatItem);
                });
                // addChatListeners();
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
                showToast('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        // é‡ç‚¹ é¡µé¢åŠ è½½æ—¶è·å–å¯¹è¯åˆ—è¡¨ DONE
        document.addEventListener('DOMContentLoaded', () => {
            loadConversationList();
            // æ·»åŠ è¾“å…¥æ¡†ç›‘å¬
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.querySelector('.chat-input-area button.btn-primary');
            // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
            messageInput.addEventListener('input', function() {
                sendButton.disabled = !this.value.trim();
            });
            // ç›‘å¬Ctrl+Enterå‘é€æ¶ˆæ¯
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();  // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    if (!sendButton.disabled) {
                        sendChatMessage();
                    }
                }
            });
            // åˆå§‹çŠ¶æ€è®¾ç½®
            sendButton.disabled = !messageInput.value.trim();
            // åŠ è½½ä¿å­˜çš„API keys
            document.querySelectorAll('.api-key').forEach(input => {
                const provider = input.dataset.model;
                const savedKey = getCookie(`${provider}_api_key`);
                if (savedKey) {
                    input.value = savedKey;
                }
            });
        });
        
        // é‡ç‚¹ åŠ è½½ç‰¹å®šå¯¹è¯å†…å®¹
        let isFetchingConversation = false;
        async function loadConversation(chat_title, convId) {
            if (currentConversationId === convId) {
                return;  // é™é»˜è¿”å›ï¼Œæ— éœ€ä»»ä½•æç¤º
            }
            if (isFetchingConversation) {
                showToast('æ­£åœ¨è·å–å¯¹è¯æ•°æ®ï¼Œè¯·ç¨ç­‰', 'info');
                return;
            }
            try {
                isFetchingConversation = true;
                currentChatTitle = chat_title;
                currentConversationId = convId;  // è®¾ç½®å½“å‰å¯¹è¯ID

                // å°è¯•ä»ç¼“å­˜è·å–å¯¹è¯
                const cachedConversation = chatCache.get(`conv_${convId}`);
                let history;
                if (cachedConversation) {
                    history = cachedConversation;
                } else {
                    // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™ä»æœåŠ¡å™¨è·å–
                    const response = await fetch(`/chat/api/conversation?conversation_id=${convId}`);
                    history = await response.json();
                    // å­˜å…¥ç¼“å­˜
                    chatCache.set(`conv_${convId}`, history, { type: 'json' });
                }
                // æ¸…ç©ºç°æœ‰å¯¹è¯
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                // å¾ªç¯æ·»åŠ æ¶ˆæ¯å—
                history.forEach((msg, index) => addMessageToChat(msg.role, msg.blocks[0].text, index));
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
                showToast('åŠ è½½å¯¹è¯å¤±è´¥', 'error');
            } finally {
                isFetchingConversation = false;
            }
        }

        // åˆ›å»ºæˆ–æ›´æ–°æ–°å¯¹è¯ DONE å››ç§æƒ…å†µï¼š1 ç©ºç™½æ–°é¡µé¢ ç›´æ¥å¯¹è¯ æ­¤æ—¶æ²¡æœ‰å¯¹è¯ID 2 åœ¨å·²æœ‰å¯¹è¯çš„æƒ…å†µä¸‹ç‚¹å‡»æ–°å»ºå¯¹è¯(force) ç‚¹çš„æ—¶å€™ æ²¡æœ‰æ–°ID ä½†æ˜¯ç‚¹å®Œåé¡µé¢æ¸…å± å¹¶ä¸”æœ‰ID 3 ç‚¹å‡»æŸä¸ªå¯¹è¯ï¼Œè¿›è¡Œå¯¹è¯ï¼Œæ­¤æ—¶æœ‰ID
        async function createUpdateChat(force=false) {
            const messageDiv = document.querySelector('.chat-messages .message:last-child');
            if (!messageDiv) {
                return;
            }
            // åˆ›å»ºå¯¹è¯
            if (!currentConversationId || force) {
                try { // create_conversation
                    const response = await fetch('/chat/api/conversation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: '1'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        currentConversationId = result.data.conversation_id;  // è®¾ç½®å½“å‰å¯¹è¯ID
                        if (force) { // ç‚¹å‡»æ–°å»ºæŒ‰é’® æ¸…ç©ºç°æœ‰å¯¹è¯
                            const chatMessages = document.getElementById('chatMessages');
                            chatMessages.innerHTML = '';
                        }
                        // åˆ·æ–°å¯¹è¯åˆ—è¡¨
                        loadConversationList();
                        return currentConversationId;
                    } else {
                        showToast('åˆ›å»ºå¯¹è¯å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºå¯¹è¯å¤±è´¥:', error);
                    showToast('åˆ›å»ºå¯¹è¯å¤±è´¥', 'error');
                    throw error;  // ç»§ç»­æŠ›å‡ºé”™è¯¯ï¼Œä¸­æ–­èŠå¤©è¯·æ±‚
                }
            }
            // å·²æœ‰ID æ›´æ–°å¯¹è¯ ç”¨äºæ¯æ¬¡å¯¹è¯ååˆ·æ–°å¯¹è¯æ—¶é—´
            else {
                try { // update_conversation update_chat
                    const response = await fetch(`/chat/api/conversation/${currentConversationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: '1'
                        })
                    });
                    return currentConversationId;
                } catch (error) {
                    // æš‚ä¸å¤„ç†
                    return currentConversationId;
                } finally {
                    // åˆ·æ–°å¯¹è¯åˆ—è¡¨
                    loadConversationList();
                }
            }
        }
        
        // ç¼–è¾‘å¯¹è¯æ ‡é¢˜ DONE
        async function editChatTitle(event, convId, currentTitle) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            const chatItem = event.target.closest('.chat-item');
            const titleDiv = chatItem.querySelector('.chat-title');
            const originalTitle = titleDiv.textContent;
            let isSaving = false;
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-title-input';
            input.value = originalTitle;
            
            titleDiv.innerHTML = '';
            titleDiv.appendChild(input);
            input.focus();

            // ä¿å­˜ç¼–è¾‘
            async function saveTitle() {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== originalTitle) {
                    isSaving = true;
                    try { // update_conversation
                        const response = await fetch(`/chat/api/conversation/${convId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                title: newTitle
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            titleDiv.innerHTML = result.data?.title || newTitle;  // ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦ï¼Œå¦‚æœresult.data.titleä¸å­˜åœ¨å°±ä½¿ç”¨newTitle
                            showToast('æ ‡é¢˜æ›´æ–°æˆåŠŸ', 'success');
                        } else {
                            titleDiv.innerHTML = originalTitle;
                            showToast(result.message || 'æ›´æ–°å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°æ ‡é¢˜å¤±è´¥:', error);
                        titleDiv.innerHTML = originalTitle;
                        showToast('æ›´æ–°æ ‡é¢˜å¤±è´¥', 'error');
                    } finally {
                        isSaving = false;
                    }
                } else {
                    titleDiv.innerHTML = originalTitle;
                }
            }
            // å›è½¦æäº¤
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveTitle();
                }
            };
            // å¤±å»ç„¦ç‚¹æ—¶æ¢å¤åŸå†…å®¹
            input.onblur = () => {
                if (!isSaving) {
                    titleDiv.innerHTML = originalTitle;
                }
            };
        }
        
        // åˆ é™¤å¯¹è¯ DONE
        async function deleteChat(event, convId) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                return;
            }
            try { // delete_conversation
                const response = await fetch(`/chat/api/conversation/${convId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    await loadConversationList(); // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…ç©ºå¯¹è¯åŒºåŸŸ
                    if (currentConversationId === convId) {
                        document.getElementById('chatMessages').innerHTML = '';
                        currentConversationId = null;
                    }
                    chatCache.deleteAndUpdateStats(`conv_${convId}`, updateCacheStats);
                    showToast('å¯¹è¯åˆ é™¤æˆåŠŸ', 'success');
                } else {
                    showToast(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                showToast('åˆ é™¤å¯¹è¯å¤±è´¥', 'error');
            }
        }

        // æœç´¢å æ›´æ–°å¯¹è¯åˆ—è¡¨æ˜¾ç¤º DONE
        function updateChatList(chats) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.conversationId = chat.conversation_id;
                chatItem.innerHTML = `
                    <div class="chat-actions">
                        <button onclick="event.stopPropagation(); editChatTitle(event, '${chat.conversation_id}', '${chat.title}')" title="ç¼–è¾‘">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteChat(event, '${chat.conversation_id}')" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="chat-title">${chat.title || 'æ–°å¯¹è¯'}</div>
                `;
                chatItem.onclick = () => loadConversation(chat.title, chat.conversation_id);
                chatList.appendChild(chatItem);
            });
            // addChatListeners();
        }

        // -------------------------------- ç¬”è®°ç®¡ç† --------------------------------
        // TODO å¤šç¬”è®°æ±‡å…¥åˆå¹¶
        
        // é‡ç‚¹ è°ƒç”¨åç«¯æ–¹æ³• è®°ç¬”è®°
        async function createNote(noteData) {
            try {
                // å‘é€è¯·æ±‚åˆ›å»ºç¬”è®°
                const response = await fetch('/note/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(noteData)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ç¬”è®°åˆ›å»ºæˆåŠŸ', 'success');
                } else {
                    if (result.error.includes("400 Client Error: Bad Request for url: https://api.notion.com/v1/pages")) {
                        showToast('åˆ›å»ºç¬”è®°å¤±è´¥: è¯·æ£€æŸ¥ç¬”è®°æ˜¯å¦è¶…è¿‡ 1000 ä¸ªå­—ç¬¦', 'error');
                    } else {
                        showToast('åˆ›å»ºç¬”è®°å¤±è´¥: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                console.error('åˆ›å»ºç¬”è®°å¤±è´¥:', error);
                showToast('åˆ›å»ºç¬”è®°å¤±è´¥', 'error');
            }
        }

        // é€‰ä¸­çš„æ–‡æœ¬è®°ç¬”è®°
        async function saveSelectionAsNote() {
            try {
                const selectedText = window.getSelection().toString();
                if (selectedText) {
                    const noteData = {
                        title: `${currentChatTitle}`,
                        content: selectedText,
                        source: 'NewsReader',
                        types: ['NOTE'],
                        chats: currentConversationId ? [currentConversationId] : []
                    };

                    // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡ç« ï¼Œæ·»åŠ åˆ°ç¬”è®°ä¸­
                    const selectedArticles = getSelectedArticles();
                    if (selectedArticles.length > 0) {
                        noteData.articles = selectedArticles;
                    }
                    // å‘é€è¯·æ±‚åˆ›å»ºç¬”è®°
                    await createNote(noteData);
                }
            } catch (error) {
                showToast('åˆ›å»ºç¬”è®°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜æ¶ˆæ¯ä¸ºç¬”è®°
        async function saveMessageAsNote(button) {
            try {
                const messageDiv = button.closest('.message');
                const content = messageDiv.querySelector('.message-content').textContent;
                const noteData = {
                    title: `${currentChatTitle}`,
                    content: content,
                    source: 'NewsReader',
                    types: ['NOTE'],
                    chats: currentConversationId ? [currentConversationId] : []
                };
                // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡ç« ï¼Œæ·»åŠ åˆ°ç¬”è®°ä¸­
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 0) {
                    noteData.articles = selectedArticles;
                }
                await createNote(noteData);
            } catch (error) {
                showToast('åˆ›å»ºç¬”è®°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ä¿å­˜å¯¹è¯ä¸ºç¬”è®°
        async function saveChatAsNote() {
            try {
                // è·å–å½“å‰å¯¹è¯çš„å†…å®¹
                const chatMessages = document.querySelectorAll('.message');
                if (!chatMessages.length) {
                    return;
                }
                // æ”¶é›†å¯¹è¯å†…å®¹
                let content = '';
                chatMessages.forEach(msg => {
                    const text = msg.querySelector('.message-content').textContent;
                    content += `${text}`;
                });
                // å‡†å¤‡ç¬”è®°æ•°æ®
                const noteData = {
                    title: `${currentChatTitle}`,
                    content: content,
                    source: 'NewsReader',
                    types: ['CHAT'],
                    chats: currentConversationId ? [currentConversationId] : []
                };
                // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡ç« ï¼Œæ·»åŠ åˆ°ç¬”è®°ä¸­
                const selectedArticles = getSelectedArticles();
                if (selectedArticles.length > 0) {
                    noteData.articles = selectedArticles;
                }
                await createNote(noteData);
            } catch (error) {
                showToast('åˆ›å»ºç¬”è®°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜æ–‡ç« ä¸ºç¬”è®°
        async function saveArtAsNote(btn) {
            // æ”¶é›†æ–‡ç« å†…å®¹
            let content = currentArticle.content;
            if (!content) {
                showToast('é”™è¯¯', 'æœªæ‰¾åˆ°æ–‡ç« å†…å®¹');
                return;
            }
            // å‡†å¤‡ç¬”è®°æ•°æ®
            const noteData = {
                types: ['ARTICLE'],
                title: currentArticle.title,
                content: content,
                url: currentArticle.url,
                topics: currentArticle.topics,
                summary: currentArticle.summary
            };
            await createNote(noteData);
        }

        // æ–°å»ºç¬”è®°
        function createNewNote() {
            showToast('ç¬”è®°åŠŸèƒ½å³å°†æ¨å‡º', 'info');
        }
    
    </script>
</body>
</html>
