<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsReader</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/article.css">
</head>
<body>
    <div class="container">
        <div class="sticky-top-section">
            <!-- Flash 消息容器 -->
            <div class="flash-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <!-- 添加文章表单 -->
            <form class="add-article-form" onsubmit="return false;">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="输入文章URL" name="url" required>
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit">添加文章</button>
                    </div>
                </div>
            </form>

            <!-- 搜索栏 -->
            <div class="search-bar mb-3">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="搜索文章..." id="search-input">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchArticles()">搜索</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <tbody>
                    {% for article in articles %}
                    <tr id="article-{{ article.id }}">
                        <td class="col-title">
                            <a href="{{ article.url }}" target="_blank" class="article-title">{{ article.title }}</a>
                            <div class="tags-container">
                                <span id="tags-text-{{ article.id }}" class="tags-text">
                                    {% if article.tags %}
                                        标签：{{ article.tags }}
                                    {% endif %}
                                </span>
                                <input type="text" id="tags-input-{{ article.id }}" class="tags-input" style="display: none;"
                                    value="{{ article.tags }}">
                                <button onclick="editTags('{{ article.id }}')" class="btn btn-sm btn-outline-primary">编辑标签</button>
                                <button onclick="saveTags('{{ article.id }}')" class="btn btn-sm btn-success"
                                    style="display: none;">保存</button>
                            </div>
                        </td>
                        <td class="col-date compress" title="{{ article.id }}">
                            <button type="button" onclick="deleteArticle('{{ article.id }}')">删除</button>
                            {{ article.collection_date }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function deleteArticle(articleId) {
            if (!confirm('确定要删除这篇文章吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/article/delete_article/${articleId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    // 删除成功，移除文章元素
                    const articleElement = document.getElementById('article-' + articleId);
                    if (articleElement) {
                        articleElement.remove();
                        showToast('文章删除成功', 'success');
                    }
                } else {
                    // 处理错误
                    const data = await response.json();
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除文章时出错:', error);
                showToast('删除文章时发生错误', 'error');
            }
        }

        function editTags(articleId) {
            document.getElementById('tags-text-' + articleId).style.display = 'none';
            document.getElementById('tags-input-' + articleId).style.display = 'inline';
        }

        function saveTags(articleId) {
            document.getElementById('tags-text-' + articleId).style.display = 'inline';
            document.getElementById('tags-input-' + articleId).style.display = 'none';
        }

        // 修改添加文章的表单提交
        document.querySelector('.add-article-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = this;
            const url = form.querySelector('input[name="url"]').value;

            try {
                const response = await fetch('/article/add_article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    // 可以选择刷新页面或动态添加新文章到列表
                    location.reload();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('添加文章时发生错误', 'error');
            }
        });

        // 自动关闭 Flash 消息
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    const closeButton = alert.querySelector('button.close');
                    if (closeButton) {
                        closeButton.click();
                    }
                });
            }, 3000); // 3秒后自动关闭
        });

        // Toast 提示函数
        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '1000';

            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show`;
            toast.innerHTML = `
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;

            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
