from pymilvus import MilvusClient, DataType

import configparser
from dotenv import load_dotenv
import os

# 从配置文件读取uri
cfp = configparser.RawConfigParser()
cfp.read('src/database/zilliz_config.ini')
milvus_uri = cfp.get('example', 'uri')

# 从.env读取token
load_dotenv()
token = os.getenv('ZILLIZ_MILVUS_KEY')

# JSON 类型 https://docs.zilliz.com.cn/docs/use-json-fields#%E4%BD%BF%E7%94%A8-json-%E5%AD%97%E6%AE%B5%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4%E6%90%9C%E7%B4%A2%E5%92%8C%E6%9F%A5%E8%AF%A2
client = MilvusClient(uri=milvus_uri, token=token)

schema = client.create_schema(
    auto_id=False,
    enable_dynamic_fields=True,
)

# 添加 JSON 字段
schema.add_field(field_name="metadata", datatype=DataType.JSON)
schema.add_field(field_name="pk", datatype=DataType.INT64, is_primary=True)
schema.add_field(field_name="content", datatype=DataType.VARCHAR, max_length=65535)
schema.add_field(field_name="embedding", datatype=DataType.FLOAT_VECTOR, dim=1024)

# 创建 Collection
index_params = client.prepare_index_params()
index_params.add_index(
    field_name="embedding",
    index_type="AUTOINDEX",
    metric_type="COSINE"
)
# 使用定义好的 Schema 和索引参数来创建 Collection
# 使用时打开
# client.drop_collection(
#     collection_name="my_json_collection"
# )
# client.create_collection(
#     collection_name="my_json_collection",
#     schema=schema,
#     index_params=index_params
# )

# 插入数据
data = [
  {
      "metadata": {"category": "electronics", "price": 99.99, "brand": "BrandA"},
      "pk": 1,
      "content": "This is a phone",
      "embedding": [0.12, 0.34, 0.56]
  },
  {
      "metadata": {"category": "home_appliances", "price": 249.99, "brand": "BrandB"},
      "pk": 2,
      "content": "This is a TV",
      "embedding": [0.56, 0.78, 0.90]
  },
  {
      "metadata": {"category": "furniture", "price": 399.99, "brand": "BrandC"},
      "pk": 3,
      "content": "This is a chair",
      "embedding": [0.91, 0.18, 0.23]
  }
]
# client.insert(
#     collection_name="my_json_collection",
#     data=data
# )

# 1 使用 JSON 字段进行标量过滤搜索和查询
# 过滤查询
# 您可以基于 JSON 属性过滤数据，例如匹配特定值或检查某个数字是否在特定范围内。
filter = 'metadata["category"] == "electronics" and metadata["price"] < 150'
# res = client.query(
#     collection_name="my_json_collection",
#     filter=filter,
#     output_fields=["metadata"]
# )
# print(res)

# Output
# data: ["{'metadata': {'category': 'electronics', 'price': 99.99, 'brand': 'BrandA'}, 'pk': 1}"] 

# 2 向量搜索与 JSON 过滤结合
filter = 'metadata["brand"] == "BrandA"'

# res = client.search(
#     collection_name="my_json_collection",
#     data=[[0.3, -0.6, 0.1]],
#     limit=5,
#     search_params={"params": {"nprobe": 10}},
#     output_fields=["metadata"],
#     filter=filter
# )

# print(res)

# Output
# data: ["[{'id': 1, 'distance': -0.2479381263256073, 'entity': {'metadata': {'category': 'electronics', 'price': 99.99, 'brand': 'BrandA'}}}]"] 

# ------------------------------------ ZILLIZ官方DEMO结束 ------------------------------------


# 小到大父子上下文处理流程 1 预处理：切分 + 上下文；2 存储：小的进向量 大的进缓存 3 查询：向量找小 缓存找大
import embeddings.jina as jina
import asyncio
test_psg = "说明手册：\n 第一节：\n 这是一篇已经分好段的文章，每段的分隔符是 --- \n 操作要求：\n 你需要为每段增加上下文，然后连同原段落一起返回。 \n 格式：json形式"
psg1 = "## 《巨龙的黎明》详细时间线梳理\n\n《巨龙的黎明》是《魔兽世界》官方小说合集《魔兽世界官方小说大合集》中的一部，讲述了青铜龙王诺兹多姆（又称时光守护者）及其青铜龙军团在面对时间线混乱和永恒龙军团威胁时，所经历的危机与抉择。以下是《巨龙的黎明》的详细时间线梳理：\n\n### **1. 时间线的异变（故事开始前）**\n\n- **事件:**\n    - 青铜龙王诺兹多姆察觉到时间线出现异常波动，未来的时间线开始汇聚收拢，指向一个被称为“暮光审判”的末日结局。\n    - 诺兹多姆预感到自己和其他守护巨龙都将被终结。\n    - 他试图寻找时间线混乱的原因，但始终无法看清真相。\n- **影响:**\n    - 诺兹多姆陷入深深的焦虑和迷茫，开始质疑自己作为时光守护者的能力。\n    - 他意识到自己可能无法阻止这场灾难。\n\n### **2. 兹里昂的死亡与永恒龙军团的威胁（故事开端）**\n\n- **事件:**\n    - 诺兹多姆派遣了一支由十二名青铜龙组成的特别小队，前往调查时间线中的乱流。\n    - 青铜龙兹里昂独自返回，身受重伤，濒临死亡。他透露：\n        - 所有进入时间线的青铜龙最终都抵达了同一个时间点——暮光审判。\n        - 永恒龙军团及其首领（未来的诺兹多姆，即姆诺兹多）正在对时间线进行侵袭。\n    - 诺兹多姆试图用魔法治愈兹里昂，但发现自己的法术被一个同样强大的存在所抵消。\n    - 提克（青铜龙）告知诺兹多姆，兹里昂在返回途中曾提到，永恒龙军团的首领正是未来的诺兹多姆。\n- **影响:**\n    - 诺兹多姆意识到自己最终会背叛守护巨龙的职责，加入永恒龙军团，成为时间线的破坏者。\n    - 他开始怀疑自己是否还能继续履行守护时间线的职责，内心充满自责和恐惧。\n\n### **3. 诺兹多姆的反思与萨尔的影响（过去）**\n\n- **事件:**\n    - 诺兹多姆回顾过去几周发生的事件，回忆起自己曾被困在时间线中无法自拔，直到兽人萨满萨尔帮助他记起了“把握现在”的重要性。\n    - 诺兹多姆意识到自己过于执着于过去和未来，而忽略了当下的重要性。\n    - 他开始重新审视自己的使命，并试图寻找阻止暮光审判的方法。\n- **影响:**\n    - 萨尔对诺兹多姆的影响成为他重新振作的关键。\n    - 诺兹多姆决定不再逃避现实，而是积极寻找应对之策。\n\n### **4. 龙王集会与巨龙之魂的构想（海加尔山）**\n\n- **事件:**\n    - 诺兹多姆与其他守护巨龙（阿莱克丝塔萨、伊瑟拉、卡雷苟斯）以及萨尔在海加尔山集会。\n    - 诺兹多姆讲述了兹里昂的死亡和永恒龙军团的威胁，并透露时间线正在汇聚收拢。\n    - 守护巨龙们意识到必须采取行动，但如何对抗死亡之翼（黑龙军团首领，大灾变的罪魁祸首）仍然是个难题。\n    - 卡雷苟斯提出利用巨龙之魂对抗死亡之翼，但遭到质疑，因为：\n        - 巨龙之魂曾导致龙族分裂，并给玛里苟斯的蓝龙军团带来灭顶之灾。\n        - 死亡之翼没有向巨龙之魂注入力量，因此无法直接用其攻击他。\n    - 卡雷苟斯认为可以通过注入足够的奥术能量改变巨龙之魂的性质，使其能够影响死亡之翼。\n    - 伊瑟拉回忆起上古之战时期，巨龙之魂被创造出来的情景，并提出可以回到过去取得这件神器。\n    - 诺兹多姆反对回到过去，认为这会干扰时间线，但最终被说服。\n- **影响:**\n    - 守护巨龙们决定使用巨龙之魂对抗死亡之翼，并计划从过去取得这件神器。\n    - 诺兹多姆意识到自己必须面对时间线的混乱，并承担起改变命运的责任。\n\n### **5. 诺兹多姆与提尔的会面（时间不详）**\n\n- **事件:**\n    - 诺兹多姆在等待其他龙王时，遇到了一位神秘的守护者——提尔。\n    - 提尔告知诺兹多姆：\n        - 他一直在观察始祖龙，并认为玛法里奥（未来的德鲁伊）和其他四头始祖龙（玛里苟斯、阿莱克丝塔萨、伊瑟拉、耐萨里奥）拥有拯救艾泽拉斯的潜力。\n        - 他希望诺兹多姆能帮助他引导这五头始祖龙成为守护巨龙。\n    - 诺兹多姆意识到提尔所说的正是上古之战时期的事情。\n- **影响:**\n    - 诺兹多姆对提尔的计划感到怀疑，但也被他的坚定信念所感染。\n    - 他开始思考自己是否应该改变过去，以创造一个更美好的未来。\n\n### **6. 诺兹多姆的决定与时间线的改变（时间不详）**\n\n- **事件:**\n    - 诺兹多姆最终决定帮助提尔，并同意回到过去，引导五头始祖龙成为守护巨龙。\n    - 他意识到自己必须打破时间的循环，才能阻止暮光审判的到来。\n    - 诺兹多姆利用自己的力量，将五头始祖龙带到龙神之厅，并见证了提尔和守护者们赋予他们守护巨龙力量的过程。\n- **影响:**\n    - 诺兹多姆的选择改变了时间线，为艾泽拉斯的未来带来了新的希望。\n    - 他也接受了自己作为守护巨龙的命运，并决心与同伴们一起对抗暮光审判。\n\n### **7. 永恒龙军团的反击（时间不详）**\n\n- **事件:**\n    - 诺兹多姆的行动引起了永恒龙军团的注意。\n    - 永恒龙军团试图阻止诺兹多姆改变时间线，并发动攻击。\n    - 诺兹多姆与永恒龙军团展开激战，最终成功击退他们。\n- **影响:**\n    - 诺兹多姆的胜利巩固了他对改变时间线的信心。\n    - 他也意识到永恒龙军团的威胁依然存在，未来仍然充满挑战。\n\n### **8. 守护巨龙的未来（时间不详）**\n\n- **事件:**\n    - 诺兹多姆与其他守护巨龙讨论了未来的计划。\n    - 他们意识到守护巨龙的职责不仅仅是保护艾泽拉斯，还要引导这个世界的发展。\n    - 诺兹多姆开始思考守护巨龙在完成使命后的命运，以及他们是否应该继续存在。\n- **影响:**\n    - 守护巨龙们对未来充满希望，但也意识到前方的道路充满挑战。\n    - 诺兹多姆对守护巨龙的未来有了更深刻的思考，并决心继续守护艾泽拉斯。\n\n## 总结\n\n《巨龙的黎明》的故事围绕着诺兹多姆对时间线混乱的探索和应对展开，最终他选择打破时间的循环，改变过去，以创造一个更美好的未来。这个时间线展示了诺兹多姆从迷茫到坚定的心理转变，以及他与其他守护巨龙和提尔之间的互动，为后续的《上古之战三部曲》奠定了基础。\n\n## 《上古之战三部曲：永恒之井、恶魔之魂、天崩地裂》详细时间线梳理\n\n### **战争前夕**\n\n1. **上古之神窥探（时间不详）**\n    - **事件:** 一个来自混沌界域的未知存在，感应到暗夜精灵对永恒之井魔法的滥用，渴望进入艾泽拉斯世界，吞噬一切。\n    - **影响:** 预示着燃烧军团的入侵并非偶然，而是多方势力共同作用的结果。\n2. **玛法里奥的德鲁伊修行（时间不详）**\n    - **事件:**\n        - 年轻的暗夜精灵玛法里奥·怒风在林地半神塞纳留斯的指导下学习德鲁伊之道，尝试与自然力量建立联系。\n        - 玛法里奥的弟弟伊利丹·怒风则对传统的暗夜精灵魔法充满热情，并渴望掌握德鲁伊之道来证明自己。\n        - 泰兰德·语风成为艾露恩的祭司，并鼓励玛法里奥学习德鲁伊之道。\n    - **影响:**\n        - 玛法里奥逐渐掌握了驾驭自然力量的能力，为日后对抗燃烧军团奠定了基础。\n        - 三人之间微妙的情感关系开始显现，为后续剧情埋下伏笔。\n3. **卡雷苟斯的幻象（时间不详）**\n    - **事件:**\n        - 蓝龙卡雷苟斯（简称卡雷）开始经历一系列奇怪的幻象，目睹了上古之战时期的事件，包括：\n            - 青铜龙王诺兹多姆派遣的巨龙小队遭遇永恒龙军团袭击，队员兹里昂重伤濒死。\n            - 幼年的玛里苟斯（未来的织法者）、阿莱克丝塔萨（未来的生命缚誓者）、伊瑟拉（未来的梦境守护者）、耐萨里奥（未来的死亡之翼）以及其他始祖龙与迦拉克隆（诸龙之父）展开激烈战斗。\n            - 提尔（一名守护者）引导五头始祖龙成为守护巨龙，并赋予他们守护艾泽拉斯的力量。\n        - 卡雷发现自己被困在幻象中，无法回到现实世界。\n    - **影响:**\n        - 卡雷逐渐意识到这些幻象并非简单的记忆重现，而是与现实世界有着某种联系。\n        - 他开始怀疑自己被卷入了一场更大的阴谋，并试图寻找回到现实的方法。\n4. **燃烧军团入侵前夕（时间不详）**\n    - **事件:**\n        - 暗夜精灵上层精灵在女王艾萨拉的纵容下，滥用永恒之井的力量进行魔法实验。\n        - 他们的行为引起了玛法里奥的注意，他试图警告其他人，但大多数人对此不以为然。\n        - 玛法里奥进入翡翠梦境，试图查明真相，却意外进入辛艾萨莉，发现上层精灵正在召唤某种强大的力量。\n        - 兽人布洛克斯加和他的同伴奉命调查一个神秘的异象，被卷入时间漩涡，穿越到上古之战时期。\n    - **影响:**\n        - 玛法里奥意识到暗夜精灵正面临巨大的危险，但他的警告被忽视。\n        - 布洛克斯加的到来预示着燃烧军团的入侵即将开始。\n\n### **战争初期**\n\n1. **燃烧军团入侵（时间不详）**\n    - **事件:**\n        - 燃烧军团通过永恒之井的传送门涌入艾泽拉斯，开始对暗夜精灵展开大规模屠杀。\n        - 辛艾萨莉被摧毁，暗夜精灵死伤惨重，只有少数上层精灵和他们的仆从幸存。\n        - 艾萨拉女王和她的顾问萨维斯与燃烧军团勾结，企图利用他们的力量统治世界。\n    - **影响:**\n        - 暗夜精灵文明遭到毁灭性打击，燃烧军团对艾泽拉斯的威胁全面升级。\n2. **暗夜精灵的抵抗（时间不详）**\n    - **事件:**\n        - 拉文凯斯领主集结暗夜精灵军队，抵抗燃烧军团的入侵。\n        - 玛法里奥、伊利丹和泰兰德加入抵抗军，玛法里奥利用德鲁伊之力与恶魔作战，伊利丹则凭借对魔法的掌控成为拉文凯斯领主的贴身法师。\n        - 泰兰德带领艾露恩姐妹会的祭司们为战士们提供治疗和支援。\n        - 克拉苏斯（红龙考雷斯特拉兹的伪装形态）和罗宁（人类法师）也加入抵抗军，并试图说服拉文凯斯领主与其他种族结盟。\n    - **影响:**\n        - 暗夜精灵开始组织有效的抵抗，但内部对是否与其他种族结盟存在分歧。\n        - 克拉苏斯和罗宁的到来为抵抗军带来了新的希望，但也引发了新的问题。\n3. **玛法里奥的翡翠梦境之旅（时间不详）**\n    - **事件:**\n        - 玛法里奥再次进入翡翠梦境，试图找到阻止燃烧军团的方法。\n        - 他在梦境中遇到了伊瑟拉，并被带到守护巨龙们的集会地点，见证了五头始祖龙成为守护巨龙的仪式。\n        - 玛法里奥意识到巨龙之魂（由五头守护巨龙的力量凝聚而成）被赋予了强大的力量，但也被耐萨里奥（死亡之翼）注入了邪恶的意志。\n        - 玛法里奥试图破坏巨龙之魂，但被萨维斯抓住并囚禁在水晶中。\n    - **影响:**\n        - 玛法里奥对巨龙之魂的邪恶本质有了更深刻的认识，但他的行动也让他陷入了更大的危险。\n\n### **战争中期**\n\n1. **抵抗军的反击（时间不详）**\n    - **事件:**\n        - 抵抗军在罗宁和伊利丹的魔法支持下，成功击退燃烧军团的进攻，并暂时稳定了战局。\n        - 拉文凯斯领主在战斗中牺牲，加洛德·影歌临危受命，成为新的指挥官。\n        - 泰兰德被萨维斯及其萨特手下绑架，伊利丹对玛法里奥心生嫉妒，渴望得到泰兰德的爱。\n    - **影响:**\n        - 抵抗军失去了一位重要的领导者，但加洛德的领导才能开始显现。\n        - 泰兰德的被俘加剧了玛法里奥和伊利丹之间的紧张关系。\n2. **玛法里奥逃脱与伊利丹的背叛（时间不详）**\n    - **事件:**\n        - 玛法里奥在泰兰德的帮助下逃脱，并试图阻止萨维斯强化传送门。\n        - 伊利丹在内心挣扎后，选择背叛抵抗军，投靠燃烧军团，企图利用恶魔的力量得到泰兰德。\n        - 玛法里奥与萨维斯展开激战，最终将其杀死，但泰兰德还是被萨特带走。\n    - **影响:**\n        - 玛法里奥对伊利丹的背叛感到震惊和悲痛，但仍然试图拯救他。\n        - 抵抗军失去了泰兰德这位重要的盟友，士气受到打击。\n3. **巨龙之魂的铸造（时间不详）**\n    - **事件:**\n        - 耐萨里奥（死亡之翼）利用五头守护巨龙的力量铸造了巨龙之魂，并将其据为己有。\n        - 克拉苏斯意识到耐萨里奥的背叛，并试图警告其他守护巨龙，但被耐萨里奥的魔法阻止。\n        - 考雷斯特拉兹（克拉苏斯的年轻形态）离开抵抗军，前往龙族领地寻找其他巨龙。\n    - **影响:**\n        - 耐萨里奥的背叛标志着巨龙之魂的邪恶本质开始显现。\n        - 克拉苏斯和考雷斯特拉兹的行动为抵抗军带来了新的希望，但也让他们陷入了更大的危险。\n\n### **战争后期**\n\n1. **抵抗军的困境（时间不详）**\n    - **事件:**\n        - 燃烧军团发动新一轮攻势，抵抗军陷入绝境。\n        - 克拉苏斯和玛法里奥意识到必须夺回巨龙之魂才能扭转战局。\n        - 玛法里奥进入翡翠梦境，试图找到耐萨里奥的藏身之处。\n        - 考雷斯特拉兹找到克拉苏斯，并决定帮助他。\n    - **影响:**\n        - 抵抗军面临前所未有的生存危机，玛法里奥和克拉苏斯成为最后的希望。\n2. **玛法里奥与布洛克斯的冒险（时间不详）**\n    - **事件:**\n        - 玛法里奥和布洛克斯加潜入耐萨里奥的巢穴，企图偷走巨龙之魂。\n        - 他们遭遇了地精、巨魔和岩石巨像等重重阻碍，最终成功找到巨龙之魂。\n        - 玛法里奥试图使用巨龙之魂，但被其邪恶力量影响，险些杀死布洛克斯。\n        - 瓦罗森队长和伊利丹出现，夺走了巨龙之魂，并俘虏了玛法里奥和布洛克斯。\n    - **影响:**\n        - 玛法里奥和布洛克斯的行动虽然失败，但为抵抗军争取了时间。\n        - 瓦罗森和伊利丹的行动加速了燃烧军团的阴谋。\n3. **考雷斯特拉兹与死亡之翼的对抗（时间不详）**\n    - **事件:**\n        - 考雷斯特拉兹与死亡之翼展开激战，最终被死亡之翼的魔法击中，坠落地面。\n        - 克拉苏斯被死亡之翼追杀，设法逃脱，并召唤阿莱克丝塔萨（生命守护者）前来救援。\n        - 阿莱克丝塔萨与考雷斯特拉兹重逢，并得知恶魔之魂落入死亡之翼手中。\n    - **影响:**\n        - 考雷斯特拉兹身受重伤，但他的牺牲为抵抗军争取了时间。\n        - 阿莱克丝塔萨意识到必须联合其他守护巨龙才能对抗死亡之翼。\n4. **抵抗军的转机（时间不详）**\n    - **事件:**\n        - 玛法里奥和布洛克斯被伊利丹和瓦罗森押送回辛艾萨莉，途中玛法里奥与夜刃豹沟通，说服它们反抗。\n        - 夜刃豹发动攻击，玛法里奥和布洛克斯趁机逃脱。\n        - 考雷斯特拉兹出现，救下两人，并带他们回到抵抗军营地。\n    - **影响:**\n        - 玛法里奥和布洛克斯成功逃脱，为抵抗军带来了新的希望。\n        - 考雷斯特拉兹的回归增强了抵抗军的战斗力。\n5. **半神加入战斗（时间不详）**\n    - **事件:**\n        - 塞纳留斯带领其他半神和自然生物加入抵抗军。\n        - 抵抗军的力量得到极大增强，士气大振。\n    - **影响:**\n        - 抵抗军拥有了更强大的盟友，为最终的决战奠定了基础。\n6. **阿莱克丝塔萨与守护巨龙的决定（时间不详）**\n    - **事件:**\n        - 阿莱克丝塔萨说服其他守护巨龙（伊瑟拉和诺兹多姆的同族）加入抵抗军。\n        - 克拉苏斯告知阿莱克丝塔萨上古之神正在操纵燃烧军团，并试图利用恶魔之魂打开通往艾泽拉斯的通道。\n        - 阿莱克丝塔萨决定联合其他守护巨龙，阻止上古之神的阴谋。\n    - **影响:**\n        - 守护巨龙们最终决定与抵抗军并肩作战，为抵抗军带来了决定性的力量。\n7. **最终决战（时间不详）**\n    - **事件:**\n        - 抵抗军与燃烧军团展开最终决战。\n        - 守护巨龙们加入战斗，巨龙之魂的力量被用来对抗燃烧军团。\n        - 玛法里奥、伊利丹和泰兰德也参与到战斗中。\n        - 玛法里奥利用自然力量制造了一场巨大的风暴，削弱了燃烧军团的攻势。\n        - 考雷斯特拉兹和死亡之翼再次展开激战，最终死亡之翼被击败，恶魔之魂被夺回。\n    - **影响:**\n        - 抵抗军最终战胜了燃烧军团，关闭上古之井的传送门，结束了战争。\n        - 艾萨拉女王和她的追随者们被封印在海底，恶魔之魂被摧毁。\n\n### **其他重要事件**\n\n- **玛法里奥与泰兰德的关系:** 两人之间的感情在战争期间不断加深，但伊利丹对泰兰德的爱慕也愈发强烈。\n- **伊利丹的转变:** 伊利丹的内心充满矛盾，最终选择背叛抵抗军，投靠燃烧军团，但内心深处仍然渴望得到泰兰德的爱。\n- **克拉苏斯的身份:** 克拉苏斯实际上是红龙考雷斯特拉兹的伪装形态，他拥有着强大的力量和智慧。\n- **恶魔之魂的邪恶本质:** 恶魔之魂被注入死亡之翼的邪恶意志，成为一件极具破坏力的武器。\n\n## 总结\n\n这个时间线涵盖了从战争前夕到最终决战的主要事件，突出了玛法里奥、克拉苏斯、伊利丹和泰兰德等关键人物的经历，以及他们与燃烧军团、守护巨龙和上古之神之间的复杂关系。\n\n---\n\n## 《部落的崛起》详细时间线梳理\n\n《部落的崛起》是《魔兽世界》官方小说合集《魔兽世界官方小说大合集》中的一部，讲述了兽人氏族如何从分散的部落逐渐被恶魔操控，最终入侵艾泽拉斯，并与人类展开第一次大战的故事。以下是《部落的崛起》的详细时间线梳理：\n\n### **1. 兽人氏族的起源与早期生活（距今约 2000 年前）**\n\n- **事件:**\n    - 兽人起源于德拉诺星球，他们由不同的氏族组成，每个氏族都有自己的文化和信仰。\n    - 兽人氏族过着游牧生活，主要以狩猎和采集为生，彼此之间偶尔会发生冲突。\n    - 兽人崇拜元素之灵，并发展出萨满教文化，萨满祭司负责与元素沟通，祈求他们的庇佑。\n- **影响:**\n    - 兽人氏族之间保持着相对的独立和平衡，为后续的部落形成奠定了基础。\n    - 萨满教文化成为兽人社会的核心价值观，影响着他们的生活方式和行为准则。\n\n### **2. 食人魔的压迫与兽人的反抗（距今约 1000 年前）**\n\n- **事件:**\n    - 强大的食人魔帝国崛起，开始压迫和奴役兽人氏族。\n    - 兽人氏族在强大的压力下，开始团结起来，共同抵抗食人魔的侵略。\n    - 兽人英雄奥格瑞姆·毁灭之锤的祖先——黑石氏族的祖先——带领兽人取得了一系列胜利，最终击退了食人魔。\n- **影响:**\n    - 兽人氏族首次联合起来，形成了松散的部落联盟。\n    - 兽人意识到团结的力量，为后续部落的形成奠定了基础。\n    - 奥格瑞姆·毁灭之锤的家族开始崭露头角，为后续的部落领导层埋下伏笔。\n\n### **3. 耐奥祖与影月氏族的崛起（距今约 200 年前）**\n\n- **事件:**\n    - 影月氏族的**萨满祭司耐奥祖**展现出强大的力量和智慧，逐渐成为兽人部落中备受尊敬的领袖。\n    - 耐奥祖致力于维护兽人氏族之间的和平，并试图通过萨满教义引导兽人走向繁荣。\n    - 影月氏族在耐奥祖的领导下，势力不断壮大，成为兽人部落中最强大的氏族之一。\n- **影响:**\n    - 耐奥祖成为兽人部落的精神领袖，他的理念和领导力对兽人社会产生了深远影响。\n    - 影月氏族的崛起改变了兽人部落的权力平衡，为后续的部落内部冲突埋下隐患。\n\n### **4. 恶魔的引诱与耐奥祖的堕落（距今约 100 年前）**\n\n- **事件:**\n    - 燃烧军团的恶魔领主**基尔加丹**发现了德拉诺星球和兽人氏族。\n    - 基尔加丹开始暗中操纵耐奥祖，伪装成元素之灵向他传达虚假的预言，诱骗他相信兽人即将面临巨大的灾难。\n    - 耐奥祖在恐惧和绝望中，接受了基尔加丹的“帮助”，开始学习黑暗魔法，并试图利用恶魔的力量拯救兽人。\n    - 基尔加丹逐渐腐蚀耐奥祖的思想，最终将其变成自己的傀儡。\n- **影响:**\n    - 耐奥祖的堕落标志着兽人氏族开始走向黑暗的道路。\n    - 恶魔的介入打破了兽人社会的平衡，为后续的部落入侵埋下伏笔。\n\n### **5. 部落联盟的建立与古尔丹的崛起（距今约 30 年前）**\n\n- **事件:**\n    - 耐奥祖在基尔加丹的授意下，开始召集各个兽人氏族，组建一个统一的部落联盟。\n    - **耐奥祖的学徒古尔丹**展现出强大的魔法天赋，并成为他的得力助手。\n    - 古尔丹在基尔加丹的操控下，暗中策划着更大的阴谋。\n    - 各个兽人氏族在耐奥祖的号召下，逐渐团结起来，部落联盟初具规模。\n- **影响:**\n    - 部落联盟的建立标志着兽人氏族从松散的联盟走向统一的部落。\n    - 古尔丹的崛起为部落内部权力斗争埋下隐患，也为后续的恶魔操控埋下伏笔。\n\n### **6. 恶魔之血的诅咒与部落的疯狂（距今约 15 年前）**\n\n- **事件:**\n    - 基尔加丹向古尔丹提供了恶魔之血，并命令他将之赐予兽人。\n    - 古尔丹和耐奥祖将恶魔之血混入圣水，欺骗兽人喝下。\n    - 喝下恶魔之血的兽人变得狂暴、嗜血，力量得到极大增强，但同时也失去了理智和自我控制。\n    - 兽人氏族之间的冲突加剧，部落内部陷入混乱。\n    - 耐奥祖意识到自己被恶魔利用，试图反抗，但被古尔丹背叛并囚禁。\n    - 古尔丹成为部落实际上的领袖，部落完全被恶魔操控。\n- **影响:**\n    - 恶魔之血的诅咒彻底改变了兽人的本性，使他们成为燃烧军团的战争工具。\n    - 部落内部权力斗争结束，古尔丹的统治地位确立，但部落也失去了萨满教文化的指引，陷入疯狂和混乱。\n\n### **7. 第一次大战的爆发（距今约 13 年前）**\n\n- **事件:**\n    - 在基尔加丹的指挥下，古尔丹带领部落穿过黑暗之门，入侵艾泽拉斯。\n    - 人类、矮人、精灵等种族组成联盟，共同抵抗部落的入侵。\n    - 第一次大战爆发，战争持续了数年，双方都付出了惨重的代价。\n    - 部落最终占领了暴风城，但自身也损失惨重。\n- **影响:**\n    - 第一次大战标志着兽人入侵艾泽拉斯的开始，也开启了艾泽拉斯历史上一个充满动荡和战乱的时期。\n    - 部落和联盟之间的仇恨加深，为后续的战争埋下伏笔。\n\n## 总结\n\n《部落的崛起》讲述了兽人氏族从独立走向联合，从和平走向战争，最终被恶魔操控并入侵艾泽拉斯的过程。这个时间线展示了兽人社会的变迁，以及恶魔对兽人命运的操控，为后续的《魔兽争霸》系列游戏和《魔兽世界》奠定了基础。\n"
psg2 = "第二章  初始计量\n　　第五条  企业合并形成的长期股权投资，应当按照下列规定确定其初始投资成本：\n　　（一）同一控制下的企业合并，合并方以支付现金、转让非现金资产或承担债务方式作为合并对价的，应当在合并日按照被合并方所有者权益在最终控制方合并财务报表中的账面价值的份额作为长期股权投资的初始投资成本。长期股权投资初始投资成本与支付的现金、转让的非现金资产以及所承担债务账面价值之间的差额，应当调整资本公积；资本公积不足冲减的，调整留存收益。\n　　合并方以发行权益性证券作为合并对价的，应当在合并日按照被合并方所有者权益在最终控制方合并财务报表中的账面价值的份额作为长期股权投资的初始投资成本。按照发行股份的面值总额作为股本，长期股权投资初始投资成本与所发行股份面值总额之间的差额，应当调整资本公积；资本公积不足冲减的，调整留存收益。\n　　（二）非同一控制下的企业合并，购买方在购买日应当按照《企业会计准则第20号——企业合并》的有关规定确定的合并成本作为长期股权投资的初始投资成本。\n    合并方或购买方为企业合并发生的审计、法律服务、评估咨询等中介费用以及其他相关管理费用，应当于发生时计入当期损益。\n　　第六条  除企业合并形成的长期股权投资以外，其他方式取得的长期股权投资，应当按照下列规定确定其初始投资成本：\n　　（一）以支付现金取得的长期股权投资，应当按照实际支付的购买价款作为初始投资成本。初始投资成本包括与取得长期股权投资直接相关的费用、税金及其他必要支出。\n（二）以发行权益性证券取得的长期股权投资，应当按照发行权益性证券的公允价值作为初始投资成本。与发行权益性证券直接相关的费用，应当按照《企业会计准则第37号——金融工具列报》的有关规定确定。\n　　（三）通过非货币性资产交换取得的长期股权投资，其初始投资成本应当按照《企业会计准则第7号——非货币性资产交换》的有关规定确定。\n　　（四）通过债务重组取得的长期股权投资，其初始投资成本应当按照《企业会计准则第12号——债务重组》的有关规定确定。\n　第三章  后续计量\n第七条  投资方能够对被投资单位实施控制的长期股权投资应当采用成本法核算。\n　　第八条  采用成本法核算的长期股权投资应当按照初始投资成本计价。追加或收回投资应当调整长期股权投资的成本。被投资单位宣告分派的现金股利或利润，应当确认为当期投资收益。\n第九条  投资方对联营企业和合营企业的长期股权投资，应当按照本准则第十条至第十三条规定，采用权益法核算。\n投资方对联营企业的权益性投资，其中一部分通过风险投资机构、共同基金、信托公司或包括投连险基金在内的类似主体间接持有的，无论以上主体是否对这部分投资具有重大影响，投资方都可以按照《企业会计准则第22号——金融工具确认和计量》的有关规定，对间接持有的该部分投资选择以公允价值计量且其变动计入损益，并对其余部分采用权益法核算。\n第十条  长期股权投资的初始投资成本大于投资时应享有被投资单位可辨认净资产公允价值份额的，不调整长期股权投资的初始投资成本；长期股权投资的初始投资成本小于投资时应享有被投资单位可辨认净资产公允价值份额的，其差额应当计入当期损益，同时调整长期股权投资的成本。\n被投资单位可辨认净资产的公允价值，应当比照《企业会计准则第20号——企业合并》的有关规定确定。\n第十一条  投资方取得长期股权投资后，应当按照应享有或应分担的被投资单位实现的净损益和其他综合收益的份额，分别确认投资收益和其他综合收益，同时调整长期股权投资的账面价值；投资方按照被投资单位宣告分派的利润或现金股利计算应享有的部分，相应减少长期股权投资的账面价值；投资方对于被投资单位除净损益、其他综合收益和利润分配以外所有者权益的其他变动，应当调整长期股权投资的账面价值并计入所有者权益。\n投资方在确认应享有被投资单位净损益的份额时，应当以取得投资时被投资单位可辨认净资产的公允价值为基础，对被投资单位的净利润进行调整后确认。\n被投资单位采用的会计政策及会计期间与投资方不一致的，应当按照投资方的会计政策及会计期间对被投资单位的财务报表进行调整，并据以确认投资收益和其他综合收益等。\n第十二条  投资方确认被投资单位发生的净亏损，应当以长期股权投资的账面价值以及其他实质上构成对被投资单位净投资的长期权益减记至零为限，投资方负有承担额外损失义务的除外。\n被投资单位以后实现净利润的，投资方在其收益分享额弥补未确认的亏损分担额后，恢复确认收益分享额。\n第十三条  投资方计算确认应享有或应分担被投资单位的净损益时，与联营企业、合营企业之间发生的未实现内部交易损益按照应享有的比例计算归属于投资方的部分，应当予以抵销，在此基础上确认投资收益。\n投资方与被投资单位发生的未实现内部交易损失，按照《企业会计准则第8号——资产减值》等的有关规定属于资产减值损失的，应当全额确认。\n第十四条  投资方因追加投资等原因能够对被投资单位施加重大影响或实施共同控制但不构成控制的，应当按照《企业会计准则第22号——金融工具确认和计量》确定的原持有的股权投资的公允价值加上新增投资成本之和，作为改按权益法核算的初始投资成本。原持有的股权投资分类为可供出售金融资产的，其公允价值与账面价值之间的差额，以及原计入其他综合收益的累计公允价值变动应当转入改按权益法核算的当期损益。 \n投资方因追加投资等原因能够对非同一控制下的被投资单位实施控制的，在编制个别财务报表时，应当按照原持有的股权投资账面价值加上新增投资成本之和，作为改按成本法核算的初始投资成本。购买日之前持有的股权投资因采用权益法核算而确认的其他综合收益，应当在处置该项投资时采用与被投资单位直接处置相关资产或负债相同的基础进行会计处理。购买日之前持有的股权投资按照《企业会计准则第22号——金融工具确认和计量》的有关规定进行会计处理的，原计入其他综合收益的累计公允价值变动应当在改按成本法核算时转入当期损益。在编制合并财务报表时，应当按照《企业会计准则第33号——合并财务报表》的有关规定进行会计处理。\n第十五条  投资方因处置部分股权投资等原因丧失了对被投资单位的共同控制或重大影响的，处置后的剩余股权应当改按《企业会计准则第22号——金融工具确认和计量》核算，其在丧失共同控制或重大影响之日的公允价值与账面价值之间的差额计入当期损益。原股权投资因采用权益法核算而确认的其他综合收益，应当在终止采用权益法核算时采用与被投资单位直接处置相关资产或负债相同的基础进行会计处理。\n投资方因处置部分权益性投资等原因丧失了对被投资单位的控制的，在编制个别财务报表时，处置后的剩余股权能够对被投资单位实施共同控制或施加重大影响的，应当改按权益法核算，并对该剩余股权视同自取得时即采用权益法核算进行调整；处置后的剩余股权不能对被投资单位实施共同控制或施加重大影响的，应当改按《企业会计准则第22号——金融工具确认和计量》的有关规定进行会计处理，其在丧失控制之日的公允价值与账面价值间的差额计入当期损益。在编制合并财务报表时，应当按照《企业会计准则第33号——合并财务报表》的有关规定进行会计处理。\n第十六条  对联营企业或合营企业的权益性投资全部或部分分类为持有待售资产的，投资方应当按照《企业会计准则第4号——固定资产》的有关规定处理，对于未划分为持有待售资产的剩余权益性投资，应当采用权益法进行会计处理。\n已划分为持有待售的对联营企业或合营企业的权益性投资，不再符合持有待售资产分类条件的，应当从被分类为持有待售资产之日起采用权益法进行追溯调整。分类为持有待售期间的财务报表应当作相应调整。\n　　第十七条  处置长期股权投资，其账面价值与实际取得价款之间的差额，应当计入当期损益。采用权益法核算的长期股权投资，在处置该项投资时，采用与被投资单位直接处置相关资产或负债相同的基础，按相应比例对原计入其他综合收益的部分进行会计处理。  \n第十八条  投资方应当关注长期股权投资的账面价值是否大于享有被投资单位所有者权益账面价值的份额等类似情况。出现类似情况时，投资方应当按照《企业会计准则第8号——资产减值》对长期股权投资进行减值测试，可收回金额低于长期股权投资账面价值的，应当计提减值准备。\n　第四章  衔接规定\n第十九条  在本准则施行日之前已经执行企业会计准则的企业，应当按照本准则进行追溯调整，追溯调整不切实可行的除外。\n第五章  附  则\n第二十条  本准则自2014年7月1日起施行。\n企业会计准则第3号——投资性房地产（2006）\n财会[2006]3号\n第一章 总则\n　　第一条 为了规范投资性房地产的确认、计量和相关信息的披露，根据《企业会计准则——基本准则》，制定本准则。\n　　第二条 投资性房地产，是指为赚取租金或资本增值，或两者兼有而持有的房地产。\n　　投资性房地产应当能够单独计量和出售。\n　　第三条 本准则规范下列投资性房地产：\n　　（一）已出租的土地使用权。\n　　（二）持有并准备增值后转让的土地使用权。\n　　（三）已出租的建筑物。\n　　第四条 下列各项不属于投资性房地产：\n　　（一）自用房地产，即为生产商品、提供劳务或者经营管理而持有的房地产。\n　　（二）作为存货的房地产。\n　　第五条 下列各项适用其他相关会计准则：\n　　（一）企业代建的房地产，适用《企业会计准则第15号——建造合同》。\n　　（二）投资性房地产的租金收入和售后租回，适用《企业会计准则第21号——租赁》。\n　　第二章 确认和初始计量\n　　第六条 投资性房地产同时满足下列条件的，才能予以确认：\n　　（一）与该投资性房地产有关的经济利益很可能流入企业；\n　　（二）该投资性房地产的成本能够可靠地计量。\n　　第七条 投资性房地产应当按照成本进行初始计量。\n　　（一）外购投资性房地产的成本，包括购买价款、相关税费和可直接归属于该资产的其他支出。\n　　（二）自行建造投资性房地产的成本，由建造该项资产达到预定可使用状态前所发生的必要支出构成。\n　　（三）以其他方式取得的投资性房地产的成本，按照相关会计准则的规定确定。\n　　第八条 与投资性房地产有关的后续支出，满足本准则第六条规定的确认条件的，应当计入投资性房地产成本；不满足本准则第六条规定的确认条件的，应当在发生时计入当期损益。\n第三章 后续计量\n　　第九条 企业应当在资产负债表日采用成本模式对投资性房地产进行后续计量，但本准则第十条规定的除外。\n　　采用成本模式计量的建筑物的后续计量，适用《企业会计准则第4号——固定资产》。\n　　采用成本模式计量的土地使用权的后续计量，适用《企业会计准则第6号——无形资产》。\n　　第十条 有确凿证据表明投资性房地产的公允价值能够持续可靠取得的，可以对投资性房地产采用公允价值模式进行后续计量。采用公允价值模式计量的，应当同时满足下列条件：\n　　（一）投资性房地产所在地有活跃的房地产交易市场；\n　　（二）企业能够从房地产交易市场上取得同类或类似房地产的市场价格及其他相关信息，从而对投资性房地产的公允价值作出合理的估计。\n　　第十一条 采用公允价值模式计量的，不对投资性房地产计提折旧或进行摊销，应当以资产负债表日投资性房地产的公允价值为基础调整其账面价值，公允价值与原账面价值之间的差额计入当期损益。\n　　第十二条 企业对投资性房地产的计量模式一经确定，不得随意变更。成本模式转为公允价值模式的，应当作为会计政策变更，按照《企业会计准则第28号——会计政策、会计估计变更和差错更正》处理。\n　　已采用公允价值模式计量的投资性房地产，不得从公允价值模式转为成本模式。\n第四章 转换\n　　第十三条企业有确凿证据表明房地产用途发生改变，满足下列条件之一的，应当将投资性房地产转换为其他资产或者将其他资产转换为投资性房地产：\n　　（一）投资性房地产开始自用。\n　　（二）作为存货的房地产，改为出租。\n　　（三）自用土地使用权停止自用，用于赚取租金或资本增值。\n　　（四）自用建筑物停止自用，改为出租。\n　　第十四条在成本模式下，应当将房地产转换前的账面价值作为转换后的入账价值。\n　　第十五条 采用公允价值模式计量的投资性房地产转换为自用房地产时，应当以其转换当日的公允价值作为自用房地产的账面价值，公允价值与原账面价值的差额计入当期损益。\n　　第十六条 自用房地产或存货转换为采用公允价值模式计量的投资性房地产时，投资性房地产按照转换当日的公允价值计价，转换当日的公允价值小于原账面价值的，其差额计入当期损益；转换当日的公允价值大于原账面价值的，其差额计入所有者权益。\n第五章 处置\n　　第十七条 当投资性房地产被处置，或者永久退出使用且预计不能从其处置中取得经济利益时，应当终止确认该项投资性房地产。\n　　第十八条 企业出售、转让、报废投资性房地产或者发生投资性房地产毁损，应当将处置收入扣除其账面价值和相关税费后的金额计入当期损益。\n第六章 披露\n　　第十九条 企业应当在附注中披露与投资性房地产有关的下列信息：\n　　（一）投资性房地产的种类、金额和计量模式。\n　　（二）采用成本模式的，投资性房地产的折旧或摊销，以及减值准备的计提情况。\n　　（三）采用公允价值模式的，公允价值的确定依据和方法，以及公允价值变动对损益的影响。\n　　（四）房地产转换情况、理由，以及对损益或所有者权益的影响。\n　　（五）当期处置的投资性房地产及其对损益的影响。\n"
article_id = 2
article_title = "魔兽时间线"

max_chunk_length = 1000
max_node_length = 900
nodes = []
# 使用时打开
# nodes = asyncio.run(jina.split_text_with_jina(psg1, max_chunk_length))
print(nodes)
print(f"JINA分割初步切分成 {len(nodes)} 个chunk")
print("---------------------------")
# 合并短句，确保语义完整性
big_chunks = []
current_text = []
current_length = 0
small_big_dict = {} # node_id: big_chunk_id
big_chunk_id = 0
for i, node in enumerate(nodes):
    # 如果当前句子很短，尝试与下一句合并
    node_length = len(node)
    if node_length < max_node_length and current_length + node_length < max_chunk_length:
        current_text.append(node)
        current_length += node_length
        small_big_dict.update({i: big_chunk_id}) # NEW
    else:
        # 如果积累了一些短句，将它们合并
        if current_text:
            merged_text = " ".join(current_text)
            big_chunks.append(merged_text)
            current_text = []
            current_length = 0
            big_chunk_id += 1  # NEW
        # 将当前句子作为独立的块
        # big_chunks.append(node)
        current_text.append(node) # NEW
        current_length = node_length # NEW
        small_big_dict.update({i: big_chunk_id}) # NEW
# 处理剩余的短句
if current_text:
    merged_text = " ".join(current_text)
    big_chunks.append(merged_text)
print(f"本地分割最终切分成 {len(big_chunks)} 个chunk")

from redis.redis_service import RedisService
redis_client = RedisService()

# 1 将子句保存到向量库
import embeddings.voyager as voyager
filter='metadata["article_title"] == "魔兽时间线"'
# 以下使用时打开
# doc_embeddings = voyager.get_doc_embeddings(nodes)
# vc_nodes = []
# for i, node in enumerate(nodes):
#     chunk_id = small_big_dict.get(i)
#     vc_nodes.append({
#         "metadata": {"article_id": article_id, "article_title": article_title, "chunk_id": f"article_{article_id}_chunk_{chunk_id}"},
#         "pk": i,
#         "content": node,
#         "embedding": doc_embeddings[i] # 1024
#     })
# 需要清理数据时打开
# client.delete( # https://docs.zilliz.com.cn/docs/delete-entities
#     collection_name="my_json_collection",
#     filter=filter
# )
# client.upsert(
#     collection_name="my_json_collection",
#     data=vc_nodes
# )

# 2 将父文档缓存 save big chunk to redis {article_chunks: {article_1_chunk_19: "..."}}
# for i, big_chunk in enumerate(big_chunks):
#     chunk_id = f"article_{article_id}_chunk_{i}"
#     redis_client.set_hash(f"article_chunks", {chunk_id: big_chunk})
print(" ---------------- ")

# Search
query = "没有灵魂的 AI"
children = client.search(
    collection_name="news_reader_articles", # 可变
    data=[voyager.get_query_embedding(query)],
    limit=20, # 可变
    search_params={"params": {"nprobe": 10}},
    output_fields=["text", "metadata"], # 可变
    filter='metadata["article_title"] like "%灵魂的%"'  # 可变
)
children = children[0]
print(len(children))
chunk_ids = []
for i, node in enumerate(children):
    chunk_id = node.get("entity").get("metadata").get("chunk_id")
    if chunk_id not in chunk_ids: # 多个小段可能都是同一个大段里的，因此去重
        chunk_ids.append(chunk_id)
chunks = []
for chunk_id in chunk_ids:
    chunk = redis_client.get_hash_value(f"article_chunks", chunk_id)
    chunks.append(chunk)
chunks = [chunk for chunk in chunks if chunk is not None]
print(chunks)

# 需要清理数据时打开
# client.delete( # https://docs.zilliz.com.cn/docs/delete-entities
#     collection_name="news_reader_articles",
#     filter='metadata["article_id"] = 999'
# )

# Evaluate
# from rag.eval.ragas_rag_eval_demo import RAG
# rag = RAG()
# evaluation_dataset = rag.get_evaluation_dataset(real_queries, real_answers, chunks, references)
# rag.eval(evaluation_dataset)

# 本DEMO已接入到系统中，
# 相关模块(有微调）：
# text_input_handler.split_text
# rag_service.add_articles_to_vector_store
# article_routes.batch_vector_store