# Chat 设计文档

## 产品逻辑
1 基本聊天
   和大多数LLM产品一样，我们页面中部的区域是用来进行聊天的
   我们支持发送文字，文件，多媒体作为聊天的输入/提问question/内容content
   用户聊天的内容会立即被发送到聊天区，然后等待LLM的聊天回答，如果输入带有文件、图片等附件，聊天区会展示附件
2 多轮对话
   支持多轮对话的能力通过llamaindex提供
3 对文章聊天
   支持多选左侧文章区的文章，能力通过rag提供
   场景四象限：
   1. 用户选中文章 提的问题和文章有关 比如：“这两篇文章有什么关联”
   2. 用户选中文章 用户提的问题和文章无关 比如：“今天天气如何”
   3. 用户未选文章 提的问题和文章有关 比如：“谁在哪篇文章里提出AI还不如猫？”（RAG）
   4. 用户未选文章 用户提的问题和文章无关 比如：“今天天气如何?”
4 聊天和对话的概念区分
   聊天，chat，是指用户和LLM之间的每一次对话，用户/LLM发送的每一段话，就是一次聊天
   对话，conversation，是指用户和LLM之间的多次聊天，也称会话
   页面交互设计：
      打开新页面，第一次进入系统，聊天界面空白
      用户发送消息，聊天界面出现消息，同时自动生成一个对话
      每次聊天后，自动保存对话，并使该对话在对话列表中置顶
      用户可以点击新建对话按钮，创建一个新的对话，页面回到空白
      用户可以点击历史对话按钮，页面渲染历史对话
5 对话管理
   增删改查
6 聊天笔记
   用户可以将聊天记录生成一份凝练的笔记，以回顾今天聊了什么

## 路由设计
- 页面路由: `/chat`
- API 路由: 
  - `/api/chat/send` - 发送消息
  - `/api/chat/history` - 获取聊天历史
  - `/api/articles/search` - 搜索文章（用于左侧列表）
  - `/api/articles/<article_id>` - 获取文章详情

## 页面布局
三栏布局设计：
1. 左侧文章列表 (300px)
   - [x] 基础列表显示（仅标题）
   - [ ] 文章搜索功能
   - [X] 文章展开/折叠详情
   - [ ] 文章分页加载

2. 中间聊天区域 (自适应)
   - [x] 消息显示区域
   - [x] 消息输入框
   - [x] 发送按钮
   - [ ] 消息历史记录
   - [ ] 消息状态显示
   - [ ] 工具栏功能实现：
     - [ ] 文件上传
     - [ ] 语音输入
     - [ ] 图片上传

3. 右侧笔记区域 (300px)
   - [ ] 笔记编辑器
   - [ ] 笔记保存功能
   - [ ] 笔记分类
   - [ ] 笔记搜索

## 功能清单

### 第一阶段（基础功能）
1. [x] 添加基础路由 `/chat`
2. [x] 实现文章列表获取和显示
3. [ ] 实现基础聊天功能
4. [ ] 添加消息历史记录
5. [ ] 实现文章搜索
6. [x] 实现获取文章详情的 API 路由 `/api/articles/<article_id>`

### 第二阶段（增强功能）
1. [x] 实现文章详情展开/折叠
2. [ ] 添加文章分页
3. [ ] 实现笔记功能
4. [ ] 添加文件上传
5. [ ] 添加语音输入

### 第三阶段（高级功能）
1. [ ] 实现多轮对话
2. [ ] 添加上下文管理
3. [ ] 实现会话保存
4. [ ] 添加导出功能
5. [ ] 实现协同编辑

## 技术栈
- 前端：HTML, CSS, JavaScript, Bootstrap
- 后端：Python, Flask
- 数据库：SQLite
- AI：Gemini API

## 开发顺序
1. 基础路由设置
2. 文章列表功能
3. 基础聊天功能
4. 消息历史
5. 笔记功能

## 技术特点：
多路LLM路由 并行化
https://docs.llamaindex.ai/en/stable/module_guides/deploying/query_engine/response_modes/
https://mp.weixin.qq.com/s/VkDGOpNtmM1gX_3O7CJBSg
https://mp.weixin.qq.com/s/nKHyBJ6e5HPWbIsq8-B0Mw

## DEBUG
1. 部分文档中文问题 “UnicodeEncodeError: 'gbk' codec can't encode character '\xa0' in position 183: illegal multibyte sequence”
2. 窗口大小（部分模型长篇回复导致变宽）
3. 参考来源:重复2次显示
