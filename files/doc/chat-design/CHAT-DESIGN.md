# Chats 对话聊天 设计文档

## 产品设计
1 基本聊天
   和大多数LLM产品一样，我们页面中部的区域是用来进行聊天的
   我们支持发送文字，文件，多媒体作为聊天的输入/提问question/内容content
   用户聊天的内容会立即被发送到聊天区，然后等待LLM的聊天回答，如果输入带有文件、图片等附件，聊天区会展示附件
2 多轮对话
   支持多轮对话的能力通过llamaindex提供
3 对文章聊天
   支持多选左侧文章区的文章，能力通过rag提供
   场景四象限：
   1. 用户选中文章 提的问题和文章有关 比如：“这两篇文章有什么关联”
   2. 用户选中文章 用户提的问题和文章无关 比如：“今天天气如何”
   3. 用户未选文章 提的问题和文章有关 比如：“谁在哪篇文章里提出AI还不如猫？”（RAG）
   4. 用户未选文章 用户提的问题和文章无关 比如：“今天天气如何?”
4 聊天和对话的概念区分
   聊天，chat，是指用户和LLM之间的每一次对话，用户/LLM发送的每一段话，就是一次聊天
   对话，conversation，是指用户和LLM之间的多次聊天，也称会话
   页面交互设计：
      打开新页面，第一次进入系统，聊天界面空白
      用户发送消息，聊天界面出现消息，同时自动生成一个对话
      每次聊天后，自动保存对话，并使该对话在对话列表中置顶
      用户可以点击新建对话按钮，创建一个新的对话，页面回到空白
      用户可以点击历史对话按钮，页面渲染历史对话
5 对话管理
   增删改查
6 聊天笔记
   用户可以将聊天记录生成一份凝练的笔记，以回顾今天聊了什么

## 功能清单

### 第一阶段（基础功能）
1. [x] 添加基础路由 `/chat`
2. [x] 实现文章列表获取和显示
3. [ ] 实现基础聊天功能
4. [ ] 添加消息历史记录
5. [ ] 实现文章搜索
6. [x] 实现获取文章详情的 API 路由 `/api/articles/<article_id>`

### 第二阶段（增强功能）
1. [x] 实现文章详情展开/折叠
2. [ ] 添加文章分页
3. [ ] 实现笔记功能
4. [ ] 添加文件上传
5. [ ] 添加语音输入

### 第三阶段（高级功能）
1. [ ] 实现多轮对话
2. [ ] 添加上下文管理
3. [ ] 实现会话保存
4. [ ] 添加导出功能
5. [ ] 实现协同编辑

## 路由设计
- 页面路由: `/chat`
chat接口
├── 参数接收
│   ├── conversation_id（必需）
│   ├── question（用户问题）
│   ├── model（可选，默认GEMINI_MODEL）
│   ├── article_ids（可选，勾选的文章）
│   ├── files（可选，上传的文件）
│   ├── keep_urls（可选，默认5）
│   ├── rag_func（可选，默认0）
│   └── recall_num（可选，默认20）
│
├── 上下文增强（_chat_context）
│   ├── 1. URL解析（独立try-catch）
│   ├── 2. 文件处理（独立try-catch）
│   │   ├── 读取文件内容
│   │   ├── 异步保存文件
│   │   └── 合并文件内容
│   ├── 3. 勾选文章（独立try-catch）
│   │   └── 优先使用content，没有则用summary
│   └── 4. 向量RAG（独立try-catch）
│       ├── 搜索相关文档
│       └── 重排序筛选
│
└── 对话处理
    └── 统一使用chat_with_context处理

- API 路由: 
  - `/api/chat/send` - 发送消息
  - `/api/chat/history` - 获取聊天历史
  - `/api/articles/search` - 搜索文章（用于左侧列表）
  - `/api/articles/<article_id>` - 获取文章详情


## 页面布局
三栏布局设计：
1. 左侧文章列表 (300px)
   - [x] 基础列表显示（仅标题）
   - [ ] 文章搜索功能
   - [X] 文章展开/折叠详情
   - [ ] 文章分页加载

2. 中间聊天区域 (自适应)
   - [x] 消息显示区域
   - [x] 消息输入框
   - [x] 发送按钮
   - [ ] 消息历史记录
   - [ ] 消息状态显示
   - [ ] 工具栏功能实现：
     - [ ] 文件上传
     - [ ] 语音输入
     - [ ] 图片上传

3. 右侧笔记区域 (300px)
   - [ ] 笔记编辑器
   - [ ] 笔记保存功能
   - [ ] 笔记分类
   - [ ] 笔记搜索

## 技术栈
- 前端：HTML, CSS, JavaScript, Bootstrap
- 后端：Python, Flask
- 数据库：SQLite, Redis
- AI：Gemini API
### 存储设计
   本地（SQLite）仅存储了对话的user_id和conversation_id和标题
   Redis 存储了对话的消息历史，但没有保存对话标题。类型是List（redis list），key是由对话的user_id和conversation_id组成，类似user1_conv0046771b 这样的格式
### 搜索设计
1. 搜索范围
   - 数据库：搜索对话标题
   - Redis：搜索对话内容（消息历史)

2. 搜索流程
   - 从Redis中搜索对话内容，获取匹配的conversation_ids列表
   - 使用conversation_ids和搜索关键词在数据库中查询对话信息
   - 数据库查询会同时匹配标题和指定的conversation_ids
   - 结果按更新时间倒序排列

3. 性能考虑
   - Redis搜索采用模式匹配获取用户所有对话keys
   - 对话内容匹配采用提前退出策略，找到匹配即停止搜索该对话
   - Redis搜索失败时会返回空列表，确保至少能返回标题匹配结果

4. 错误处理
   - Redis搜索异常不会影响整体搜索结果
   - 搜索结果为空时返回空列表而不是错误
   - 所有异常都会被记录到日志中

5. 后期优化TODO
   - 1 限制搜索条数
   - 2 增加搜索记录缓存

## 开发顺序
1. 基础路由设置
2. 文章列表功能
3. 基础聊天功能
4. 消息历史
5. 笔记功能

## 技术特点：
多路LLM路由 并行化
https://docs.llamaindex.ai/en/stable/module_guides/deploying/query_engine/response_modes/
https://mp.weixin.qq.com/s/VkDGOpNtmM1gX_3O7CJBSg
https://mp.weixin.qq.com/s/nKHyBJ6e5HPWbIsq8-B0Mw

## DEBUG
1. 部分文档中文问题 “UnicodeEncodeError: 'gbk' codec can't encode character '\xa0' in position 183: illegal multibyte sequence”
2. 窗口大小（部分模型长篇回复导致变宽）
3. 参考来源:重复2次显示
