# Chats 对话聊天 设计文档

## BUG/TODO/待优化项
1. 部分文档中文问题 “UnicodeEncodeError: 'gbk' codec can't encode character '\xa0' in position 183: illegal multibyte sequence”
2. 窗口大小（部分模型长篇回复导致变宽）
3. 参考来源:重复2次显示

## 技术栈
- 前端：HTML, CSS, JavaScript, Bootstrap
- 后端：Python, Flask
- 数据库：SQLite, Redis
- AI：Gemini\OPENAI\DEEPSEEK\MINIMAX
    - 多路LLM路由并行化

## 1. 产品设计

### 1.1 基本概念
- **聊天(Chat)**: 用户和LLM之间的每一次对话，用户/LLM发送的每一段话就是一次聊天
- **对话(Conversation)**: 用户和LLM之间的多次聊天组成的会话

### 1.2 核心功能
1. **基本聊天**
   - 支持发送文字、文件、多媒体作为聊天输入
   - 用户内容立即显示在聊天区，等待LLM回答
   - 支持展示附件（文件、图片等）

2. **多轮对话**
   - 通过LlamaIndex提供多轮对话能力
   - 自动保存对话历史
   - 支持对话管理（增删改查）

3. **选择文章**
   场景四象限：
   - 选中文章 + 文章相关问题（如："这两篇文章有什么关联"）
   - 选中文章 + 文章无关问题（如："今天天气如何"）
   - 未选文章 + 文章相关问题（如："谁在哪篇文章里提出AI还不如猫？"）(RAG)
   - 未选文章 + 文章无关问题（如："今天天气如何?"）

4. **聊天笔记**
   - 支持将聊天记录生成凝练的笔记
   - Notion联通

### 1.3 页面交互（用户体验）
1. **左侧文章列表 (300px)**
   - 基础列表显示（标题）
   - 文章搜索功能
   - 文章展开/折叠详情
   - 文章分页加载

2. **中间聊天区域 (自适应)**
   - 新页面首次进入：聊天界面空白
   - 发送消息：显示消息并自动生成对话
   - 对话保存：每次聊天后自动保存，并在列表中置顶
   - 新建对话：点击按钮创建，页面回到空白
   - 历史对话：点击对话列表查看历史对话记录

   - 消息显示区域
   - 消息输入框
   - 发送按钮
   - 消息历史记录
   - 消息状态显示
   - 工具栏功能：
     - 文件上传
     - 语音输入
     - 图片上传

3. **右侧笔记区域 (300px)**
   - 笔记编辑器
   - 笔记保存功能
   - 笔记分类
   - 笔记搜索

## 2. 技术设计

### 2.1 路由设计
1. **页面路由**: `/chat`
2. **API路由**: 
   - `/api/chat/send` - 发送消息
   - `/api/chat/history` - 获取聊天历史
   - `/api/articles/search` - 搜索文章
   - `/api/articles/<article_id>` - 获取文章详情
``` chat接口
├── 参数接收
│   ├── conversation_id（必需）
│   ├── question（用户问题）
│   ├── model（可选，默认GEMINI_MODEL）
│   ├── article_ids（可选，勾选的文章）
│   ├── files（可选，上传的文件）
│   ├── keep_urls（可选，默认5）
│   ├── rag_func（可选，默认0）
│   └── recall_num（可选，默认20）
│
├── 上下文增强（_chat_context）
│   ├── 1. URL解析
│   ├── 2. 文件处理
│   │   ├── 读取文件内容
│   │   ├── 异步保存文件
│   │   └── 合并文件内容
│   ├── 3. 勾选文章
│   │   └── 优先使用content，没有则用summary
│   └── 4. 向量RAG
│       ├── 搜索相关文档
│       └── 重排序筛选
│
└── 对话处理
    └── 统一使用chat_with_context处理
```

### 2.2 Chat设计
1. **对话管理**
   - 2.1. 使用LlamaIndex管理对话
   - 2.2. 使用原生LLM管理对话

2. **上下文管理**
   - 2.1. 输入类型支持
        1.1.1. 用户提问的文字内容（含URL链接（过滤媒体））
        1.1.2. 文件上传
        - 文本文件（支持的扩展名在 FileInputHandler 中定义）
        - 媒体文件（图片、视频、音频等）
        1.1.3. 用户选择的已有文章（通过article_ids参数）
        1.1.4. 自动处理机制：
            上传的文件（开启）
                自动存储文本类型（txt\pdf等）并转为文章
            RAG（关闭）
                不自动索引
                手动位置：文章页、聊天页
   - 2.2. 输入处理方式
        1.2.1 文字内容处理
            - 基础文本内容直接作为question参数传递给LLM
            - 支持通过rag_func参数开启向量检索增强，当rag_func=1时，会：
            1. 使用Milvus向量库检索相关文档
            2. 从Redis获取完整的文档内容
            3. 使用voyager进行文档重排序
            4. 将相关文档作为上下文附加到问题中
            - 嵌入RAG索引的页面位置：
            1. 文章页（嵌入按钮）
            2. 聊天页-文章详情（加知识库）
            - URL处理：
            1. 使用jina.read_from_jina提取和处理URL内容（通过keep_urls参数控制 默认保留5条）
            2. 支持异步保存URL内容为文章（在chat主方法中 目前已注释未启用）
            3. 保存的URL数量通过KEEP_URLS_DEFAULT控制
        1.2.2 文件处理
            1. 文本文件处理：
            - 支持的文本文件类型在FileInputHandler.SUPPORTED_TEXT_FILES中定义
            - 直接读取文本内容
            - 异步保存为文章（自动）
            2. 媒体文件处理：
            - 使用GeminiClient处理非文本文件
                - 支持图片、视频、音频等媒体文件
                - 通过Gemini模型解析和提取媒体文件的主要内容
            - 临时文件处理：
                * 上传的文件先保存为临时文件
                * 处理完成后自动清理临时文件
            - 将Gemini的答案作为上下文再次给到LLamaIndex的LLM Engine
        1.2.3 已有文章处理
            - 通过article_ids参数选择已保存的文章
            - 从数据库获取文章内容
            - 将文章内容（标题+正文/摘要）添加到上下文中
   - 2.3. 上下文组织
        系统将所有处理后的内容按以下顺序组织：
        1. 用户上传的文件内容（Section I）
        2. 用户选择的文章内容（Section II）
        3. 向量检索得到的相关资料（Section III）
        4. 本次对话的聊天记录（Section IV）(由LLamaIndex管理)

### 2.3 存储设计
1. **本地存储(SQLite)**
   - 存储对话的user_id、conversation_id和标题

2. **Redis存储**
   - 存储对话消息历史
   - 类型：List
   - key格式：user[user_id]_conv[conversation_id]

3. **管理策略：**
   - 数据保留策略 (Data Retention Policy)： 定义历史数据的保留时间。考虑法律法规、隐私政策和存储成本。可以设置不同的保留时间，例如，短期用于上下文理解，长期用于分析和改进。
   - 数据清理策略 (Data Cleaning Policy)： 定期清理不再需要的或过时的历史数据。
   - 数据备份和恢复策略 (Backup and Recovery Policy)： 定期备份历史数据，以防止数据丢失。
   - 数据安全和隐私策略 (Security and Privacy Policy)：
        数据加密： 对存储的历史数据进行加密，保护用户隐私。
        访问控制： 限制对历史数据的访问权限。
        匿名化和脱敏： 在用于分析和改进时，对敏感信息进行匿名化或脱敏处理。
        用户数据删除请求： 提供用户删除其历史数据的机制，并符合相关法规。

### 2.4 搜索设计
1. **搜索范围**
   - 数据库：对话标题
   - Redis：对话内容

2. **搜索流程**
   - Redis搜索对话内容获取conversation_ids
   - 数据库查询对话信息
   - 结果按更新时间倒序

3. **性能优化**
   - 模式匹配获取用户对话keys
   - 提前退出策略
   - 异常处理和日志记录

4. **待优化项**
   - 限制搜索条数
   - 增加搜索记录缓存

5. **检索策略**
   - 基于对话 ID 的检索： 根据 `Conversation ID` 检索整个对话历史。
   - 基于消息 ID 的检索： 根据 `Message ID` 检索特定的消息。
   - 基于用户 ID 的检索： 检索特定用户的所有对话历史或最近的对话。
   - 基于时间范围的检索： 检索特定时间段内的对话或消息。
   - 语义检索 (Semantic Retrieval)： 使用自然语言处理技术，根据语义相似性检索相关的对话或消息。例如，使用文本嵌入 (Text Embeddings) 技术。
   - 关键字检索： 根据关键词检索相关的对话或消息。
   - 上下文窗口 (Context Window)： 在处理当前用户输入时，通常会检索最近的 N 条消息作为上下文。N 的大小需要根据模型的输入限制和性能进行权衡。
   - 重要性排序 (Importance Scoring)： 对历史消息进行重要性评分，优先检索更重要的消息，例如，包含关键信息的助手回复。

## 3. 开发进度

### 3.1 已完成
[x] 添加基础路由 `/chat`
[x] 实现文章列表获取和显示
[ ] 实现基础聊天功能
[ ] 添加消息历史记录
[ ] 实现文章搜索
[x] 实现获取文章详情API `/api/articles/<article_id>`

### 3.2 进行中
[x] 实现文章详情展开/折叠
[ ] 添加文章分页
[ ] 实现笔记功能
[ ] 添加文件上传
[ ] 添加语音输入

### 3.3 计划中
[ ] 实现多轮对话
[ ] 添加上下文管理
[ ] 实现会话保存
[ ] 添加导出功能
[ ] 实现协同编辑

## 参考资料：
  - https://docs.llamaindex.ai/en/stable/module_guides/deploying/query_engine/response_modes/
  - https://mp.weixin.qq.com/s/VkDGOpNtmM1gX_3O7CJBSg
  - https://mp.weixin.qq.com/s/nKHyBJ6e5HPWbIsq8-B0Mw